{"id": "http://arxiv.org/abs/astro-ph/0501460v1", "guidislink": true, "updated": "2005-01-21T16:52:03Z", "updated_parsed": [2005, 1, 21, 16, 52, 3, 4, 21, 0], "published": "2005-01-21T16:52:03Z", "published_parsed": [2005, 1, 21, 16, 52, 3, 4, 21, 0], "title": "Peering through the OH-forest: a new technique to remove residual sky\n  features from SDSS spectra", "title_detail": {"type": "text/plain", "language": null, "base": "http://export.arxiv.org/api/query?search_query=&id_list=astro-ph%2F0501101%2Castro-ph%2F0501475%2Castro-ph%2F0501670%2Castro-ph%2F0501287%2Castro-ph%2F0501465%2Castro-ph%2F0501014%2Castro-ph%2F0501303%2Castro-ph%2F0501363%2Castro-ph%2F0501123%2Castro-ph%2F0501300%2Castro-ph%2F0501044%2Castro-ph%2F0501429%2Castro-ph%2F0501326%2Castro-ph%2F0501244%2Castro-ph%2F0501467%2Castro-ph%2F0501206%2Castro-ph%2F0501531%2Castro-ph%2F0501143%2Castro-ph%2F0501602%2Castro-ph%2F0501476%2Castro-ph%2F0501193%2Castro-ph%2F0501506%2Castro-ph%2F0501351%2Castro-ph%2F0501409%2Castro-ph%2F0501331%2Castro-ph%2F0501598%2Castro-ph%2F0501669%2Castro-ph%2F0501145%2Castro-ph%2F0501136%2Castro-ph%2F0501433%2Castro-ph%2F0501067%2Castro-ph%2F0501242%2Castro-ph%2F0501573%2Castro-ph%2F0501532%2Castro-ph%2F0501208%2Castro-ph%2F0501019%2Castro-ph%2F0501661%2Castro-ph%2F0501464%2Castro-ph%2F0501586%2Castro-ph%2F0501142%2Castro-ph%2F0501088%2Castro-ph%2F0501449%2Castro-ph%2F0501305%2Castro-ph%2F0501312%2Castro-ph%2F0501460%2Castro-ph%2F0501424%2Castro-ph%2F0501574%2Castro-ph%2F0501482%2Castro-ph%2F0501563%2Castro-ph%2F0501121%2Castro-ph%2F0501524%2Castro-ph%2F0501526%2Castro-ph%2F0501355%2Castro-ph%2F0501009%2Castro-ph%2F0501007%2Castro-ph%2F0501589%2Castro-ph%2F0501442%2Castro-ph%2F0501370%2Castro-ph%2F0501081%2Castro-ph%2F0501550%2Castro-ph%2F0501254%2Castro-ph%2F0501104%2Castro-ph%2F0501490%2Castro-ph%2F0501315%2Castro-ph%2F0501245%2Castro-ph%2F0501514%2Castro-ph%2F0501160%2Castro-ph%2F0501070%2Castro-ph%2F0501219%2Castro-ph%2F0501078%2Castro-ph%2F0501536%2Castro-ph%2F0501417%2Castro-ph%2F0501079%2Castro-ph%2F0501559%2Castro-ph%2F0501071%2Castro-ph%2F0501474%2Castro-ph%2F0501517%2Castro-ph%2F0501089%2Castro-ph%2F0501336%2Castro-ph%2F0501151%2Castro-ph%2F0501321%2Castro-ph%2F0501249%2Castro-ph%2F0501250%2Castro-ph%2F0501407%2Castro-ph%2F0501587%2Castro-ph%2F0501174%2Castro-ph%2F0501199%2Castro-ph%2F0501201%2Castro-ph%2F0501635%2Castro-ph%2F0501205%2Castro-ph%2F0501215%2Castro-ph%2F0501183%2Castro-ph%2F0501020%2Castro-ph%2F0501579%2Castro-ph%2F0501638%2Castro-ph%2F0501241%2Castro-ph%2F0501116%2Castro-ph%2F0501328%2Castro-ph%2F0501405%2Castro-ph%2F0501444%2Castro-ph%2F0501423&start=0&max_results=1000&sortBy=relevance&sortOrder=descending", "value": "Peering through the OH-forest: a new technique to remove residual sky\n  features from SDSS spectra"}, "summary": "The Sloan Digital Sky Survey (SDSS) currently provides by far the largest\nhomogeneous sample of intermediate signal-to-noise ratio (S/N) optical spectra\nof galaxies and quasars. The fully automated SDSS spectroscopic reduction\npipeline has provided spectra of unprecedented quality that cover the\nwavelength range 3800-9200A. However, in common with spectra from virtually all\nmulti-object surveys employing fibres, there remain significant systematic\nresiduals in many of the spectra due to the incomplete subtraction of the\nstrong OH sky emission lines longward of 6700A. The S/N over substantial\nwavelength regions in many spectra is reduced by more than a factor of 2 over\nthat expected from counting statistics. We present a method to automatically\nremove the sky residual signal, using a principal component analysis (PCA)\nwhich takes advantage of the correlation in the form of the sky subtraction\nresiduals present in each spectrum. Application of the method results in\nspectra with essentially no evidence for degradation due to the incomplete\nsubtraction of OH emission features. A dramatic improvement in the quality of a\nsubstantial number of spectra, particularly those of faint objects such as the\nbulk of the high-redshift quasars, is achieved. We make available IDL code and\ndocumentation to implement the sky residual subtraction scheme on SDSS spectra\nincluded in the public data releases. We illustrate the power of the\nsky-residual subtraction scheme using samples of SDSS galaxy and quasar\nspectra, presenting tests involving the near-infrared CaII triplet absorption,\nmetal absorption line features in damped Lyman-alpha systems and composite\nspectra of high-redshift quasars.", "summary_detail": {"type": "text/plain", "language": null, "base": "http://export.arxiv.org/api/query?search_query=&id_list=astro-ph%2F0501101%2Castro-ph%2F0501475%2Castro-ph%2F0501670%2Castro-ph%2F0501287%2Castro-ph%2F0501465%2Castro-ph%2F0501014%2Castro-ph%2F0501303%2Castro-ph%2F0501363%2Castro-ph%2F0501123%2Castro-ph%2F0501300%2Castro-ph%2F0501044%2Castro-ph%2F0501429%2Castro-ph%2F0501326%2Castro-ph%2F0501244%2Castro-ph%2F0501467%2Castro-ph%2F0501206%2Castro-ph%2F0501531%2Castro-ph%2F0501143%2Castro-ph%2F0501602%2Castro-ph%2F0501476%2Castro-ph%2F0501193%2Castro-ph%2F0501506%2Castro-ph%2F0501351%2Castro-ph%2F0501409%2Castro-ph%2F0501331%2Castro-ph%2F0501598%2Castro-ph%2F0501669%2Castro-ph%2F0501145%2Castro-ph%2F0501136%2Castro-ph%2F0501433%2Castro-ph%2F0501067%2Castro-ph%2F0501242%2Castro-ph%2F0501573%2Castro-ph%2F0501532%2Castro-ph%2F0501208%2Castro-ph%2F0501019%2Castro-ph%2F0501661%2Castro-ph%2F0501464%2Castro-ph%2F0501586%2Castro-ph%2F0501142%2Castro-ph%2F0501088%2Castro-ph%2F0501449%2Castro-ph%2F0501305%2Castro-ph%2F0501312%2Castro-ph%2F0501460%2Castro-ph%2F0501424%2Castro-ph%2F0501574%2Castro-ph%2F0501482%2Castro-ph%2F0501563%2Castro-ph%2F0501121%2Castro-ph%2F0501524%2Castro-ph%2F0501526%2Castro-ph%2F0501355%2Castro-ph%2F0501009%2Castro-ph%2F0501007%2Castro-ph%2F0501589%2Castro-ph%2F0501442%2Castro-ph%2F0501370%2Castro-ph%2F0501081%2Castro-ph%2F0501550%2Castro-ph%2F0501254%2Castro-ph%2F0501104%2Castro-ph%2F0501490%2Castro-ph%2F0501315%2Castro-ph%2F0501245%2Castro-ph%2F0501514%2Castro-ph%2F0501160%2Castro-ph%2F0501070%2Castro-ph%2F0501219%2Castro-ph%2F0501078%2Castro-ph%2F0501536%2Castro-ph%2F0501417%2Castro-ph%2F0501079%2Castro-ph%2F0501559%2Castro-ph%2F0501071%2Castro-ph%2F0501474%2Castro-ph%2F0501517%2Castro-ph%2F0501089%2Castro-ph%2F0501336%2Castro-ph%2F0501151%2Castro-ph%2F0501321%2Castro-ph%2F0501249%2Castro-ph%2F0501250%2Castro-ph%2F0501407%2Castro-ph%2F0501587%2Castro-ph%2F0501174%2Castro-ph%2F0501199%2Castro-ph%2F0501201%2Castro-ph%2F0501635%2Castro-ph%2F0501205%2Castro-ph%2F0501215%2Castro-ph%2F0501183%2Castro-ph%2F0501020%2Castro-ph%2F0501579%2Castro-ph%2F0501638%2Castro-ph%2F0501241%2Castro-ph%2F0501116%2Castro-ph%2F0501328%2Castro-ph%2F0501405%2Castro-ph%2F0501444%2Castro-ph%2F0501423&start=0&max_results=1000&sortBy=relevance&sortOrder=descending", "value": "The Sloan Digital Sky Survey (SDSS) currently provides by far the largest\nhomogeneous sample of intermediate signal-to-noise ratio (S/N) optical spectra\nof galaxies and quasars. The fully automated SDSS spectroscopic reduction\npipeline has provided spectra of unprecedented quality that cover the\nwavelength range 3800-9200A. However, in common with spectra from virtually all\nmulti-object surveys employing fibres, there remain significant systematic\nresiduals in many of the spectra due to the incomplete subtraction of the\nstrong OH sky emission lines longward of 6700A. The S/N over substantial\nwavelength regions in many spectra is reduced by more than a factor of 2 over\nthat expected from counting statistics. We present a method to automatically\nremove the sky residual signal, using a principal component analysis (PCA)\nwhich takes advantage of the correlation in the form of the sky subtraction\nresiduals present in each spectrum. Application of the method results in\nspectra with essentially no evidence for degradation due to the incomplete\nsubtraction of OH emission features. A dramatic improvement in the quality of a\nsubstantial number of spectra, particularly those of faint objects such as the\nbulk of the high-redshift quasars, is achieved. We make available IDL code and\ndocumentation to implement the sky residual subtraction scheme on SDSS spectra\nincluded in the public data releases. We illustrate the power of the\nsky-residual subtraction scheme using samples of SDSS galaxy and quasar\nspectra, presenting tests involving the near-infrared CaII triplet absorption,\nmetal absorption line features in damped Lyman-alpha systems and composite\nspectra of high-redshift quasars."}, "authors": ["Vivienne Wild", "Paul C. Hewett"], "author_detail": {"name": "Paul C. Hewett"}, "author": "Paul C. Hewett", "links": [{"title": "doi", "href": "http://dx.doi.org/10.1111/j.1365-2966.2005.08844.x/abs/", "rel": "related", "type": "text/html"}, {"href": "http://arxiv.org/abs/astro-ph/0501460v1", "rel": "alternate", "type": "text/html"}, {"title": "pdf", "href": "http://arxiv.org/pdf/astro-ph/0501460v1", "rel": "related", "type": "application/pdf"}], "arxiv_comment": "17 pages, 16 figures, accepted MNRAS. Accompanying code available for\n  download from http://www.ast.cam.ac.uk/research/downloads/code/vw/", "arxiv_primary_category": {"term": "astro-ph", "scheme": "http://arxiv.org/schemas/atom"}, "tags": [{"term": "astro-ph", "scheme": "http://arxiv.org/schemas/atom", "label": null}], "pdf_url": "http://arxiv.org/pdf/astro-ph/0501460v1", "affiliation": "None", "arxiv_url": "http://arxiv.org/abs/astro-ph/0501460v1", "journal_reference": "Mon.Not.Roy.Astron.Soc.358:1083-1099,2005", "doi": "10.1111/j.1365-2966.2005.08844.x/abs/", "fulltext": "Mon. Not. R. Astron. Soc. 000, 000\u2013000 (0000)\n\nPrinted 21 November 2018\n\n(MN LATEX style file v2.2)\n\nPeering through the OH-forest: a new technique to remove residual\nsky features from SDSS spectra\nVivienne Wild\u22c6 , Paul C. Hewett\n\narXiv:astro-ph/0501460v1 21 Jan 2005\n\nInstitute of Astronomy, University of Cambridge, Madingley Road, Cambridge CB3 0HA, UK\n\n21 November 2018\n\nABSTRACT\n\nThe Sloan Digital Sky Survey (SDSS) currently provides by far the largest homogeneous\nsample of intermediate signal-to-noise ratio (S/N) optical spectra of galaxies and quasars. The\nfully automated SDSS spectroscopic reduction pipeline has provided spectra of unprecedented\nquality that cover the wavelength range 3800 \u2212 9200 \u00c5. However, in common with spectra\nfrom virtually all multi-object surveys employing fibres, there remain significant systematic\nresiduals in many of the spectra due to the incomplete subtraction of the strong OH sky emission lines longward of 6700 \u00c5. These sky lines affect almost half the wavelength range of the\nSDSS spectra, and the S/N over substantial wavelength regions in many spectra is reduced\nby more than a factor of 2 over that expected from counting statistics. We present a method\nto automatically remove the sky residual signal, using a principal component analysis (PCA)\nwhich takes advantage of the correlation in the form of the sky subtraction residuals present\nin each spectrum. Application of the method results in spectra with essentially no evidence\nfor degradation due to the incomplete subtraction of OH emission features. A dramatic improvement in the quality of a substantial number of spectra, particularly those of faint objects\nsuch as the bulk of the high-redshift quasars, is achieved. We make available IDL code and\ndocumentation to implement the sky residual subtraction scheme on SDSS spectra included\nin the public data releases. To ensure that absorption and emission features intrinsic to the\nobject spectra do not affect the subtraction procedure line masks must be created that depend\non the scientific application of interest. We illustrate the power of the sky-residual subtraction scheme using samples of SDSS galaxy and quasar spectra, presenting tests involving the\nnear-infrared CaII triplet absorption, metal absorption line features in damped Ly\u03b1 systems\nand composite spectra of high-redshift quasars.\nKey words: methods: statistical \u2013 surveys \u2013 techniques: spectroscopic\n\n1 INTRODUCTION\nThe development over the last two decades of efficient and reliable\nwide-field multi-object spectrographs has resulted in enormous advances in the ability to compile large samples of high-quality astronomical spectra. The Sloan Digital Sky Survey (SDSS; York et al.\n2000) represents the most impressive application yet of such an instrument to provide spectroscopic samples of quasars, galaxies and\nstars of unprecedented size. The third data release (DR3; Abazajian et al. 2004b) provides the astronomical community with nearly\n500,000 object spectra and further releases will take the number to\n750,000 within eighteen months.\nThe SDSS spectra present a dramatic improvement in quality over data from previous surveys: extended wavelength cov-\n\n\u22c6\n\nvw@ast.cam.ac.uk\n\nc 0000 RAS\n\nerage, 3800 \u2212 9200 \u00c5; intermediate resolution, \u03bb/\u2206\u03bb \u2243 2500;\nhigh-quality relative and absolute flux-calibration; typical signalto-noise ratios (S/N) of 10 \u2212 30; availability of accurate noise and\nmask arrays. Coupled with the overall homogeneity of the dataset\nthis makes them suitable for an almost limitless number of quantitative investigations.\nA particularly impressive aspect of the instrumental design,\nobserving strategy and data reduction pipeline (Newman et al.\n2004) has been the quality of the sky-subtraction achieved considering the relatively large, 3 arcsecond diameter fibres and fully automated reduction. Subsets of the SDSS spectra, such as the fainter\nquasars, include objects with magnitudes in red passbands equivalent to the sky-brightness per square arcsecond. Despite the demonstrable quality of the SDSS spectra, visual inspection reveals significant systematic sky-subtraction residuals longward of 6700 \u00c5 in\nmany spectra. For fainter objects in particular, the sky-subtraction\nresiduals are the dominant source of uncertainty over a wavelength\n\n\f2\n\nV. Wild & P. Hewett\n\ninterval of some 2000 \u00c5. The spectroscopic region involved is extensive and includes features of significant astrophysical interest;\nexamples include the Calcium triplet (8500, 8545, 8665 \u00c5), a powerful diagnostic of stellar populations in low-redshift galaxies, and\nthe H\u03b2 + [OIII] 4959, 5007 \u00c5 emission region in quasars and active\ngalactic nuclei (AGN) in the redshift interval 0.4 < z < 0.8.\nWith sufficient care (e.g. Bolton et al. 2004) it is possible to\nquantify the noise properties of the SDSS spectra in the red, allowing the statistical significance of features to be estimated reliably.\nHowever, the decrease in the S/N relative to that expected from\ncounting statistics can be factors of 2-3. Coupled with the substantial fraction of the spectral range affected, many potential scientific\ninvestigations are compromised.\nThe sky-subtraction procedures incorporated in the SDSS\nspectroscopic pipeline are very effective, overcoming a number of\nthe longstanding problems associated with wide-field multi-fibre\nobservations. Brief details can be found in the Early Data Release\npaper (Stoughton et al. 2002, Sections 4.8.5 and 4.10.1) and information on calibration improvements for the Second Data Release\n(DR2) are given in Abazajian et al. (2004a). While the large area\nof sky, 7.1 square arcseconds, observed through the fibre aperture\nexacerbates the problem of achieving accurate sky-subtraction, the\norigin of the dominant systematic residuals present in the SDSS\nspectra is not a preserve of fibre spectroscopy alone. Rather, the\nfundamental issue lies in the ability to remove OH emission features from spectra in which the line profiles are barely resolved.\nCombined with sub-pixel changes in the pixel-to-wavelength calibration between spectra, sharp residuals often remain.\nKelson (2003) provides a recent summary of the difficulties\nassociated with accurate sky-subtraction in long-slit observations,\npresenting a highly effective procedure for removing the signature\nof even rapidly varying and poorly sampled emission line features.\nThe technique described by Kelson is certainly not applicable to the\nextracted fibre spectra available as part of the official SDSS Data\nReleases and any improvement must rely on an alternative procedure. The sky-subtraction residuals arise from the subtraction of\ntwo essentially identical tooth-comb signatures that have been very\nslightly misaligned relative to one another leading to well-defined\npatterns (Fig. 1). This suggests a correction procedure that takes\nadvantage of the correlations present in the wavelength direction,\noffering significant advantages over simply masking the affected\npixels.\nMore specifically, we develop an approach for the removal of\nthe dominant OH sky-subtraction residuals in the SDSS spectra\nbased on principal component analysis (PCA). PCA (also called\nKarhunen\u2013Lo\u00e8ve transformation) is a well-established data reduction technique in astronomy, frequently applied to classification and\nreconstruction problems associated with large numbers of spectra of various types of object (e.g. galaxies: Connolly et al. 1995;\nFolkes et al. 1996; Madgwick et al. 2002, 2003; Yip et al. 2004a.\nQuasars: Francis et al. 1992; Yip et al. 2004b. Stars: Whitney 1983).\nThe idea of employing PCA for sky-subtraction has been suggested\nby Kurtz & Mink (2000), who present a complex method to remove the sky signal without the need for concurrent sky observations. However, the scheme appears to have generated little interest, perhaps because of the ambitious goal of the technique and the\ntargeting of observations in which sky spectra are unavailable. By\ncontrast, we develop a much more specific application of the PCA\ntechnique to the SDSS DR2 spectra that results in an improvement\nby over a factor of 2 in the S/N of those pixels longward of 6700 \u00c5\naffected by OH sky lines, dramatically increasing the potential use\nof the red half of the SDSS spectra for a variety of scientific inves-\n\ntigations. The technique is equally applicable to the spectra in the\nrecent DR3 release. We adopt the same convention as employed in\nthe SDSS and use vacuum wavelengths throughout the paper.\nIn Section 2 we present our method which is applied to\nSDSS galaxy and quasar spectra in Section 3. Section 4 uses\nsubsets of the SDSS DR2 spectroscopic catalogue to demonstrate application of the method to various astronomical studies. The code and documentation with which to carry out the\nmethod on public release SDSS spectra is available on the web at\nhttp://www.ast.cam.ac.uk/research/downloads\n/code/vw/.\n\n2 METHOD\nOur overall approach is determined by the extent of the spectroscopic information provided in a SDSS public data release. The\nraw CCD exposures, typically 4 or 5 per spectroscopic plate, that\nmake up the total exposure in each spectroscopic field are not available, precluding any attempt to improve the sky-subtraction on an\nexposure by exposure basis. However, the SDSS data releases do\nprovide the final reduced spectra for both target objects and for\nthe fibres allocated to blank sky regions employed to define the\nunderlying spectrum of the night sky. These contain significant diagnostic information about the quality of sky subtraction for each\nspectroscopic plate.\nFor each observation of a SDSS spectroscopic plate, approximately 32 fibres, 16 for each of the 2 spectrographs, are assigned\nto blank sky regions, selected from areas containing no detected\nobjects in the SDSS imaging survey. The sky fibres are identified\nas \"SKY\" in the catalogue's \"OBJTYPE\" and \"SPECCLASS\" field.\nThe sky spectra are combined to create a \"master-sky\" spectrum\nfor each spectroscopic plate, which is then scaled and subtracted\nfrom each of the 640 spectra, producing 608 sky-subtracted object\nspectra and 32 sky-subtracted sky spectra, all of which are part of\nthe standard SDSS data releases. Throughout the remainder of the\npaper we will refer to the sky-subtracted sky spectra as \"sky spectra\", and the sky-subtracted object spectra as \"object spectra\".\nThe availability of large numbers of sky spectra, over 18,500\nin DR2, thus provides a direct empirical measure of the noise resulting from counting statistics as well as any systematic residuals\nfrom the sky-subtraction procedure. The scale of the SDSS releases\nis such that the application of empirical self-calibration techniques,\nbased on the statistical properties of the data set itself, can be a\npowerful tool.\nVisual inspection of the spectra of faint objects, or sky spectra (Fig. 1), immediately reveals the presence of \"patterns\" due to\nsmall imperfections in sky subtraction. The presence of systematic deviations that are correlated over extended wavelength ranges\nsuggests that a technique capable of quantifying the form and amplitude of the correlated deviations could allow the removal of a\nsubstantial fraction of the sky-subtraction noise. PCA is a wellestablished technique with a number of desirable properties for\nsuch an application.\nThe principles behind our sky-subtraction method are simple\nto understand: a PCA of the sky spectra produces a set of orthogonal components that provides a compact representation of the systematic residuals resulting from the sky-subtraction process. The\ncomponents are then added in linear combinations to remove the\nsystematic sky residuals from the spectra of target objects, such as\ngalaxies.\nOur analysis focuses on the red part of the SDSS spectra\nc 0000 RAS, MNRAS 000, 000\u2013000\n\n\fPeering through the OH-forest\n\n3\n\nFigure 1. Examples of poor OH sky emission line subtraction in SDSS sky-subtracted sky spectra. Note the well-defined patterns present, particularly the\ncharacteristic positive-negative residuals.\n\n(6700 \u2212 9180 \u00c5), as the strong emission features blueward of\n6700 \u00c5 are small in number and easily masked. The upper limit\nof 9180 \u00c5 is set by the requirement that the entire wavelength region be included in all spectra when creating the PCA components\nfrom the sky spectra. Although techniques exist to overcome this\n(Connolly & Szalay 1999), it was believed they would not greatly\nimprove the applicability of the procedure for scientific objectives\ndue to the very small fraction of plates affected.\n\nthe spectrum, to eliminate spectra with substantial numbers of\nmissing pixels. Following a trial run of the PCA, 300 spectra are\nidentified as outliers in the distribution of principal components,\ntherefore dominating particular components, and discarded (see\nSection 2.2). Application of these selection criteria leaves 15,178\nsky spectra. Finally, the spectra were normalised to have a median\nflux of zero over the wavelength range 6700 \u2212 9180 \u00c5. None of\nthe results in the paper depend on the details of the criteria used to\ndefine the subset of sky spectra to be used in the PCA-analysis.\n\n2.1 A sample of sky spectra\nThe goal of the sky-subtraction scheme is to remove any systematic\nresiduals from the bulk of the SDSS spectra. Pathological spectra\nwith very unusual deviations can have a disproportionate effect on\nthe generation of the PCA components. Therefore, we identify a\nrestricted subset of the full 18,764 sky spectra for use in deriving\nthe PCA components.\nFor the wavelength range used in the analysis (6700 \u2212\n9180 \u00c5) the spectra must satisfy the following criteria, where\nthe numerical values are in the units of the SDSS spectra\n(10\u221217 erg s\u22121 cm\u22122 \u00c5\u22121 ):\n(i) \u22120.2 < mean flux < 0.2, ensuring the spectra have a mean\nclose to zero.\n(ii) variance of the flux < 0.8, ensuring that the amplitude of\npixel-to-pixel fluctuations is not unusually high\n(iii) \"spectral colours\" have values |a \u2212 b| < 0.1, |a \u2212 c| < 0.3\nand |b\u2212c| < 0.3 ensuring that the spectra do not exhibit significant\nlarge scale gradients. a, b and c are calculated by averaging the\nflux in three wavelength regions largely free of OH sky emission\n(7000:7200 \u00c5 [a], 8100:8250 \u00c5 [b] and 9100:9180 \u00c5 [c]).\nWe further only accept spectra with a minimum of 3800 good\npixels (\"NGOOD\" parameter) over the entire wavelength range of\nc 0000 RAS, MNRAS 000, 000\u2013000\n\n2.1.1 Poisson error normalisation\nThe true error on each pixel in each spectrum is made up of components due to Poisson noise and systematic sky-subtraction errors. Our method for removing sky residuals relies on determining\nthe best-fit PCA-components via a minimum least-squares criterion over all pixels within the 6700 \u2212 9180 \u00c5 wavelength range. A\npixel which varies greatly between spectra will be weighted highly\nduring the generation of the PCA-components and in the subsequent reconstruction of the sky-residuals present in individual spectra. For example, there will be a greater variance among spectra at\nwavelengths in the vicinity of strong OH emission lines, purely due\nto Poisson noise and independent of whether there is a contribution\ndue to sky-subtraction errors. It follows that to achieve effective\nsky-subtraction it is important to normalise each spectrum by the\nPoisson noise expected at each pixel. Failure to do so results in\nover-subtraction for certain pixels, with \"corrected\" pixels apparently exhibiting fluctuations below the Poisson limit.\nEach SDSS spectrum includes a companion error array based\non the original Poisson errors derived from photon counts, CCD\nread-noise and so forth. Unfortunately for our application, the\nerror arrays have been systematically increased in regions of poor\nsky subtraction. The procedure is carried out separately for each\n\n\f4\n\nV. Wild & P. Hewett\n\nFigure 2. Top: the flux rms (67th percentile) of the 15,178 sky spectra.\nBottom: same as top, with the flux normalised by the associated median\nSDSS spectroscopic plate noise arrays. The impact of the presence of the\nOH sky emission lines is evident from the increase in the rms (by nearly a\nfactor 2 at maximum), even after the empirical scaling of the noise arrays\nin the SDSS spectroscopic reduction pipeline.\n\nFigure 3. The median noise array for plate number 0266 (grey) and the estimated continuum overplotted (black). The bar to the left hand side indicates\nthe amplitude of max(n \u2212 c) for this plate, which occurs at the wavelength\nof 8829 \u00c5.\n\nplate and details can be found in the data reduction source code at\nhttp://spectro.princeton.edu/idlspec2d doc.html#SKYSUBTRACT.\nFig. 2 shows the flux standard deviation1 (rms) of the 15,178\nsky spectra with and without normalisation by the associated\nSDSS noise arrays. If the SDSS noise arrays accounted for all\nthe variance present in the spectra, the lower plot in Fig. 2 would\nbe flat. In fact the SDSS noise arrays account well both for the\nincreased \"continuum\" noise at red wavelengths, the presence of\nthe atmospheric A-band at \u223c 7600\u00c5 and the contribution from the\nincreased sky emission associated with the presence of the broad\nO2 airglow emission centred on \u223c 8650\u00c5. However, significant\nadditional residual variance resulting from the incomplete subtraction of the barely resolved OH emission lines remains. For many\napplications the resulting scaled error arrays, which better reflect\nthe true error in each spectrum, are an improvement. However,\nusing the modified SDSS noise arrays for our sky-subtraction\nprocedure does not allow it to reach its full potential, due to the\nexcessive down-weighting of strong OH features.\nIt is not possible to recover directly the original Poisson errors\nthat we require, so instead we develop an empirical approximation from investigation of several spectroscopic plates prior to sky\nsubtraction, kindly made available to us by the SDSS project (E.\nSwitzer, P. Macdonald and D. Schlegel). These data confirmed the\nexpectation that scaling of the error arrays is applied by the SDSS\nreduction pipeline predominantly at positions of OH emission features. The same noise scaling is applied to all spectra on a plate, allowing us to derive a single rescaling for each plate. For each one of\nthe 574 plates we calculate the median noise at each wavelength increment (pixel) from the SDSS error arrays of the sky spectra. The\ncontinuum noise is calculated over the full wavelength range of interest interpolating across pixels containing OH sky emission lines.\nThe amplitude of this continuum noise is dominated by counting\nstatistics, and rises towards the red (Fig. 2; upper panel) due to an\nincrease in the sky level and instrumental effects.\n\nSi = 1 +\n\n1\n\nUnless otherwise stated estimates of rms amplitudes are taken to be the\n67th percentile of the data. This is less sensitive to the presence of small\nnumbers of extreme, non-Gaussian, outliers.\n\nWe use a simple function to approximate the rescaling of the\nnoise, Si , for each pixel i on each plate:\n\n\u0014\n\n(n \u2212 c)i\nmax(n \u2212 c)\n\n\u0015\u03b1\n\n\u00d7\u03b2\n\n(1)\n\nwhere n is the median noise of the plate, c the continuum noise,\nand max(n \u2212 c) the maximum noise, above the continuum level,\nover all pixels. Fig. 3 shows an example plate median noise array,\nwith estimated continuum and max(n \u2212 c) marked. \u03b1 and \u03b2 are\ndetermined empirically as described below and represent, respectively, the relative amount of rescaling between pixels with differing amounts of noise, and the total rescaling of the pixel with the\nhighest noise above continuum level. As the exact effects of the\nSDSS noise scaling are not understood, the form of this function is\nchosen to provide flexibility in both the total rescaling and dependence with wavelength.\nAnticipating the results of Section 3, the effectiveness of the\nPCA sky-residual subtraction procedure can be seen in Fig. 4. The\ntop panel shows the effect of the sky-residual subtraction on the\nraw rms of the sky spectra: the lower spectrum shows the uncorrected rms as a function of wavelength (reproducing the top spectrum from Fig. 2); the upper spectrum shows the raw rms after application of the sky-residual subtraction scheme. Note how the features due to the atmospheric A-band (\u223c 7600 \u00c5) and O2 -emission\n(\u223c 8450 \u00c5) are unaffected, while the height of the spikes associated with the OH emission lines is greatly reduced. The variation\nwith wavelength of the rms, post sky-residual subtraction, is explained almost entirely by counting statistics. The bottom panel of\nFig. 4 shows the rms of the sky spectra weighted by our modified\nnoise arrays (with \u03b1 = 1, \u03b2 = 0.3): the lower and upper spectra show the rms before and after subtraction of the sky residuals\nrespectively.\nFig. 5 shows the effect of varying the noise rescaling (\u03b2 in\nEq. (1)) applied to the sky spectra prior to creating the eigenspectra. From bottom to top \u03b2 = 0, 0.1, 0.2, 0.3, 0.4, 0.5. For low values of \u03b2 (small amounts of rescaling of the noise arrays) the noise\nweighted rms is approximately constant with wavelength, i.e. the\nsky-residual subtraction procedure is not removing signal below\nthe Poisson limit for any pixels, although the procedure may also\nnot be removing the full systematic contribution to the errors. As\nbeta increases, initially the rms remains constant until a point is\nreached where significant dips appear in the red half of the spectra.\nc 0000 RAS, MNRAS 000, 000\u2013000\n\n\fPeering through the OH-forest\n\nFigure 4. Top: the flux rms (67th percentile) of the 15,178 sky spectra.\nThe lower (upper) spectrum is before (after) the sky-residual subtraction\nis performed. Bottom: same as top, with flux normalised by the associated\nmedian SDSS spectroscopic plate noise arrays, scaled according to Eq. 1\n(\u03b1 = 1, \u03b2 = 0.3). For clarity, the upper spectra have been displaced vertically by 2.5 units (upper panel) and 1.5 units (lower panel). The effectiveness of the sky-residual subtraction procedure is seen by the reduction\nby more than half of the systematic spikes in the top figure, and complete\nremoval in the bottom figure.\n\n5\n\ncation of the OH emission lines (Fig. 5), as we begin to erroneously\nsubtract Poisson noise. This suggests a simple method to estimate\nthe values of \u03b1 and \u03b2 in Eq. 1: we require the weighted flux rms,\npost sky-residual subtraction, to be as constant with wavelength as\npossible whilst maximising the noise rescaling. We take a grid of\nvalues for \u03b1 and \u03b2 and for each combination first run the PCA on\nthe 15,178 sky spectra with noise normalisation scaled according\nto Eq. (1), then perform with the sky-residual subtraction with the\nsame noise weighting. By calculating the standard deviation of the\nrms array, post sky-residual subtraction, for each value of (\u03b1, \u03b2) we\ncan derive the best empirical rescaling of the SDSS noise arrays: we\nrequire the greatest value of \u03b2 that does not introduce upward or\ndownward spikes, whilst \u03b1 allows purely for potential wavelength\nvariations. We find that \u03b1 = 1 and \u03b2 = 0.3. Our final results are\ninsensitive to small changes in \u03b1 or \u03b2, and the measured value of\n\u03b1 = 1 suggests that the empirical rescaling of the noise arrays\nwithin the SDSS spectroscopic pipeline is predominantly a function of the height of the OH spikes above the continuum noise. By\nsystematically decreasing the amplitude of the noise arrays by 30%\nat positions of OH lines whilst retaining a constant noise weighted\nrms with wavelength, we substantially increase the effectiveness of\nthe method, without over-subtracting residual sky features beyond\nthe limit set by counting statistics.\nWe emphasise that it is not possible to derive the true noise\narray, based on counting statistics, for each SDSS spectrum from\nthe information contained in the publically available SDSS data releases. However, the close to constant rms as a function of wavelength achieved following our empirical rescaling of the noise arrays (Fig. 4; bottom panel) is strong evidence that, while approximate, the scheme does achieve a highly effective correction, reducing the rms close to the level set by counting statistics at all wavelengths. If a version of our sky-residual subtraction scheme could\nbe applied to the SDSS spectra using the true noise arrays, based\non counting statistics, then further improvements should result.\n\n2.1.2 Identification of sky pixels\n\nFigure 5. Flux rms (67th percentile) of the 15,178 sky spectra after skyresidual subtraction is performed, with flux normalised by the associated\nmedian SDSS spectroscopic plate noise arrays, scaled according to Eq. 1.\nFrom bottom to top \u03b2 = 0, 0.1, 0.2, 0.3, 0.4, 0.5 and \u03b1 = 1.\n\nThe presence of these dips show that an unphysical situation has\nresulted, where, following the rescaling, the noise falls below the\nPoisson limit for those pixels. The same effect is seen if we undertake the sky residual subtraction without weighting the flux by the\nnoise arrays, i.e. the noise is constant, independent of wavelength.\nThe fact that we can rescale the noise arrays by some amount before these unphysical dips appear, indicates that the SDSS noise\narrays have indeed been scaled to take account of the presence of a\nsystematic contribution to the noise at wavelengths where the OHemission is significant.\nUnder-subtraction of the sky-residual signal due to over estimation of the Poisson errors prevents our sky-residual subtraction method from reaching its full potential. Over-subtraction of\nthe sky-residual signal causes downward spikes to appear at the loc 0000 RAS, MNRAS 000, 000\u2013000\n\nThe strong sky emission lines, which lead to the presence of systematic sky-residuals, occupy only a fraction of the 6700 \u2212 9180 \u00c5\nwavelength range and it is necessary to identify those pixels which\nsuffer significantly from sky subtraction errors. The affected pixels\ncan be found via the calculation of the rms of the 15,178 sky spectra, normalised by the corresponding SDSS noise arrays (as shown\nin the lower panel of Fig. 2). All pixels above a threshold value\nare defined as \"sky pixels\". The \"non-sky pixels\" are not included\nin the PCA sky-residual removal procedure but provide an empirical estimate of the level of Poisson noise (i.e. excluding systematic\nsky-residuals) present in each spectrum. Adopting a threshold level\nof 0.85 for the sky/non-sky boundary, the scheme results in 670\nsky pixels and 697 non-sky pixels. The results shown in subsequent\nsections are not sensitive to reasonable variations in the threshold\nlevel. Finally, to minimise their effect during the calculation of the\nPCA components, sky pixels in each spectrum where the associated\nSDSS noise array is zero (i.e. no data) are set to the mean value of\nthe pixel in all the sky spectra that contain data.\n\n2.2 Principal component analysis\nPCA is a simple statistical method for data reduction which looks\nfor components in a dataset that vary the most. The technique can\nbe visualised by imagining an M -dimensional array, where M is\n\n\f6\n\nV. Wild & P. Hewett\n\nFigure 6. From top to bottom, the first 5 sky principal components, each offset vertically from the next by a value 0.35. A horizontal dashed line indicates zero\nflux in each component.\n\nthe number of pixels in the spectra. Each spectrum is then represented by a point in the M -dimensional array; PCA searches for\nlines of greatest variance through the array, each one being orthogonal to all previous lines. The line of greatest variance defines the\nfirst PCA component, and so on until the line of least variance defines the M th PCA component. The projection of an individual\nspectrum back onto a PCA component gives the amplitude of the\ncomponent contained in that particular spectrum. A spectrum is re-\n\nconstructed by summing the principal components multiplied by\nthe relative amplitudes for that spectrum. Appendix A presents the\nmathematics of PCA.\n\nHaving created a sample of sky spectra containing only those\npixels with sky signal and weighted by our empirically derived\nnoise array for the relevant plate, we run the PCA. The output consists of M principal components which are M pixels long. Each\nc 0000 RAS, MNRAS 000, 000\u2013000\n\n\fPeering through the OH-forest\ncomponent has an associated variance, which gives the percentage\nof the total variance of the dataset contained in that component.\nAs PCA can be sensitive to spectra with particularly unusual\nfeatures in which we are not interested, we remove spectra which\ndominate the signal in individual components after one trial run.\nThe pruning, of 300 spectra in total, is achieved by removing those\nspectra with principal component amplitudes more than 5\u03c3 from\nthe mean. The PCA is then rerun on the resulting sample of sky\nspectra. Fig. 6 shows the first 5 principal components resulting from\nthe analysis. Note the distinctive, correlated features present in each\ncomponent.\nOnce the components are created, they can be used as templates to reconstruct the input sky spectra and later the sky residuals in the object spectra (Section 2.3). This is done by projection of\neach spectrum onto the components and summation of the components weighted by the projection coefficients (Eq. A4 and A4). The\nreconstruction may then be subtracted from the sky spectra leaving\nresidual-free spectra, termed sky-residual subtracted spectra.\n\n2.2.1 The number of components\nThe number of components to use in the reconstruction is not well\ndefined. The use of too many results in the artificial suppression of\nnoise below the Poisson limit, with the PCA acting as an (undesirable) high-frequency filter. The use of too few components means\nthat the removal of sky residuals is sub-optimal and, in some cases,\nthe overall quality of the spectra can decrease.\nFig. 7 shows the mean ratio of the rms of the noise-weighted\nflux in the sky pixels to that in the non-sky pixels2 , for the 15,178\nsky-residual subtracted sky spectra, as a function of the number of\ncomponents used in the reconstructions. The rms of the non-sky\npixels in each spectrum remains constant and the ratio decreases\nmonotonically as more components are used in the reconstructions,\nwith an increasing fraction of the noise in the sky pixels removed.\nThe reduction of the noise in the sky pixels below the noise\nin the non-sky pixels is clearly unphysical, and we therefore estimate the number of components to employ in the reconstruction of\neach spectrum by adopting the non-sky pixel rms of that spectrum\nas a reference. The reconstruction of a spectrum proceeds one component at a time, with the rms ratio calculated for the sky-residual\nsubtracted spectrum. Reconstruction is stopped when the rms ratio\nreaches unity, i.e. when the noise weighted flux rms is the same for\nthe sky and non-sky pixels. The scheme is largely self-calibrating.\nFor example, in spectra with high S/N the systematic sky residuals\ntypically contribute only marginally to the sky-pixel noise, the rms\nratio thus starts close to unity and only a small number of components are necessary to achieve equality in the rms ratio.\nThe large number of pixels that contribute, combined with the\nrobust estimator of the non-sky rms, mean the amplitude of the\nnon-sky rms is well determined, providing an excellent indicator\nof when to halt the reconstructions. Fig. 8 shows the distribution\nof the number of components used for DR2 sky, galaxy and quasar\nspectra. For bright objects the contribution to the noise from imperfections in the sky subtraction is small and few components are\nrequired to bring the sky and non-sky rms to the same level. The\npresence of many spectra with high S/N produces the \"spike\" at\n2\n\nCalculation of the non-sky rms requires a robust estimator unaffected\nby non-Gaussian outliers, whereas the sky rms must remain sensitive to\noutliers. Therefore, while a 67th percentile rms is used for the former, the\nstandard deviation of the data is used for the latter.\nc 0000 RAS, MNRAS 000, 000\u2013000\n\n7\n\nFigure 7. The mean ratio of sky to non-sky flux rms over all sky spectra\nin our sample as a function of the number of components used during sky\nresidual reconstruction. Fluxes are weighted by their respective scaled plate\nnoise arrays. The horizontal dashed line indicates where the two rms values\nare equal. The error bars show the standard deviation of all objects in the\nsample.\n\nFigure 8. Histograms showing the number of components used to reconstruct the sky signal in the sky (dotted line), galaxy (thin line) and quasar\n(thick line) DR2 samples. The y axis is truncated in order to show the majority of the objects, 18% (5%) of galaxies (quasars) require zero components.\n\nlow component numbers in both the galaxy and quasar sample histograms. The fainter limiting magnitude of the quasar sample make\nsky-residuals a problem in a larger fraction of the spectra and, on\naverage, more components are required to remove the systematic\nerrors present following the default SDSS-pipeline sky-subtraction.\nTo limit the effect of very occasional poor estimation of the nonsky rms we set the maximum number of components to 150 and\n200 for the galaxy and quasar samples respectively.\n\n2.3 Reconstructing sky residuals in an object spectrum\nIn the preceding sections we have developed a procedure that\nachieves a substantial reduction in the amplitude of the systematic\nsky residuals in spectra that possess no large scale signal, i.e. the\nsuccessfully sky spectra are known, by definition, to possess zero\nsignal at all wavelengths. We now turn to the more interesting ap-\n\n\f8\n\nV. Wild & P. Hewett\n\nplication of removing the systematic sky-residuals from the SDSS\nscience spectra of targets such as galaxies and quasars.\nThe problem is made tractable by the success of the skysubtraction procedure performed as part of the standard SDSS spectroscopic pipeline. Detailed examination of the properties of the sky\nspectra shows that both the mean level and the large scale shape of\nthe sky spectrum to be subtracted from each spectrum have been\ndetermined to very high accuracy. As a result, there is effectively\nno sky \"continuum\" to remove, rather the problem is confined to\nremoving the high-frequency structure due to the presence of the\nstrong OH sky emission lines. The key goal is to ensure that object\ncontinuum and intrinsic absorption and emission line features are\nnot removed as a result of the procedure used to reduce the amplitude of the systematic sky-residuals.\nAs it is not necessary to identify any sky continuum present,\nwe can remove the continuum of the object spectrum using a median filter before projection of the spectrum onto the principal components derived from the sky spectra. The smallest filter size can be\nfound from median filtering the sky spectra as it is important that\nthe filter is unaffected by the OH residuals (about 40 pixels). As the\nfilter size is increased above this minimum, some features intrinsic\nto the object fail to be removed. This generally causes an increase\nin the rms of the non-sky pixels used as a reference point to halt the\nreconstruction (see previous Section) and therfore a decrease in the\nnumber of components used and slight decrease in the effectiveness\nof the sky-residual subtraction procedure. However, the final effect\nis small and insignificant for a reasonable range of filter sizes (up to\nabout 80 pixels). We have used a filter size of 55 pixels throughout\nthis paper. In certain circumstances, it may be desirable to reduce\nthe filter scale in order to follow the broad emission line profiles in\nquasars closer to the line centroids.\nNarrow line features present the greatest challenge, as these\ncan be mistaken for an OH sky residual by the PCA. The advantage\nof PCA in this task is that it looks for patterns in the spectrum, linking lines together which are correlated in the input sky spectra, and\nweights all bins equally. However, if an emission or absorption feature occurs exactly at the location of an OH line, some combination\nof principal components can sometimes be found to reconstruct the\nfeature, without increasing the rms in the rest of the spectrum significantly. Such behaviour is particularly likely if the line feature\nlies in a noisy part of the spectrum. For most applications in which\nthe sky-residual subtraction scheme might be employed, it is possible to mask known emission and absorption features, thereby circumventing the problem. In Section 4.1 we show how such masked\nfeatures are unaffected by the sky-residual subtraction procedure.\nThe disadvantage is that real sky features which happen to fall in\nthe masked regions do not contribute to the projection onto the principal components and the sky-residual subtraction may not be fully\neffective in these regions. In some potential applications, it is not\nknown in advance where absorption and emission features may occur and we present such an example in Section 4.2. Features are\nmasked by removing the relevant pixels during projection onto the\nprincipal components. Alternatively, replacing the pixels with the\nlocal mean results in almost identical reconstruction. We similarly\nmask bad pixels (where the SDSS noise array is set to zero).\nOnce the object spectrum has been continuum subtracted, we\ndivide by the SDSS noise spectrum of the relevant plate and project\nonto the sky principal components (Eq. A3), leaving out those pixels identified as possibly containing emission and absorption features. The resulting principal component amplitudes are used to\nreconstruct the residual sky-subtraction signal (Eq. A4) and the\nreconstruction is subtracted from the object spectrum, including\n\nmasked pixels. Re-multiplication by the noise spectrum, followed\nby the addition of the object continuum, returns the object spectrum cleaned of OH sky emission line residuals. Fig. 9 illustrates\nthe process of sky-residual subtraction on a typical SDSS galaxy\nspectrum.\n\n3 APPLICATION OF METHOD TO SDSS SPECTRA\nEach class of spectroscopic science targets has different spectral\ncharacteristics. The effective application of the sky residual subtraction scheme requires the removal of the large scale \"continuum\" signal from the target object and the identification of wavelength intervals where narrow emission or absorption features may\nbe present. The extremely high identification success rate achieved\nin the SDSS means that the wavelengths of strong absorption and\nemission features in the spectra of stars and galaxies are known;\nthere are only 3,002 spectra without secure identifications among\nthe 329,382 object spectra included in DR2. Potential systematic\nbiases in the sky residual subtraction can be prevented by masking\nthe wavelength intervals that include such features.\nThe exact nature of the pre-processing applied to spectra prior\nto the implementation of the sky residual subtraction depends on\nthe scientific goal. However, in subsequent sections we describe\nschemes that are likely to have wide application in the analysis of\nthe 3 main classes of SDSS science targets: galaxies, quasars and\nstars.\n\n3.1 Galaxies\nThe DR2 catalogue contains 249,678 unique objects spectroscopically classified as galaxies. The strong systematic trends in the\nabsorption- and emission-line properties of the galaxies as one\nmoves from early through to late type objects necessitates a subclassification of the population prior to the application of the skyresidual subtraction. Therefore, we classify each galaxy as either an\nabsorption line, emission line or extreme emission line object. The\nspectral type parameter (\"ECLASS\") in the SDSS catalogue provides the basis for the absorption line (ECLASS< \u22120.05) and emission line (ECLASS > \u22120.05) classification. The extreme emission\nline galaxies are identified through the presence of emission lines\nwith very large equivalent widths (EW) (EWH\u03b1 > 200\u00c5, z < 0.4;\nor EW[OIII] > 200\u00c5, z < 0.84). An appropriate feature mask\nis then applied depending on the galaxy type (e.g. see Fig. 9). A\ntotal of 331/286/469\u00c5 are masked in absorption/emission/extreme\nemission line objects respectively, over the entire rest-frame wavelength range of 3830 \u2212 9100 \u00c5, i.e. in the observed-frame wavelength range of 6700 \u2212 9180 \u00c5 only a small fraction of pixels are\naffected by the line masks. Fig. 10 shows examples of galaxy spectra before and after sky residual removal.\n\n3.2 Quasars\nThe DR2 catalogue contains 34,674 unique objects spectroscopically classified as quasars or high-redshift quasars. A feature mask\nincludes narrow emission lines (e.g. [OIII] 4961, 5008 \u00c5) and 70 \u00c5\nintervals3 (observed frame) centred on the broad emission lines\n(e.g. CIV 1550 \u00c5). The wings of the broad emission features can, in\n3\n\nCorresponding to approximately half the filter size in this wavelength\nrange\nc 0000 RAS, MNRAS 000, 000\u2013000\n\n\fPeering through the OH-forest\n\n9\n\nFigure 9. 1 (top): The wavelength region 6700 \u2212 9180 \u00c5, of the SDSS galaxy spectrum spSpec-52427-0979-563. Pixels included in the feature mask are\nindicated by black horizontal bars under the spectrum; 2: The same spectrum but showing only \"sky\" pixels, regions between sky pixels are joined by a dotted\nline; 3: The reconstructed sky spectrum; 4 (bottom): The final sky-residual subtracted galaxy spectrum.\n\npractice, be regarded as \"continuum\" in the context of the sky residual subtraction as they are removed by the median filtering. Fig. 11\nshows examples of quasar spectra before and after sky subtraction.\n3.3 Stars\nThere are 42,027 unique objects classified as stars or late-type stars\nin the DR2. Due to their single redshift, application of the skysubtraction procedure is even simpler. Depending on the final science required and the type of stars involved, a suitable feature mask\nand continuum estimation can be straightforwardly derived but our\nadopted median filter scale of 71 pixels, employed for the galaxies\nand quasars, produces very satisfactory results.\n\n4 TESTS OF METHOD ON SDSS SCIENCE OBJECTS\nIn this Section we present the quantitative results of applying the\nsky-residual subtraction to a variety of object spectra.\nc 0000 RAS, MNRAS 000, 000\u2013000\n\n4.1 Galaxy absorption features: The CaII triplet\n\nThe far red spectrum of galaxies is where old stellar populations\nemit most of their light. Contamination by light from hot, young\nstars and any blue \"featureless\" AGN continuum is reduced compared to shorter wavelengths. The impact of Galactic reddening is\nalso much reduced (Rutledge et al. 1997). The CaII triplet (8500.4,\n8544.4, 8664.5 \u00c5), the strongest absorption feature in this region,\nis visible in stellar spectra of all but the hottest spectral types.\nThe CaII triplet EW is considered a good estimator of luminosity\nclass in high metallicity objects and a useful metallicity indicator\nin metal-poor systems (e.g. Diaz et al. 1989). The relatively narrow intrinsic widths of the lines (\u03c3 \u2248 50km s\u22121 ) and the increased\nvelocity resolution per \u00c5, twice that at blue optical wavelengths,\nmakes the CaII triplet ideal for studying the internal kinematics of\ngalaxies (Dressler 1984; Terlevich et al. 1990). In spectra of intermediate S/N, the principle limitation to the use of the CaII triplet\nis the presence of a large number of strong OH emission lines.\n\n\f10\n\nV. Wild & P. Hewett\n\nFigure 10. Examples of sky-residual subtraction applied to galaxy spectra. In each panel the lower spectrum is the raw SDSS data and the upper spectrum is\nafter application of the sky-residual subtraction procedure. The upper sky-residual subtracted spectrum is offset for clarity.\nc 0000 RAS, MNRAS 000, 000\u2013000\n\n\fPeering through the OH-forest\n\n11\n\nFigure 11. Examples of sky-residual subtraction applied to quasar spectra. In each panel the lower spectrum is the raw SDSS data and the upper spectrum is\nafter application of the sky-residual subtraction procedure. The upper sky-residual subtracted spectrum is offset for clarity.\nc 0000 RAS, MNRAS 000, 000\u2013000\n\n\f12\n\nV. Wild & P. Hewett\n\nFigure 12. Example SDSS spectra in the region of the CaII triplet, before (lower) and after (upper) sky-residual subtraction. Vertical lines indicate where\nequivalent widths of lines are measured, shaded regions are where the continuum is estimated. The inferred continuum is overplotted (dashed line). In each\ncase the upper corrected spectrum is offset for clarity.\nc 0000 RAS, MNRAS 000, 000\u2013000\n\n\fPeering through the OH-forest\n\n13\n\nTable 1. Mean EWs, EW-ratios and sample variances of the final two CaII triplet lines (8544\u00c5 [2], 8664\u00c5 [3]), before and after the sky-residual subtraction.\nm is the width of the feature mask applied during reconstruction (see text).\n\nBefore subtraction\nm\n\nmean(EW2+EW3)\n\nmean(EW2/EW3)\n\nvar(EW2/EW3)\n\nmean(EW2+EW3)\n\nmean(EW2/EW3)\n\nvar(EW2/EW3)\n\n1\n2\n3\n\n-4.86\n-4.85\n-4.85\n\n1.46\n1.46\n1.46\n\n0.35\n0.35\n0.35\n\n-4.86\n-4.86\n-4.86\n\n1.46\n1.46\n1.46\n\n0.32\n0.33\n0.32\n\nFigure 13. Resulting reduced-\u03c72 between a scaled matched-filter and \u223c\n6000 spectra with detected CaII triplet, as a function of the observed wavelength of the 8544.4\u00c5 line. Upper (lower) panel is for spectra without (with)\nsky-residual subtraction. All galaxies in SDSS DR3 with S/N in the R band\nof < 15 and redshifts z < 0.05 are searched for the CaII triplet at the\nredshift of the galaxy. The sky-residual subtracted spectra are treated identically to the original dataset. The samples plotted result from adopting a\n3\u03c3 detection threshold for the presence of the CaII triplet.\n\nThe SDSS spectra allow the measurement of the the CaII triplet\nin galaxies out to redshifts z <\n\u223c 0.06.\nThe CaII triplet is ideally placed to investigate any potential\nbias in line feature properties caused by the sky-residual subtraction\nprocedure. A large sample of galaxies with significant CaII triplet\nabsorption and measured velocity dispersions from the SDSS spectroscopic data reduction pipeline is readily identified. Furthermore,\nperforming our own line search on low S/N SDSS spectra allows\nan immediate demonstration of the potential benefits afforded by\nthe sky-residual subtraction technique.\n\n4.1.1 Equivalent width line ratios\nGalaxy velocity dispersion (\u03c3v ) is only measured in the standard\nSDSS data reduction pipeline for objects with ECLASS < \u22120.02,\nz < 0.4 and SPECCLASS = \"GALAXY\" 4 . We select a sample\nof 7760 galaxies according to the criteria: z < 0.054, to provide enough spectrum for continuum estimation; 70 < \u03c3v <\n420 km s\u22121 ; S/N > 10 in the r-band as recommended on the\nSDSS website; CaII[8544.4] and CaII[8664.5] absorption lines detected in the SDSS catalogue at > 4\u03c3 significance. We remove\n4\n\nAfter subtraction\n\nsee http://cas.sdss.org/astro/en/help/docs/algorithm.asp\n\nc 0000 RAS, MNRAS 000, 000\u2013000\n\nfrom this sample those galaxies which are untouched by the sky\nsubtraction procedure (their non-sky rms is equal to or greater than\ntheir sky rms). As we have selected high S/N objects through the\nrequirement of significant CaII triplet line detection, this removes a\nfurther \u223c 1000 galaxies, leaving a sample of around 5500 (dependent on the width of the mask used for the CaII triplet lines).\nThe centre of each line is given by the line wavelength in the\nSDSS catalogue; the feature mask width and the region over which\nthe line EW is measured are set as \u00b1m\u03c3v and \u00b1n\u03c3v respectively.\nWe use a value of n = 2 which generally spans the widths of the\nlines well, m can take different values to investigate any bias caused\nby the sky-residual subtraction procedure. The continuum level at\neach wavelength in the region of the absorption lines is determined\nusing a linear interpolation between the median flux contained in\ntwo bands, (8444.3:8469.3\u00c5 and 8687.4:8712.4\u00c5). Fig. 12 shows\nexamples of SDSS galaxy spectra in the CaII triplet region before\nand after sky-residual subtraction. The regions defining the absorption lines and continuum bands are indicated.\nThe rest-frame EW is calculated as\nEW =\n\nN\nX\ni=1\n\n\u2206(Wi )(1 \u2212\n\nfi\n)\nci\n\n(2)\n\nwhere N is the total number of pixels, \u2206(Wi ) the width of pixel i\nin \u00c5 (rest-frame), fi the observed flux, and ci the continuum.\nThe total EW is defined as the sum of the two strongest absorption lines at 8544 \u00c5 and 8664 \u00c5. Inclusion of the other, weaker, line\noften increases the noise (e.g. Diaz et al. 1989). While the total EW\nvaries with galaxy type, the ratio of the line EWs remains constant.\nTable 1 presents the mean total EW, and mean and variance of the\nratio of first to second EWs for the galaxy sample, before and after\nsky residual subtraction, and for mask widths of m = 1, 2 and 3.\nProvided the feature mask is broad enough to include the wings of\nthe absorption lines, the mean total EWs are not significantly different. The mean EW ratios and variances also remain constant even\nwith the narrowest feature mask.\nOn average, the sky-residual subtraction produces improvements in the S/N of spectra within the regions of the masked absorption features; the feature mask excludes the absorption line\nwavelengths from contributing to the PCA reconstruction of the\nsky residual but the sky-residual subtraction is applied to all wavelengths. The key result of the test using the properties of the CaII\ntriplet is that, providing the features are masked prior to the PCA\nreconstruction of the sky-residual signal, the properties of the features are not systematically biased.\n4.1.2 Improvement in feature detection quality\nA practical illustration of the improvement afforded by the skyresidual subtraction procedure is seen in the results of a conventional matched-filter search (Hewett et al. 1985) for the presence of\n\n\f14\n\nV. Wild & P. Hewett\n\nthe CaII triplet in relatively low S/N spectra. The DR3 release, used\nin this case simply to increase the sample size, contains \u223c 15000\ngalaxy spectra with S/N in the R band of < 15. The original and\nsky-residual subtracted spectra were treated identically. Adopting\na nominal 3\u03c3 threshold for detection results in 5702 and 5662 detections respectively, 5119 of which are common to both. Close\nto the 3\u03c3 S/N threshold, twice as many spurious detections of the\nCaII triplet \"in emission\" exist in the original sample, providing\nevidence that the \u223c 10% of lines unique to each sample are statistically more reliable in the sky-subtracted data set. However, the\nmost significant difference apparent in the properties of the detected features is in the quality of the fit between the matched-filter\ntemplate and the data. For each CaII triplet detection a goodness-offit is calculated based on the sum of the squared deviations between\nthe data and the scaled template. In Figure 13 this is plotted versus\nthe observed frame wavelength of the 8544\u00c5 line. The overall scatter in the \u03c72 distribution at wavelengths where OH lines are present\n(>8650\u00c5) is significantly reduced in the case of the sky-residual\nsubtracted spectra (the median \u03c72 for detections with wavelength\n>8650\u00c5 decreases by 27%). The systematic trend as a function of\nwavelength is also essentially removed. A significant fraction of\nthe original spectra present extremely poor fits where the observed\nframe wavelength of the triplet coincides with a particularly strong\nOH line. At wavelengths >8650\u00c5, the fraction of detections with\n\u03c72 values exceeding twice the median value decreases from 8% to\njust 1% in the case of the sky-residual subtracted galaxies.\n4.2 Absorption features in damped Ly\u03b1 systems\nThe detection of intervening absorption features in quasar spectra is an example of an investigation in which it is not possible\nto simply mask the wavelength regions containing features before\nthe application of the sky residual subtraction. That is not to say\nthat the sky-residual subtraction scheme is not of potential interest. The improvement in the quality of the spectra is such that the\nS/N of specific features can increase, albeit at the potential cost of\nmodification of the feature properties. In practice, a hybrid scheme,\ninvolving one or more iterations, with detected features masked in\na second application of the sky-residual subtraction, is straightforward to implement.\nIn any particular application, a full understanding of the advantages of employing the sky-residual subtraction scheme would\nrequire the use of (straightforward) Monte Carlo simulations to\nquantify the probability of feature detection as a function of wavelength. Such an investigation is beyond the scope of the present\npaper but to illustrate the impact of the sky-residual subtraction on\nunmasked absorption features we create a composite spectrum of\ndamped Ly\u03b1 (DLA) systems identified by Prochaska & HerbertFort (2004). Each quasar spectrum is shifted to the rest frame of\nthe DLA absorber and normalised to possess the same signal in the\nabsorber rest-frame wavelength interval 1250 \u2212 1800 \u00c5. The composite spectrum is then constructed using an arithmetic mean of all\nthe spectra with signal at each wavelength, taking care to account\nfor the flux/\u00c5 term in the SDSS spectra. Fig. 14 shows the resulting\ncomposite spectrum, calculated with and without the application of\nthe sky-residual subtraction to the constituent quasar spectra. As\nin Section 3.2 the centres of prominent broad emission lines in the\nquasars are masked during the sky-residual subtraction.\nFig. 15 shows 3 versions of the composite spectrum, focusing\non the rest-frame wavelength region that derives from observedframe wavelengths \u03bb > 6700 \u00c5. The 3 versions of the composite were calculated using quasar spectra without sky-residual sub-\n\ntraction (bottom), with sky-residual subtraction (middle) and with\nsky-residual subtraction and the absorption features masked. The\nabsorption-line mask consisted of 14 \u00c5 intervals, in the absorber\nrest-frame, centered on each absorption line.\nAbsorption-line equivalent widths (EWs) are measured in the\nabsorber rest-frame, using the method of Section 4.1. Table 2 includes the EWs of the absorption features in the 3 composite spectra, together with the wavelength intervals used in the line and continuum measurement. For each composite the same continuum is\nused for measuring EWs, in this case calculated from the spectrum with lines masked, although in practice any consistent continuum would suffice. The sky-residual subtracted composite, with\nmasking of absorption lines, provides the best reference. As expected, the EWs of several of the absorption lines in the unmasked\ncomposite are systematically reduced. However, the illustration is\na \"worst case\" example of the sky-residual subtraction scheme involving only a single iteration. A second application of the skyresidual subtraction using a mask based on the identification of features following the first application, offers the prospect of significant improvement in the identification and measurement of features\nat initially unknown wavelengths.\n\n4.3 Composite quasar spectra\nPoor sky subtraction affects most those spectra with low S/N, and\nthe fainter quasars, including those at high redshift (z > 4), suffer\nfrom significant contamination from sky subtraction residuals. The\nextended wavelength range of the SDSS spectra combined with a\nredshift range for the quasars of z \u2243 0 \u2212 5, allows the construction of composite spectra over unprecedented ranges in rest-frame\nwavelength and luminosity (vanden Berk et al. 2004). However, the\nnumber of quasars that occupy the extremes of the wavelength and\nluminosity ranges is relatively small and the sky subtraction residuals at \u03bb > 6700 \u00c5 limit both the determination of the continuum\nproperties and the detection of weak emission features. We create\ncomposite spectra of all quasars in the SDSS with z > 4.1, in redshift slices of \u2206z = 0.1. Each input quasar spectrum is normalised\nto have a mean flux of 1 between 1250 \u2212 1600 \u00c5, prior to combination using an arithmetic mean. Fig. 16 illustrates how the skyresidual subtraction technique improves the quality of these composites. Subtracting the underlying spectrum using a median filter\nand removing the centers of emission lines from the calculation,\nwe calculate the error weighted absolute deviation from zero on\nthe composites with and without sky-residual subtraction. The average improvement in S/N over the entire wavelength region due to\nthe sky subtraction is about 20% for all redshift bins.\n\n5 SUMMARY\nThe SDSS spectra represent a vast improvement in data quantity,\nquality and wavelength coverage over previous surveys. The skysubtraction carried out by the SDSS reduction pipeline has in general achieved excellent results, however the common problem of\nthe subtraction of undersampled OH emission lines results in substantial systematic residuals over almost half the spectral range. A\ntechnique is presented to remove these residual OH features, based\non a principal component analysis of the observed-frame sky spectra which have been sky subtracted along with all other spectra in\nthe SDSS data releases. The scheme takes advantage of the high\ndegree of correlation between the residuals in order to produce corc 0000 RAS, MNRAS 000, 000\u2013000\n\n\fPeering through the OH-forest\n\n15\n\nFigure 14. Composite spectrum of 68 DLAs identified in the SDSS-DR1 by Prochaska & Herbert-Fort (2004), before (lower) and after (upper) sky-residual\nsubtraction. The absorption features were masked prior to sky-residual subtraction. No attempt was made to remove the underlying composite quasar spectrum.\n\nFigure 15. Composite spectra of 63 DLA systems showing the rest-frame wavelength range 2000 \u2212 2850 \u00c5 that includes strong absorption features due to Mg\nand Fe. The 3 spectra show the composite before sky-residual subtraction (lower), after sky-residual subtraction with absorption features unmasked (middle),\nand with absorption features masked (upper).\n\nc 0000 RAS, MNRAS 000, 000\u2013000\n\n\f16\n\nV. Wild & P. Hewett\n\nTable 2. Equivalent widths of absorption features in a composite of 68 SDSS-DR1 DLAs before and after sky residual subtraction: (a) absorption features\nunmasked; (b) 14 \u00c5 around absorption features masked. Wavelengths of continuum and measurement regions are given, together with the number of spectra\nwhere the wavelength of the line falls between 6700 and 9180 \u00c5, therefore contributing to the composite.\n\nLine ID\n\nN\n\ncont1\n\ncont2\n\nline\n\nbefore\n\naftera\n\nafterb\n\nFeII[2344.9]\nFeII[2375.2]\nFeII[2383.5]\nMgII[2796.4]\nMgII[2803.5]\n\n47\n46\n45\n11\n10\n\n2327,2337\n2357,2367\n2357,2367\n2760,2790\n2760,2790\n\n2353,2363\n2392,2402\n2392,2402\n2810,2825\n2810,2825\n\n2340.9,2347.9\n2371.2,2378.7\n2379.0,2386.5\n2792.0,2799.5\n2799.5,2807.0\n\n-0.65\n-0.50\n-0.68\n-1.89\n-1.75\n\n-0.58\n-0.44\n-0.62\n-1.71\n-1.55\n\n-0.66\n-0.54\n-0.66\n-1.81\n-1.73\n\nFigure 16. Composite spectra of z \u223c 4 quasars including the SiIV+OIV \u03bb1400 and CIV \u03bb1549 emission lines. The observed-frame spectra fall at wavelengths\n\u03bb > 6700 \u00c5. For each pair of spectra, the lower composite is created directly from the SDSS spectra, and the upper composite from the same spectra after\nsubtracting sky residuals. From bottom to top the composites consist of 41, 35, 24 and 20 spectra and the improvement in error weighted absolute deviation\nfrom the underlying spectrum (see text) is 23%, 17%, 17% and 18%.\n\nrected spectra whose noise properties are very close to the limit set\nby counting statistics.\nThe sky-residual subtraction scheme is applied to the SDSS\nDR2 catalogue and is immediately applicable to the recent SDSS\nDR3 release. The precise form of the implementation depends on\nthe spectral energy distributions of the target objects and the scientific goal of any analysis. As a consequence, the main classes of\ntarget objects, galaxies, quasars and stars, are treated slightly differently. Constructing composites of high-redshift quasars before\nand after sky-residual subtraction illustrates the significant increase\nin the overall S/N of the spectra that is achieved. The application\nof the procedure when narrow absorption or emission features are\npresent requires the use of a mask to prevent the sky-subtraction\nscheme suffering from bias. Both the calcium-triplet in low redshift galaxies and metal absorption lines in damped Ly\u03b1 systems\nat high redshifts fall in the wavelength range affected by the OHforest (6700 \u2212 9200 \u00c5). By employing these two rather different\n\nexamples it is shown that masking absorption and emission features prior to the reconstruction of the sky-residual signal in each\nspectrum ensures that the properties of the features themselves are\nnot systematically biased in the resulting sky-residual subtracted\nspectra.\nThe significant improvement in S/N achieved over some\n2000 \u00c5 of a large fraction of SDSS spectra, particularly for the\nfainter objects such as the high-redshift quasars, should benefit\na wide range of scientific investigations. We have made available datafiles, IDL code and a comprehensive guide on using the\ncode, with which the procedure can be applied to all SDSS spectra\n(http://www.ast.cam.ac.uk/research/downloads\n/code/vw/). Further improvements should be possible if the skyresidual subtraction procedure is adapted to run on the SDSS spectra using the original noise arrays based on counting statistics alone.\nThe nature of the sky-residual subtraction scheme is such that apc 0000 RAS, MNRAS 000, 000\u2013000\n\n\fPeering through the OH-forest\nplication to other large samples of spectra should be relatively\nstraightforward.\n\nACKNOWLEDGEMENTS\nMany thanks to Eric Switzer, David Schlegel and Patrick McDonald of the SDSS team who made available information and answered questions about the SDSS spectroscopic reduction pipeline.\nWe would also like to thank the referee, Simon Morris, for his\ncareful reading of the manuscript and helpful comments and suggestions. VW acknowledges the award of a PPARC research studentship.\nFunding for the Sloan Digital Sky Survey (SDSS) has been\nprovided by the Alfred P. Sloan Foundation, the Participating Institutions, the National Aeronautics and Space Administration,\nthe National Science Foundation, the U.S. Department of Energy,\nthe Japanese Monbukagakusho, and the Max Planck Society. The\nSDSS Web site is http://www.sdss.org/.\nThe SDSS is managed by the Astrophysical Research Consortium (ARC) for the Participating Institutions. The Participating Institutions are The University of Chicago, Fermilab, the Institute for Advanced Study, the Japan Participation Group, The Johns\nHopkins University, Los Alamos National Laboratory, the MaxPlanck-Institute for Astronomy (MPIA), the Max-Planck-Institute\nfor Astrophysics (MPA), New Mexico State University, University\nof Pittsburgh, Princeton University, the United States Naval Observatory, and the University of Washington.\n\nReferences\nAbazajian K., Adelman-McCarthy J. K., Ag\u00fceros M. A., et al. (the\nSDSS collaboration), 2004a, AJ, 128, 502\nAbazajian K., Adelman-McCarthy J. K., Ag\u00fceros M. A., et al. (the\nSDSS collaboration), 2004b, preprint (astro-ph/0410239)\nBolton A. S., Burles S., Schlegel D. J., Eisenstein D. J., Brinkmann\nJ., 2004, AJ, 127, 1860\nConnolly A. J., Szalay A. S., 1999, AJ, 117, 2052\nConnolly A. J., Szalay A. S., Bershady M. A., Kinney A. L.,\nCalzetti D., 1995, AJ, 110, 1071\nDiaz A. I., Terlevich E., Terlevich R., 1989, MNRAS, 239, 325\nDressler A., 1984, ApJ, 286, 97\nEfstathiou G., Fall S. M., 1984, MNRAS, 206, 453\nFolkes S. R., Lahav O., Maddox S. J., 1996, MNRAS, 283, 651\nFrancis P. J., Hewett P. C., Foltz C. B., Chaffee F. H., 1992, ApJ,\n398, 476\nHewett P. C., Irwin M. J., Bunclark P., Bridgeland M. T., Kibblewhite E. J., He X. T., Smith M. G., 1985, MNRAS, 213, 971\nKelson D. D., 2003, PASP, 115, 688\nKendall M. G., 1975, Multivariate Analysis. Griffen, London\nKurtz M. J., Mink D. J., 2000, ApJL, 533, L183\nMadgwick D. S., Coil A. L., Conselice C. J., Cooper M. C., Davis\nM., Ellis R. S., Faber S. M., Finkbeiner D. P., Gerke B.,\nGuhathakurta P., Kaiser N., Koo D. C., Newman J. A., Phillips\nA. C., Steidel C. C., Weiner B. J., Willmer C. N. A., Yan R.,\n2003, ApJ, 599, 997\nMadgwick D. S., Lahav O., Baldry I. K., et al. (the 2dFGRS team)\n2002, MNRAS, 333, 133\nMurtagh F., Heck A., 1987, Multivariate data analysis. Astrophysics and Space Science Library, Dordrecht: Reidel, 1987\nc 0000 RAS, MNRAS 000, 000\u2013000\n\n17\n\nNewman R. N., Long D. C., Snedden S. A., et al. (for the SDSS\ncollaboration), 2004, preprint (astro-ph/0408167)\nProchaska J. X., Herbert-Fort S., 2004, PASP, 116, 622\nRutledge G. A., Hesser J. E., Stetson P. B., Mateo M., Simard L.,\nBolte M., Friel E. D., Copin Y., 1997, PASP, 109, 883\nStoughton C., Lupton R. H., Bernardi M., et al. (the SDSS collaboration), 2002, AJ, 123, 485\nTerlevich E., Diaz A. I., Terlevich R., 1990, MNRAS, 242, 271\nvanden Berk D., Yip C., Connolly A., Jester S., Stoughton C., 2004,\nin ASP Conference Series, Volume 311 p. 21\nWhitney C. A., 1983, AAPS, 51, 443\nYip C. W., Connolly A. J., Szalay A. S., Budav\u00e1ri T., SubbaRao\nM., Frieman J. A., Nichol R. C., Hopkins A. M., York D. G.,\nOkamura S., Brinkmann J., Csabai I., Thakar A. R., Fukugita\nM., Ivezi\u0107 \u017d., 2004a, AJ, 128, 585\nYip C. W., Connolly A. J., Vanden Berk D. E., Ma Z., Frieman\nJ. A., SubbaRao M., Szalay A. S., Richards G. T., Hall P. B.,\nSchneider D. P., Hopkins A. M., Trump J., Brinkmann J.,\n2004b, AJ, 128, 2603\nYork D. G., Adelman J., Anderson J. E., et al. (the SDSS collaboration), 2000, AJ, 120, 1579\n\nAPPENDIX A: PRINCIPAL COMPONENT ANALYSIS\nFor completeness we include the basic mathematics of PCA. Further details can be found in Kendall (1975) and, for astronomical\napplications, in Efstathiou & Fall (1984) and Murtagh & Heck\n(1987). For an N spectra by M pixel data array {Xij }, where\n1 6 i 6 N , j > 1 and k 6 M , the covariance matrix is\nCjk =\n\nN\n1 X\nXij Xik .\nN\n\n(A1)\n\ni=1\n\nThe eigenvectors (e, principal components in the language of this\npaper) and eigenvalues (\u03bb) of the covariance matrix are\nCej = \u03bbj ej .\n\n(A2)\n\nIt can be shown that e1 is the axis along which the variance is maximal, e2 is the axis with second greatest variance, and so on until\neM has the least variance. The principal component amplitudes for\neach noise weighted input spectrum f are given by\naj = f * ej .\n\n(A3)\n\nThe M eigenvectors can be used as a basis set on which to\nproject any spectrum of the same dimensions. The principal component amplitudes of this projection and the eigenvectors can then\nreconstruct the input spectrum from the templates:\nfk =\n\nM\nX\n\naj ejk .\n\n(A4)\n\nj=1\n\nThe reconstructed spectrum only contains information present in\nthe templates, which may or may not be a fair representation of\nthe input spectrum. In general as the variance of the eigenvectors\ndecrease, so does the useful information contained in the spectra,\nallowing PCA to be a useful form of data compression. The exact\nnumber of eigenvectors required to reconstruct the input spectrum\nsatisfactorily depends on the dataset and purpose of the analysis.\n\n\f"}