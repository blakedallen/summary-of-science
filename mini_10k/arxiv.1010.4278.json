{"id": "http://arxiv.org/abs/1010.4278v1", "guidislink": true, "updated": "2010-10-20T19:07:01Z", "updated_parsed": [2010, 10, 20, 19, 7, 1, 2, 293, 0], "published": "2010-10-20T19:07:01Z", "published_parsed": [2010, 10, 20, 19, 7, 1, 2, 293, 0], "title": "A patch that imparts unconditional stability to certain explicit\n  integrators for SDEs", "title_detail": {"type": "text/plain", "language": null, "base": "http://export.arxiv.org/api/query?search_query=&id_list=1010.1073%2C1010.1822%2C1010.5881%2C1010.1614%2C1010.2524%2C1010.0844%2C1010.3803%2C1010.3314%2C1010.5085%2C1010.1508%2C1010.5185%2C1010.5298%2C1010.4083%2C1010.2817%2C1010.2924%2C1010.3345%2C1010.3767%2C1010.4653%2C1010.5760%2C1010.5012%2C1010.2019%2C1010.3523%2C1010.3287%2C1010.2322%2C1010.6082%2C1010.5983%2C1010.3834%2C1010.1324%2C1010.3741%2C1010.0754%2C1010.3721%2C1010.1477%2C1010.4789%2C1010.1378%2C1010.4704%2C1010.1951%2C1010.1916%2C1010.5097%2C1010.5316%2C1010.0051%2C1010.1375%2C1010.4278%2C1010.0124%2C1010.3804%2C1010.3093%2C1010.3279%2C1010.1290%2C1010.3095%2C1010.1906%2C1010.5063%2C1010.5125%2C1010.3594%2C1010.3790%2C1010.4757%2C1010.4811%2C1010.3284%2C1010.5171%2C1010.1950%2C1010.2299%2C1010.3422%2C1010.5979%2C1010.3131%2C1010.0735%2C1010.5082%2C1010.5858%2C1010.0254%2C1010.0472%2C1010.2111%2C1010.0485%2C1010.5061%2C1010.5700%2C1010.5972%2C1010.2256%2C1010.0407%2C1010.5098%2C1010.1516%2C1010.3087%2C1010.2000%2C1010.4282%2C1010.5685%2C1010.1080%2C1010.1569%2C1010.3038%2C1010.1892%2C1010.6058%2C1010.5923%2C1010.6194%2C1010.6125%2C1010.5450%2C1010.5798%2C1010.0307%2C1010.6047%2C1010.2913%2C1010.3532%2C1010.3278%2C1010.4300%2C1010.3432%2C1010.1047%2C1010.3603%2C1010.3561%2C1010.4605&start=0&max_results=1000&sortBy=relevance&sortOrder=descending", "value": "A patch that imparts unconditional stability to certain explicit\n  integrators for SDEs"}, "summary": "This paper proposes a simple strategy to simulate stochastic differential\nequations (SDE) arising in constant temperature molecular dynamics. The main\nidea is to patch an explicit integrator with Metropolis accept or reject steps.\nThe resulting `Metropolized integrator' preserves the SDE's equilibrium\ndistribution and is pathwise accurate on finite time intervals. As a corollary\nthe integrator can be used to estimate finite-time dynamical properties along\nan infinitely long solution. The paper explains how to implement the patch\n(even in the presence of multiple-time-stepsizes and holonomic constraints),\nhow it scales with system size, and how much overhead it requires. We test the\nintegrator on a Lennard-Jones cluster of particles and `dumbbells' at constant\ntemperature.", "summary_detail": {"type": "text/plain", "language": null, "base": "http://export.arxiv.org/api/query?search_query=&id_list=1010.1073%2C1010.1822%2C1010.5881%2C1010.1614%2C1010.2524%2C1010.0844%2C1010.3803%2C1010.3314%2C1010.5085%2C1010.1508%2C1010.5185%2C1010.5298%2C1010.4083%2C1010.2817%2C1010.2924%2C1010.3345%2C1010.3767%2C1010.4653%2C1010.5760%2C1010.5012%2C1010.2019%2C1010.3523%2C1010.3287%2C1010.2322%2C1010.6082%2C1010.5983%2C1010.3834%2C1010.1324%2C1010.3741%2C1010.0754%2C1010.3721%2C1010.1477%2C1010.4789%2C1010.1378%2C1010.4704%2C1010.1951%2C1010.1916%2C1010.5097%2C1010.5316%2C1010.0051%2C1010.1375%2C1010.4278%2C1010.0124%2C1010.3804%2C1010.3093%2C1010.3279%2C1010.1290%2C1010.3095%2C1010.1906%2C1010.5063%2C1010.5125%2C1010.3594%2C1010.3790%2C1010.4757%2C1010.4811%2C1010.3284%2C1010.5171%2C1010.1950%2C1010.2299%2C1010.3422%2C1010.5979%2C1010.3131%2C1010.0735%2C1010.5082%2C1010.5858%2C1010.0254%2C1010.0472%2C1010.2111%2C1010.0485%2C1010.5061%2C1010.5700%2C1010.5972%2C1010.2256%2C1010.0407%2C1010.5098%2C1010.1516%2C1010.3087%2C1010.2000%2C1010.4282%2C1010.5685%2C1010.1080%2C1010.1569%2C1010.3038%2C1010.1892%2C1010.6058%2C1010.5923%2C1010.6194%2C1010.6125%2C1010.5450%2C1010.5798%2C1010.0307%2C1010.6047%2C1010.2913%2C1010.3532%2C1010.3278%2C1010.4300%2C1010.3432%2C1010.1047%2C1010.3603%2C1010.3561%2C1010.4605&start=0&max_results=1000&sortBy=relevance&sortOrder=descending", "value": "This paper proposes a simple strategy to simulate stochastic differential\nequations (SDE) arising in constant temperature molecular dynamics. The main\nidea is to patch an explicit integrator with Metropolis accept or reject steps.\nThe resulting `Metropolized integrator' preserves the SDE's equilibrium\ndistribution and is pathwise accurate on finite time intervals. As a corollary\nthe integrator can be used to estimate finite-time dynamical properties along\nan infinitely long solution. The paper explains how to implement the patch\n(even in the presence of multiple-time-stepsizes and holonomic constraints),\nhow it scales with system size, and how much overhead it requires. We test the\nintegrator on a Lennard-Jones cluster of particles and `dumbbells' at constant\ntemperature."}, "authors": ["Nawaf Bou-Rabee", "Eric Vanden-Eijnden"], "author_detail": {"name": "Eric Vanden-Eijnden"}, "author": "Eric Vanden-Eijnden", "arxiv_comment": "29 pages, 5 figures", "links": [{"href": "http://arxiv.org/abs/1010.4278v1", "rel": "alternate", "type": "text/html"}, {"title": "pdf", "href": "http://arxiv.org/pdf/1010.4278v1", "rel": "related", "type": "application/pdf"}], "arxiv_primary_category": {"term": "math.NA", "scheme": "http://arxiv.org/schemas/atom"}, "tags": [{"term": "math.NA", "scheme": "http://arxiv.org/schemas/atom", "label": null}, {"term": "math.PR", "scheme": "http://arxiv.org/schemas/atom", "label": null}, {"term": "82C80 (65C30, 65C05, 65P10)", "scheme": "http://arxiv.org/schemas/atom", "label": null}], "pdf_url": "http://arxiv.org/pdf/1010.4278v1", "affiliation": "None", "arxiv_url": "http://arxiv.org/abs/1010.4278v1", "journal_reference": null, "doi": null, "fulltext": "arXiv:1010.4278v1 [math.NA] 20 Oct 2010\n\nA patch that imparts unconditional stability\nto certain explicit integrators for SDEs\nNawaf Bou-Rabee\u2217\n\nEric Vanden-Eijnden\u2020\n\nOctober 31, 2018\n\nAbstract\nThis paper proposes a simple strategy to simulate stochastic differential\nequations (SDE) arising in constant temperature molecular dynamics. The\nmain idea is to patch an explicit integrator with Metropolis accept or reject\nsteps. The resulting 'Metropolized integrator' preserves the SDE's equilibrium distribution and is pathwise accurate on finite time intervals. As a\ncorollary the integrator can be used to estimate finite-time dynamical properties along an infinitely long solution. The paper explains how to implement\nthe patch (even in the presence of multiple-time-stepsizes and holonomic\nconstraints), how it scales with system size, and how much overhead it requires. We test the integrator on a Lennard-Jones cluster of particles and\n'dumbbells' at constant temperature.\n\nKeywords molecular dynamics, Metropolis-Hastings, Verlet, RATTLE, RESPA\nAMS Subject Classification 82C80 (65C30, 65C05, 65P10)\n\u2217\nCourant Institute of Mathematical Sciences, New York University, 251 Mercer Street, New\nYork, NY 10012-1185 (nawaf@cims.nyu.edu). N. B-R. was supported by NSF Fellowship #\nDMS-0803095.\n\u2020\nCourant Institute of Mathematical Sciences, New York University, 251 Mercer Street, New\nYork, NY 10012-1185 (eve2@cims.nyu.edu). The work of E. V.-E. was supported in part by\nNSF grants DMS-0718172 and DMS-0708140, and ONR grant N00014-04-1-6046.\n\n1\n\n\f1\n\nIntroduction\n\nMotivation Since Loup Verlet's landmark paper in 1967, the classical Verlet\nalgorithm has been the main workhorse for constant energy molecular dynamics [53]. It is an attractive algorithm for the Hamiltonian ODEs that arise in this\ncontext because of its explicit, time-reversible, and symplectic nature. In particular, symplecticity implies long time stability of the Verlet algorithm. The usual\nproof of this statement uses backward error analysis to show that level sets of a\nnearby Hamiltonian function interpolate Verlet trajectories [4, 36, 37]. This property implies that a Verlet trajectory is confined to these level sets for the duration\nof the simulation. As a consequence a Verlet integrator nearly preserves the true\nenergy and exhibits linear growth in global error. Versions of Verlet to constrained\n(RATTLE) and multiscale (RESPA) Hamiltonian systems are also available. For\nthese reasons Verlet integrators are well-suited for long time simulation of constant energy molecular dynamics.\nThe situation is quite different in the context of constant temperature molecular dynamics. A molecular system at constant temperature visits every energy\nisosurface with nonzero probability and its evolution is typically modeled using\nergodic stochastic differential equations (SDE). In contrast to their deterministic\ncounterpart, explicit integrators for SDEs diverge from the equilibrium behavior\nof the true solution [9]. This divergence is easy to understand since explicit integrators are only conditionally stable. Indeed for any time-stepsize one can find\nan energy above which an explicit integrator is unstable. As a result stochastic\neffects necessarily induce instabilities by driving trajectories to these energy values. Since molecular simulations often involve unbounded potential energy (e.g.,\nLennard-Jones interaction), these energy values are attainable, and this issue calls\nfor new integration strategies for constant temperature molecular dynamics.\nConstant Temperature Molecular Dynamics We briefly recall what it means\nfor a molecular system to be at constant temperature. Consider n molecules with\nmasses mi for i = 1, ..., n evolving in a d-dimensional periodic box (or torus in\n\u03bd = dn dimensions T\u03bd ). Let M represent the diagonal mass matrix of the molecular system. We assume the particle interaction is given by a potential energy\nfunction U : T\u03bd \u2192 R. The Hamiltonian H : T\u03bd \u00d7 R\u03bd \u2192 R of this system can be\nwritten as:\n1\n(1)\nH(q, p) = pT M \u22121 p + U (q) ,\n2\n\n2\n\n\fwhere q \u2208 T\u03bd and p \u2208 R\u03bd represent respectively the positions and momenta of\nthe molecules. In terms of this Hamiltonian, define the probability distribution \u03bc:\nZ\ndef\n\u22121 \u2212\u03b2H(q,p)\ne\u2212\u03b2H(q,p) dqdp .\n(2)\n\u03bc(dq, dp) = Z e\ndqdp\nZ=\nT\u03bd \u00d7R\u03bd\n\nHere we have introduced the parameter \u03b2 which is inversely related to the temperature T and Boltzmann constant kB via \u03b2 = 1/(kB T ).\nA molecular system with Hamiltonian (1) is at constant temperature T if its\ntrajectories sample from the probability distribution (2). The standard way to guarantee that this is indeed the case is to assume that the molecular system follows a\ncontinuous, stochastic dynamics of the form:\n\uf8f1\n\uf8f2 dQ\n= M \u22121 P ,\n(3)\ndt\n\uf8f3dP = \u2212\u2207U (Q)dt + d\u03b7(Q, P ) ,\nwhere d\u03b7 : T\u03bd \u00d7 R\u03bd \u2192 R\u03bd represents a thermostat force. Physically one can\ninterpret the thermostat force as modeling interaction between the molecular system and a heat bath. Mathematically it is essential that the thermostat force\nbe stochastic to ensure that the dynamics of (3) be ergodic with respect to (2).\nSeveral specific forms of the thermostat force have been proposed in the literature [10, 11, 24, 41, 43] and which one is best remains open for debate. This is a\nmodeling question which is beyond the scope of the present paper. Here we assume that the thermostat force is given, and we propose an integration strategy that\ndoes not make strong assumptions on its precise form. In the applications and theory sections of this paper we focus on d\u03b7 given by Langevin dynamics [10,43] and\nin a companion paper [8] consider other thermostats including stochastic rescaling\ndynamics [11,12] and Nos\u00e9-Hoover-Langevin dynamics [24,41]. The assumption\nof continuity excludes, e.g., the Andersen thermostat because it involves discrete\ncollisions at random times that in their wake leave the momentum of the molecular system discontinuous [3]. We refer the reader to [15, 29] for recent progress\nquantifying the mixing properties of the Andersen thermostat for molecular systems.\nThe SDE (3) is characterized by degenerate noise, irregular drift, high-dimensionality (\u03bd is typically very big), and non-well-separated time-scales. In this\ncontext the main aim of numerical methods is to estimate long-time dynamical\nproperties. This calculation is typically done by launching a single run of an\nexplicit integrator and collecting statistics. However, without the patch introduced\nbelow this approach is prone to failure due to numerical instabilities.\n3\n\n\fTo be concrete consider computing the time-correlation in momentum along\nan equilibrium path of the SDE. This computation is common in molecular dynamics and the reader is referred to [2, 18] for expository accounts. Define the\ncontinuous equilibrium correlation in momentum as:\nA(\u03c4 ) = P (\u03c4 + t)T P (t) , (t \u2265 0) , (\u03c4 \u2265 0) ,\n\n(4)\n\nwhere the angle brackets denote a double average with respect to realizations of\n(3) and an initial condition distributed according to (2). The usual way to estimate\nA(\u03c4 ) over a time interval [0, T ] is by a sample average computed on-the-fly using\na single run of an integrator. The numerical equilibrium correlation is defined as\nthe limit as the number of samples tends to \u221e:\n!\nN\nX\n1\nPT\nP bt /hc .\n(5)\nAh (\u03c4 ) = lim\nN \u2192\u221e\nN k=1 b(\u03c4 +tk )/hc k\nThe difficulty is that this limit does not generally exist if the integrator is explicit.\nThis divergence is an established problem with explicit discretizations of SDEs\nthat possess drifts of limited regularity [22, 35, 46].\nProposed Integration Strategy This paper proposes a new integration strategy to solve the SDE (3) based on combining an explicit integrator with Monte\nCarlo methods to sample from the SDE's equilibrium distribution [19, 30, 34].\nThe resulting 'Metropolized integrator' preserves the equilibrium distribution and\nis often provably ergodic. This feature motivates their use as sampling methods [1,13,39,42,44]. In addition, in [9] we showed that a Metropolized integrator\nalso approximates pathwise the SDE's solution on finite-time intervals.\nThese properties ensure that a Metropolized integrator can be used to estimate dynamics along an infinitely long solution of (3). Indeed one can generate a\nlong time trajectory of a Metropolized integrator, and along any finite-time interval update sample averages of dynamic quantities. These averages converge as a\nconsequence of ergodicity of a Metropolized integrator. The averages can also be\nmade arbitrarily close to the true solution's average by selecting the time-stepsize\nsmall enough. For example, a Metropolized integrator can be used to approximate\nto arbitrary precision the equilibrium correlation function A(\u03c4 ). In fact, we show\nin this paper for every T > 0, there exists a C(T ) > 0 such that for h sufficiently\nsmall\nsup |Ah (\u03c4 ) \u2212 A(hb\u03c4 /hc)| \u2264 C(T )h .\n(6)\n\u03c4 \u2208[0,T ]\n\n4\n\n\fThe constant C(T ) increases monotonically with the length of the time-interval\nT . Hence, one cannot use this integrator in situations where T is very large like\nrare event simulation. For such problems the reader is referred to methods adapted\nto molecular systems with rare events such as milestoning [51, 52].\nThe error estimate (6) provides a theoretical order of accuracy of a Metropolized\nintegrator. However, for the strategy to be practical, several questions remain:\n\u2022 what does the patch involve?\n\u2022 is the patch scalable with respect to system size?\n\u2022 does the patch work with RATTLE (Verlet with constraints) [50] or RESPA\n(Verlet with multiple time-step-sizes) [28, 48]?\nThe aim of this paper is to answer these questions. The paper is organized as\nfollows:\n\u00a72 provides step-by-step instructions on how to patch explicit integrators based\non Verlet, RATTLE, and RESPA, and some basic theory explaining why the\npatch works;\n\u00a73 conducts numerical tests on a Lennard-Jones fluid and 'dumbbell' systems;\n\u00a74 contains some conclusions and future improvements.\n\n2\n\nPatch\n\nThe patch involves splicing an explicit integrator with Metropolis steps. We will\nshow that the resulting integrator possesses the following properties:\n(P1) preservation of the SDE's equilibrium distribution; and,\n(P2) pathwise accuracy on finite time-intervals.\nTo illustrate how the patch works, we shall implement it on an explicit integrator\nbased on splitting the SDE (3) into Hamilton's equations:\n\uf8f1\ndQ\n\uf8f4\n\uf8f2\n= M \u22121 P ,\ndt\n(7)\ndP\n\uf8f4\n\uf8f3\n= \u2212\u2207U (Q) ,\ndt\n5\n\n\fand equations describing the effect of the thermostat:\n\uf8f1\n\uf8f2 dQ\n=0,\ndt\n\uf8f3dP = d\u03b7 .\n\n(8)\n\nThe explicit integrator considered is defined as a composition of a step of Verlet\nfor (7) and a step of an approximation to (8) (or vice versa). If Verlet is replaced\nby an implicit method (e.g., implicit Euler), then the splitting will satisfy property (P2). However, due to discretization error, even an implicit integrator will\ngenerally fail to satisfy property (P1) [45\u201347].\nBefore we continue let us introduce some notation. Let \u03a9 = T\u03bd \u00d7 R\u03bd denote\nthe 2\u03bd-dimensional phase space of the molecular system and Y (t) = (Q(t), P (t)) \u2208\n\u03a9 denote the true solution of (3) at time t \u2265 0 with initial condition Y (0) = x \u2208\n\u03a9. In what follows we take for granted that this solution exists for all time.\n\n2.1\n\nExplicit Integrator\n\nGiven a time-stepsize h and time interval T , set the number of steps to be N =\nbT /hc and introduce an evenly-spaced mesh in time tk = hk for all 0 \u2264 k \u2264 N .\nLet \u03c8tk+1 ,tk : \u03a9 \u2192 \u03a9 denote an approximation to the thermostat dynamics (8).\nThis map depends on time because of the stochastic effects in the thermostat. For\nexample, for the Langevin dynamics the thermostat force is given by,\np\nd\u03b7 = \u2212\u03b3M \u22121 P dt + 2\u03b3\u03b2 \u22121 dW ,\nwhere W is a \u03bd-dimensional Wiener process and \u03b3 is a thermostat parameter\n[10, 43]. In this case (8) are Ornstein-Uhlenbeck equations in momentum whose\npathwise unique flow is almost surely:\n\u03c8tk+1 ,tk : (q, p) 7\u2192 (q, e\u2212\u03b3M\n\n\u22121\n\nh\n\np + \u03b7 tk+1 ,tk ) ,\n\n(9)\n\nwhere we have introduced the random vector:\nZ tk+1\np\n\u22121\n\u22121\ne\u2212\u03b3M (tk+1 \u2212s) dW (s) .\n\u03b7 tk+1 ,tk = 2\u03b3\u03b2\ntk\n\nThe map \u03c8tk+1 ,tk satisfies property (P1). For other SDE-based thermostats an\napproximate map that satisfies (P1) can be similarly constructed. Notice that this\nmap does not alter the positions of the molecular system.\n6\n\n\fWe introduce a second map \u03b8\u0302h : \u03a9 \u2192 \u03a9 which approximates (7). Since the\nHamiltonian is time-independent, this map depends only on the time-stepsize h =\ntk+1 \u2212 tk . The patch we introduce below will require that this map is symmetric\nand volume-preserving [20, 25]. An explicit integrator for (3) is then given by:\n\u03c6\u0302tk+1 ,tk = \u03c8tk+1 ,tk \u25e6 \u03b8\u0302h .\n\n(10)\n\nThe order in (10) does not matter since the integrator's single step accuracy is\nO(h2 ) either way. Higher-order accurate or implicit schemes can also be patched,\nbut such integrators may require more computational effort per step. To ensure\nscalability the map \u03b8\u0302h in (10) will use Verlet to separately update sets of particles\nof the molecular system.\nTo this end we partition the molecular\nP system into m sets of particles so that\neach set has \u03bdj degrees of freedom and m\nj=1 \u03bdj = \u03bd. Given a time stepsize h and\ninitial condition x \u2208 \u03a9, a single step of (10) is defined as:\nX\u0302 1 = \u03c8t1 ,t0 \u25e6 \u03b8\u0302h,m \u25e6 * * * \u25e6 \u03b8\u0302h,1 (x)\n{z\n}\n|\n\n(11)\n\n\u03b8\u0302h\n\nThis update gives a numerical approximation to Y (h), X\u0302 1 \u2248 Y (h). The map\n\u03b8\u0302h,j is defined as a Verlet update of the position and momentum of the jth set of\nmolecules fixing the other sets. More precisely given an input\nx0 = ((q 1 , * * * , q m ), (p1 , * * * , pm )) ,\nwhere (q j , pj ) \u2208 T\u03bdj \u00d7 R\u03bdj , the map \u03b8\u0302h,j outputs\n\u03b8\u0302h,j (x0 ) = ((q 1 , * * * , q j\u22121 , q\u0302 j , q j+1 , * * * , q m ), (p1 , * * * , pj\u22121 , p\u0302j , pj+1 , * * * , pm )) .\nHere:\n\uf8f1\n\uf8f4\n\uf8f2p\u0302j, 21\nq\u0302 j\n\uf8f4\n\uf8f3\np\u0302j\n\n= pj \u2212 h2 \u2207Qj U (q 1 , * * * , q m ) ,\n= q j + hM \u22121\nj p\u0302j, 1 ,\n2\n\n= p\u0302j, 1 \u2212\n2\n\nh\n\u2207 U (q 1 , * * *\n2 Qj\n\n(12)\n\n, q j\u22121 , q\u0302 j , q j+1 , * * * , q m ) ,\n\nwhere M j is the subset of the global mass matrix M associated to the jth set of\nparticles.\nThe map \u03b8\u0302h,j is symmetric and volume-preserving on \u03a9 since it is a Verlet\nupdate with respect to the Hamiltonian (1) restricted to:\n{q 1 } \u00d7 * * * \u00d7 {q j\u22121 } \u00d7 (T\u03bdj ) \u00d7 {q j+1 } \u00d7 * * * \u00d7 {q m }\u00d7\n\n{p1 } \u00d7 * * * \u00d7 {pj\u22121 } \u00d7 (R\u03bdj ) \u00d7 {pj+1 } \u00d7 * * * \u00d7 {pm } \u2282 \u03a9 .\n7\n\n\fEven though the composite map \u03b8\u0302h is a first-order splitting of (7), the one-step\nerror of \u03b8\u0302h,j in preserving energy is O(h3 ) because each of the separate Verlet\nupdates is second-order accurate.\n\n2.2\n\nMetropolized Integrator\n\nTo derive an integrator that satisfies property (P1), we patch the explicit integrator\n(11) with Metropolis accept or reject steps as follows. Given the time-stepsize h,\nthe initial condition x \u2208 \u03a9, and the uniform random numbers \u03b6j \u223c U (0, 1) for\n1 \u2264 j \u2264 m, one step of a Metropolized Verlet integrator determines X 1 \u2248 Y (h)\nusing:\n(13)\nX 1 = \u03c8t1 ,t0 \u25e6 \u03b8h,m \u25e6 * * * \u25e6 \u03b8h,1 (x) .\n{z\n}\n|\n\u03b8h\n\nHere we have introduced the stochastic maps \u03b8h,j : \u03a9 \u2192 \u03a9 which are Metropolized\nversions of the deterministic updates \u03b8\u0302h,j . Given input\nx0 = ((q 1 , * * * , q m ), (p1 , * * * , pm )) ,\nthe map \u03b8h,j computes a proposed move\nx?1 = ((q 1 , * * * , q j\u22121 , q ?j , q j+1 , * * * , q m ), (p1 , * * * , pj\u22121 , p?j , pj+1 , * * * , pm )) .\nusing a Verlet update\n\uf8f1\n\uf8f4\np?\n= pj \u2212 h2 \u2207Qj U (q 1 , * * * , q m ) ,\n\uf8f4\n\uf8f2 j, 21\n?\nq ?j\n= q j + hM \u22121\nj pj, 1 ,\n2\n\uf8f4\n\uf8f4\nh\n?\n?\n\uf8f3p ?\n=\np\n\u2212\n\u2207\nU\n(q\n1\nQ\n1 , * * * , q j\u22121 , q j , q j+1 , * * * , q m ) ,\nj\nj\n2\nj,\n\n(14)\n\n2\n\nand accepts this proposed move with probability\n1 \u2227 exp(\u2212\u03b2[H(x?1 ) \u2212 H(x0 )]) .\n\n(15)\n\nIf this proposal is rejected the momentum is reversed. To summarize\n\u03b8h,j : x0 7\u2192 x1 ,\nwith output x1 defined as\nx1 = ((q 1 , * * * , q j\u22121 , q\u0304 j , q j+1 , * * * , q m ), (p1 , * * * , pj\u22121 , p\u0304j , pj+1 , * * * , pm )) .\n8\n\n\fwhere\n(\n(q ?j , p?j )\n(q\u0304 j , p\u0304j ), =\n(q j , \u2212pj )\n\nif \u03b6j < 1 \u2227 exp(\u2212\u03b2[H(x? ) \u2212 H(x)]) ,\notherwise .\n\n(16)\n\nThe patch we propose consists of an accept or reject step like (16). It requires\nevaluating the total energy at the current step and at the proposed moves. These\nstatistics are usually computed alongside evaluations of the force field. When a\nproposed move is rejected, the momentum of the jth set of particles is reversed.\nWhile these rejections ensure the integrator is unconditionally stable and preserves\nthe SDE's equilibrium distribution, they cause an O(1) error in accuracy due to\nmomentum reversals. Next we consider the effect of these rejections and momentum reversals on the approximation to the dynamics of the SDE.\n\n2.3\n\nQuantitative Error Estimates\n\nConsider once more the Hamiltonian of the molecular system:\n1\nH(q, p) = pT M \u22121 p + U (q)\n2\n\n(17)\n\nwhere q \u2208 T\u03bd and p \u2208 R\u03bd represent a configuration and momentum of the molecular system, respectively. For simplicity, we will assume the thermostat dynamics\nis given by Langevin [10, 43]:\n(\ndQ\n= M \u22121 P ,\ndt\np\n(18)\ndP = \u2212\u2207U (Q)dt \u2212 \u03b3M \u22121 P dt + 2\u03b3\u03b2 \u22121 dW ,\nwhere \u03b3 is a thermostat parameter, \u03b2 is the 'inverse temperature' entering the\ndistribution (2), and W is a \u03bd-dimensional Wiener process. The theory below\nwill rely on the following regularity of the potential energy.\nAssumption 2.1. The potential energy U : T\u03bd \u2192 R is smooth.\nRemark 2.2. This assumption does not permit the potential force to have singularities. For example, it holds for Morse potential interactions, but not Lennard-Jones\ninteractions. One can relax this requirement by replacing smoothness of U by\nsome coercivity.\n\n9\n\n\fLet E\u03bc denote expectation conditioned on the initial distribution being the\nequilibrium distribution of the SDE (18):\nZ\n\u03bc\nEx (g(X k )) \u03bc(dx), X 0 = x \u2208 \u03a9 .\nE (g(X k )) =\n\u03a9\n\nThe following theorem states that the Metropolized integrator satisfies property\n(P2).\nTheorem 2.3. Assume 2.1. For every T > 0, there exist positive constants hc and\nC(T ) such that,\n\u0010 n\no\u00111/2\n2\nE\u03bc X bt/hc \u2212 Y (hbt/hc)\n\u2264 C(T )h ,\nfor all h < hc and t \u2208 [0, T ].\nA proof of this result relies on single-step accuracy and bounds on moments\nof the Metropolized integrator (see [9]). These bounds help to boost the singlestep error estimate to a global error estimate, and hence, pathwise convergence\non finite time-intervals. The Metropolized integrator initiated from equilibrium\nsatisfies such bounds as a consequence of property (P1).\nTheorem 2.3 does not require that the Metropolized integrator be ergodic, but\nonly that it preserves the equilibrium distribution. For this reason one can extend\nthis result to Metropolis-adjusted discretizations of other SDE-based thermostats.\nErgodicity is technically difficult to establish when the thermostat force is a nonlinear function of the state or highly degenerate (see, e.g., [24]). However, for\nLangevin dynamics (18) with linear friction and additive noise on all momenta,\nergodicity is straightforward to establish for the Metropolized integrator.\nTheorem 2.4 (Ergodicity). Assume 2.1. For all h > 0, observables g : \u03a9 \u2192 R,\nand initial conditions x \u2208 \u03a9,\nZ\nZ\n1 T\ng(X bt/hc )dt =\ng(x)\u03bc(dx).\nlim\nT \u2192\u221e T 0\n\u03a9\nwhere X 0 = x.\nProof. This proof is terse. We prove this statement for the Metropolized integrator based on a trivial partition of the molecular system. For more details please\nsee [9] and references therein. The Metropolized integrator by construction satisfies property (P1). Moreover, its acceptance probability is strictly less than one\n10\n\n\feverywhere, and the integrator without accept or reject steps admits a smooth transition density when sampled every other step. These two observations imply that\nthe smooth part of the two-step transition probability of the Metropolized integrator is supported everywhere, and hence, the chain is irreducible. Irreducibility and\nproperty (P1) together imply ergodicity [33].\nTheorems 2.3 and 2.4 are sufficient to establish that the Metropolized integrator can estimate dynamics along equilibrium trajectories of (18). For example, as\na corollary to the above theorems one can prove that the Metropolized integrator\ncan be used to compute equilibrium correlation functions.\nCorollary 2.5. Assume 2.1. For every T > 0 there exist positive constants hc and\nC(T ) such that\n|Ah (\u03c4 ) \u2212 A(hb\u03c4 /hc)| \u2264 C(T )h ,\nfor all h < hc and \u03c4 \u2208 [0, T ].\n\nA proof of this result is provided in the Appendix.\n\n2.4\n\nCase of Multiple-Time-Stepsizes\n\nNow we present an implementation of the patch to an explicit integrator for (3)\nbased on a multiple-time-stepsize integrator known as RESPA [28, 48]. RESPA\nwas proposed for molecular systems at constant energy in [49]. This integrator\nis a version of Verlet adapted to molecular systems with multiple time scales. It\nis designed to overcome a time-stepsize restriction imposed by rapidly changing\nshort-range interactions. The scheme evaluates short-range forces on a smaller\ntime-stepsize, and hence, more frequently than long-range forces. The overall\naccuracy of the algorithm is dictated by the largest time-stepsize. For Hamiltonian\nODEs RESPA is known to exhibit resonance instabilities as described in [17]. The\nresonance occurs between forces evaluated at the coarse time-stepsize and the\nnormal modes of the molecular system excluding long-range interactions. These\nnumerical instabilities also appear in generalizations of RESPA to Langevin SDEs\n[16,23,31]. In the following we show how to patch such a generalization to tackle\nsuch instabilities.\nAgain we partition the molecularPsystem into m sets of particles so that each\nset has \u03bdi degrees of freedom and m\ni=1 \u03bdi = \u03bd. We assume that the potential\nenergy can be decomposed into fast and slow interactions:\nU (q) = Uslow (q) + Ufast (q) .\n11\n\n\fWe further assume fast and slow potential forces are respectively evaluated at hf\nand h time increments. The small time-stepsize is typically a fraction of the large\ntime-stepsize. The integrator (13) will be used, except that \u03b8h,j is replaced with\na Metropolized version of RESPA that separately updates each element of the\npartition. Given a small time-stepsize hf , large time-stepsize h, and input\nx0 = ((q 1 , * * * , q m ), (p1 , * * * , pm )) .\nSet Nf = bh/hf c. The map \u03b8h,j computes a proposed move\nx?1 = ((q 1 , * * * , q j\u22121 , q ?j , q j+1 , * * * , q m ), (p1 , * * * , pj\u22121 , p?j , pj+1 , * * * , pm )) ,\nusing a RESPA update\n\uf8f1\n\uf8f4\npj, 1 = pj \u2212 h2 \u2207Qj Uslow (q 1 , * * * , q m ) ,\n\uf8f4\n\uf8f4\nNf\n\uf8f4\n\uf8f4\n\uf8f4\n\uf8f4\nq j, 1 = q j\n\uf8f4\n\uf8f4\n\uf8f4\n\uf8f1 Nf\n\uf8f4\n\uf8f4\n\uf8f4\n\uf8f4P j, k+1 = pj, k \u2212 h2f \u2207Qj Ufast (q 1 , * * * , q j\u22121 , q j, k , q j+1 , * * * , q m ) ,\n\uf8f4\n\uf8f2 \uf8f4\n\uf8f4\nNf\nNf\nNf\n\uf8f2\n\u22121\nq j, k+1 = q j, k + hf M j P j, k+1 ,\n\uf8f4\nNf\nNf\nNf\n\uf8f4\n\uf8f4\n\uf8f4\n\uf8f4\nhf\n\uf8f4\n\uf8f4\n\uf8f4\n\uf8f3\np\n=\nP\n\u2212\n\u2207\nU\nk+1\nk+1\n\uf8f4\nQj fast (q 1 , * * * , q j\u22121 , q j, k+1 , q j+1 , * * * , q m ) ,\nj, N\nj, N\n2\n\uf8f4\nNf\n\uf8f4\nf\nf\n\uf8f4\n\uf8f4\n?\n\uf8f4\nq j = q j,1\n\uf8f4\n\uf8f4\n\uf8f4\n\uf8f3 p? = p \u2212 h \u2207 U (q , * * * , q , q ? , q , * * * , q ) ,\nj,1\nj+1\nm\n1\nj\u22121\nj\nj\n2 Qj slow\nwhere the inner index k runs from 1, * * * , Nf \u22121 (where Nf is the number of steps\ntaken at the small time-stepsize hf ) and the outer index j runs from 1, * * * , m\n(where m is the number of elements in the partition). This proposed move is\naccepted with probability\n1 \u2227 exp(\u2212\u03b2[H(x?1 ) \u2212 H(x0 )]) .\n\n(19)\n\nIf this proposal is rejected the momentum is reversed as before. This generalization of RESPA achieves a speedup when the slow potential force is expensive to\nevaluate relative to the fast potential force.\n\n2.5\n\nCase of Holonomic Constraints\n\nHere we show how to implement the patch to molecular systems with holonomic\nconstraints. Similar issues are treated in [21, 27] from the viewpoint of sampling\n12\n\n\fin the presence of constraints. Again we partition the molecular system with mass\nmatrix\nPm M into m sets of particles so that each set has \u03bdi degrees of freedom and\ni=1 \u03bdi = \u03bd. The main difference to the previous cases is the possibility that the\ndynamics along each element of this partition is not well-defined. For instance,\nif the constraint couples all atoms in the molecule, then only the trivial partition\nwill lead to well-posed dynamics. Or, if the constraint couples pairs of molecules,\nthen only partitions in terms of these pairs are permissible.\nTo rule out this possibility, we assume that the jth set of the partition has an\nassociated scalar constraint function gi : T\u03bd \u2192 R independent from the positions\nof the other sets. The case of vectorial constraints can be handled quite similarly, but for clarity we will consider scalar constraints here. The intersection of\nthe zero level sets of these constraint functions defines the constraint manifold\n\u22121\n\u03a3 = \u2229m\ni=1 gi (0) \u2282 \u03a9. The velocities of the constrained atoms are tangent to\nthis manifold. These observations motivate introducing the set of all constrained\npositions and momenta denoted by T \u03a3 which is known as the cotangent manifold:\nT \u03a3 = {(q, p) \u2208 \u03a9 | gi (q) = 0, \u2207Qi gi (q)T M \u22121\ni pi = 0, i = 1, * * * , m} ,\nwhere M i is the subset of the global mass matrix M associated to the ith set of\nparticles.\nFor a molecular system with constraints, the probability distribution (2) is\nreplaced by:\nZ\ndef\n\u22121 \u2212\u03b2H(q,p)\nd\u03bcT \u03a3 (q, p) = Z e\nd\u03c3T \u03a3 (q, p) , Z =\ne\u2212\u03b2H(q,p) d\u03c3T \u03a3 (q, p) . (20)\nT\u03a3\n\nHere the measure \u03c3T \u03a3 represents standard volume measure on the manifold T \u03a3.\nIntroduce the Lagrange multiplier \u03bbi (t) \u2208 R. The stochastic dynamics of the\nconstrained molecular system is assumed to be of the form:\n\uf8f1\ndQi\n\uf8f4\n\uf8f4\n= M \u22121\n\uf8f2 dt\ni Pi ,\n(21)\ndP i\n= \u2212\u2207Qi U (Q)dt + \u2207Qi gi (Q)d\u03bbi + d\u03b7 i (Q, P ) ,\n\uf8f4\n\uf8f4\n\uf8f3\ngi (Q) = 0 ,\nwhere i enumerates the elements in the partition. To check that (20) is an invariant\nmeasure of (21), its suffices to show its density is a stationary solution of the\ncorresponding Fokker-Planck equation. We will assume the solution to (21) is\nergodic with respect to the probability distribution \u03bcT \u03a3 . To eliminate the Lagrange\nmultiplier appearing in (21), 'differentiate' the constraint function twice along a\n13\n\n\fpath of (Q, P ) following either the heuristic approach in [50] or the rigorous\napproach described in [7, 14].\nWe will now introduce a constrained version of (11). It is obtained by splitting\n(21) into a constrained Hamiltonian system:\n\uf8f1 dQ\ni\n\uf8f4\n= M \u22121\n\uf8f4\ni Pi ,\n\uf8f4\n\uf8f2 dt\ndP i\n(22)\n= \u2212\u2207Qi U (Q) + \u2207Qi gi (Q)\u03bbi,1 ,\n\uf8f4\n\uf8f4\ndt\n\uf8f4\n\uf8f3\ngi (Q) = 0 ,\nand constrained thermostat dynamics:\n\uf8f1 dQ\ni\n\uf8f4\n=0,\n\uf8f2 dt\ndP i = d\u03b7 i + \u2207Qi gi (Q)d\u03bbi,2 ,\n\uf8f4\n\uf8f3\n0\n= \u2207Qi gi (Q)T M \u22121\ni Pi .\n\n(23)\n\nWe approximate the solution to (22) by using a constrained version of Verlet\nknown as RATTLE [40]. As before to maintain scalability we will separately\npropagate each set of the partition using RATTLE. Since RATTLE moves are\ntime-reversible and volume-preserving [26], a Metropolis method based on a RATTLE proposed move and the probability distribution (20) yields an acceptance\nprobability that is a function of the change in energy induced by the separate RATTLE moves. As before we compose this map with an approximation to (23) which\nwe denote by \u03c8tk+1 ,tk : T \u03a3 \u2192 T \u03a3. The step-by-step procedure to implement this\nalgorithm is given below.\nIf we assume that the thermostat in (23) is given by Langevin dynamics, then\nits pathwise unique flow is given by:\n\u22121\n\n\u2212\u03b3Pi (q)M i\n\u03c8tk+1 ,tk : {(q i , pi )}m\ni=1 7\u2192 {(q i , e\n\nh\n\npi + \u03b7 itk+1 ,tk ))}m\ni=1 ,\n\n(24)\n\nwhere we have introduced the random vector:\nZ tk+1\np\n\u22121\ni\ne\u2212\u03b3Pi (q)M i (tk+1 \u2212s) Pi (q)dW i (s) ,\n\u03b7 tk+1 ,tk = 2\u03b3\u03b2 \u22121\ntk\n\nand the projection matrix:\n\u22121\n\u22121\nT\nPi (q) = I \u2212 (\u2207Qi gi )[(\u2207Qi gi )T M \u22121\ni (\u2207Qi gi )] (\u2207Qi gi ) M i .\n\nHere I is the \u03bdi \u00d7 \u03bdi identity matrix. To derive (24) eliminate the Lagrange multiplier in (23) by differentiating the momentum constraint and using as an integrating factor the matrix exp(\u03b3Pi (q)M \u22121\ni t).\n14\n\n\fRemark 2.6. When the mass matrix is not the identity, (24) requires computing the\nexponential of a position dependent matrix. This calculation is non-trivial, and can\nbe avoided by using SHAKE in place of RATTLE and an unconstrained OrnsteinUhlenbeck update in place of (24). The resulting Metropolized integrator will\nsatisfy property (P1) with respect to a constrained equilibrium distribution, but\nwith unconstrained velocities. It will also satisfy property (P2).\nGiven a time-stepsize h, initial condition x \u2208 \u03a9, and uniform random numbers \u03b6j \u223c U (0, 1) for j = 1, * * * , m, one step of the Metropolized integrator\ndetermines X 1 using (13), but with the proposed moves in \u03b8h,j obtained by RATTLE as follows. Introduce the discrete Lagrange multipliers \u03bbj,1 , \u03bbj,2 \u2208 R. The\nintegrator inputs a point in phase space on the constraint manifold\nx0 = ((q 1 , * * * , q m ), (p1 , * * * , pm )) ,\nand outputs a proposed move on the constraint manifold\nx?1 = ((q 1 , * * * , q j\u22121 , q ?j , q j+1 , * * * , q m ), (p1 , * * * , pj\u22121 , p?j , pj+1 , * * * , pm )) ,\nwhere (q ?j , p?j ) are determined by\n\uf8f1 ?\npj, 1\n\uf8f4\n\uf8f4\n2\n\uf8f4\n\uf8f4\n\uf8f4\n?\n\uf8f4\nq\n\uf8f4\nj\n\uf8f4\n\uf8f4\n\uf8f2 ?\npj\n\uf8f4\n\uf8f4\n\uf8f4\n\uf8f4\n\uf8f4\n\uf8f4\n\uf8f4\n0\n\uf8f4\n\uf8f4\n\uf8f3\n0\n\n= pj \u2212 h2 \u2207Qj U (q 1 , * * * , q m ) \u2212 h2 \u03bbj,1 \u2207Qj gj (q 1 , * * * , q m ) ,\n?\n= q j + hM \u22121\nj pj, 1 ,\n2\n\n= p?j, 1 \u2212 h2 \u2207Qj U (q 1 , * * * , q j\u22121 , q ?j , q j+1 , * * * , q m )\n2\n\n(25)\n\n\u2212 h2 \u03bbj,2 \u2207Qj gj (q 1 , ..., q j\u22121 , q ?j , q j+1 , * * * , q m ) ,\n= gj (q 1 , * * * , q j\u22121 , q ?j , q j+1 , * * * , q m ) ,\n?\n= \u2207Qj gj (q 1 , * * * , q j\u22121 , q ?j , q j+1 , * * * , q m )T M \u22121\nj pj .\n\nThe Lagrange multiplier \u03bbj,1 enforces that the jth proposed positions satisfy the\nposition constraint, and \u03bbj,2 enforces that the jth proposed velocities are tangent\nto the constraint manifold. This proposed move is accepted with probability\n1 \u2227 exp(\u2212\u03b2[H(x?1 ) \u2212 H(x0 )]) .\n\n(26)\n\nThis acceptance probability is a function of the change in energy induced by the\nRATTLE proposed move. If this proposal is rejected the velocity is reversed, but\nremains tangent to the constraint manifold.\n\n15\n\n\f3\n\nApplications\n\nThis section tests the Metropolized integrators introduced in \u00a72.\n\n3.1\n\nLennard-Jones Fluid\n\nA Lennard-Jones fluid consists of n identical particles with pairwise interactions\ngiven by a Lennard-Jones potential energy. In what follows we use dimensionless\nunits to describe this system. In these units mass is rescaled by the mass of an\nindividual particle (so that the particles have unit mass), energy by the depth of\nthe Lennard-Jones potential energy, and length by the point where the potential\nenergy is zero. We follow the notation and setup provided in Part I of [18].\nWe simulate the Lennard-Jones fluid in a fixed periodic box which we call the\nsimulation box. We used a truncated version of the Lennard-Jones potential in\nwhich the energy between two particles a distance r apart is kept constant after a\ncertain cutoff distance and is given by:\n(\nf (r) \u2212 f (rc ) r < rc ,\nULJ (r) =\n(27)\n0\notherwise ,\nwhere we have introduced f (r) = 4(1/r12 \u2212 1/r6 ) and rc is bounded above by the\nsize of the simulation box. Other shifts can be used to make the higher derivatives\nof ULJ continuous. The error introduced by the truncation in (27) is proportional\nto the density of the molecular system and can be made arbitrarily small by selecting the cutoff distance sufficiently large.\nThe pair potentials are a function of the distance between the ith and jth particle. If the position of the ith and jth particles are q i and q j , and the length of the\nsimulation box `, then this distance is given by:\nri,j (q) = |(q i \u2212 q j ) mod `| .\nIn terms of this pairwise distance, the potential energy of a Lennard-Jones fluid is\na sum of interactions between all pairs of particles:\nU (q) =\n\nn\u22121 X\nn\nX\n\nULJ (ri,j (q)) .\n\n(28)\n\ni=1 j=i+1\n\nEvaluating the potential force requires O(n2 ) operations (where \u03bd is the dimension\nof configuration space), and typically dominates total computation cost.\n16\n\n\f3.2\n\nAutocorrelation of Lennard-Jones Fluid\n\nHere we test the accuracy of the Metropolized integrator (13) based on trivial and\nper particle partitions of the molecular system. In the former proposed moves in\nthe Metropolis steps are obtained by per particle Verlet updates, and in the latter\nby global Verlet updates. The numerics indicate that the order of accuracy of both\nmethods is roughly O(h2 ) and that the error constant of the per particle partition\nis approximately an order of magnitude smaller.\nTo test accuracy we use the Metropolized integrator to estimate the equilibrium momentum autocorrelation of the Lennard-Jones fluid. For the numerical\nexperiment, we set the fluid's density % = 0.8442 and temperature T = 0.728\n(units are dimensionless as described earlier). For these values the phase of the\nLennard-Jones fluid is liquid, and close to the triple (gas-liquid-solid) point. We\nalso fix the number of particles to be n = 25 and the degrees of freedom to be\nd = 2. The size of the simulation box is ` = (n/%)1/2 \u2248 5.04. A reasonable cutoff\ndistance in (27) at the selected density is rc = 2.5. The initial positions of the particles are chosen to be the vertices of a square lattice that fills the simulation box.\nFor instance, the length of each square in the lattice can be chosen to be `/dn1/2 e.\nThe initial velocities are sampled from the Maxwell distribution. The thermostat\nparameter is set equal to \u03b3 = 1.0.\nIn the simulations we estimate the true velocity autocorrelation over a timeinterval [0, 1]. Set N = bT /hc and introduce an evenly-spaced mesh in computational time tk = hk for all 0 \u2264 k \u2264 N . Let Ah : [0, 1] \u2192 R denote the velocity\ncorrelation function obtained by the Metropolized integrator (13):\nN\n1 X T\nP b(\u03c4 +tk )/hc P b(tk )/hc , (\u03c4 \u2265 0) .\nA (\u03c4 ) = lim\nN \u2192\u221e N\nk=1\nh\n\nDefine the relative Richardson error as\ndef\n\n\u000fh =\n\nsup\u03c4 \u2208[0,1] |Ah (\u03c4 ) \u2212 A2h (\u03c4 )|\nsup\u03c4 \u2208[0,1] |A(\u03c4 )|\n\n.\n\n(29)\n\nAn empirical estimate of \u000fh is plotted for time-stepsizes\nh = {0.005, 0.0025, 0.00125, 0.000625}\nin Fig. 1 with N = 108 . The denominator in \u000fh is calculated by using the approximation of A at h = 0.000625. The figure shows that the error of the Metropolized\n17\n\n\fintegrator is approximately O(h2 ). Moreover it shows that the Metropolized integrator based on a per particle partition is nearly an order of magnitude more\naccurate than the algorithm based on a trivial partition.\n\n3.3\n\nScaling of Metropolized Integrator\n\nUntil now the numerics dealt with a fixed number of particles in d = 2 dimensions.\nNext we address how the integrator (13) scales with the number of particles keeping the density and temperature fixed. As before we consider two types of partitions: per particle and trivial. This time we will assume the particles are in threedimensional space. Recall that in the former proposed moves in the Metropolis\nsteps are obtained by per particle Verlet updates, and in the latter by global Verlet\nupdates. We will show that the type of proposed move affects the scalability of\nthe Metropolized integrator. In particular, the per particle partition will lead to a\nscalable algorithm.\nBy fixing the density and temperature, the stiffness of the molecular system\nis fixed. Thus, from the viewpoint of numerical analysis, the time-stepsize ought\nto be independent of system size. However, the acceptance probability in the\nMetropolized integrator depends on the change in energy induced by the proposal move (see (15)). If this proposal move is global, then the magnitude of this\nchange in energy increases with system size. Hence, the acceptance probability is\ninversely related to system size, in general. This poor scaling of Metropolis methods based on global moves is well-known in the literature (see, e.g., [5, 32, 38]).\nFor the numerical experiment, we set the fluid's density % = 0.8442 and temperature T = 0.728 (as before units are dimensionless). The mean acceptance\nprobability is computed along a long time trajectory of the integrators (106 steps)\nwith a fixed time-stepsize of h = 0.01 and a variety of system sizes. The initial\npositions of the particles are the vertices of a cubic lattice contained in the simulation box. The length of each cube is given by d(1/%)1/3 e (% = 0.8442 is the\ndensity of the fluid). The initial velocities are sampled from the Maxwell distribution. The thermostat parameter and Lennard-Jones cutoff distances are set equal\nto \u03b3 = 1.0 and rc = 2.5, respectively.\nFigure 2 shows the outcome of the experiment: the mean acceptance probability per particle for the per particle and trivial partitions as a function of the\nnumber of particles. The acceptance probability for the trivial partition clearly\ndeteriorates with system size. On the other hand, the acceptance probability for\nthe per particle partition is independent of system size. In fact, the acceptance\nprobability per particle is equal to one to within round off error. This result seems\n18\n\n\fto defy intuition since the particles experience Lennard-Jones interaction. But,\nkeep in mind that these interactions are, in fact, short-range due to the cutoff in\nthe Lennard-Jones potential energy. Hence, the change in energy induced by per\nparticle Verlet moves is independent of system size.\n\n3.4\n\nAutocorrelation of Lennard-Jones Dumbbells\n\nA rigid dumbbell is a type of molecule that involves a holonomic constraint. It\nconsists of a pair of particles constrained to a fixed distance from one another. The\nconstraint arises when the spring joining a flexible dumbbell infinitely stiffens.\nConsider n identical dumbbells where particles in separate dumbbells interact via\na Lennard-Jones potential energy (28).\nFor the numerical experiment, we simulate the dumbbells in a simulation box\nof length ` and d = 2 dimensions as before. We set the system's density % = 0.998\nand temperature T = 3.0 (units are dimensionless as described earlier). We also\nfix the number of dumbbells to n = 30 and the length of each dumbbell to `0 = 1.\nIf the positions of the ith pair of particles describing the ith dumbbell are q i,1 and\nq i,2 , then the constraint function associated to the ith dumbbell is given by:\ngi (q) = |(q i,1 \u2212 q i,2 ) mod `|2 \u2212 `20 , i = 1, * * * , n .\nThe size of the simulation box is ` = (2n/%)1/2 \u2248 7. The cutoff distance in (27)\nis set at rc = 3.0. The initial positions of the dumbbells are chosen randomly in\nthe simulation box, but with no overlap. The initial velocities are sampled from\nthe Maxwell distribution constrained to be tangent to the constraint manifold at\nthe initial positions and temperature. The thermostat parameter is set to \u03b3 = 1.0.\nTo quantify the accuracy of the numerical method, we use the Metropolized\nintegrator based on a per dumbbell partition. We again use the relative Richardson\nerror defined in (29) to estimate the rate of convergence of the method. Figure 3\nshows the velocity autocorrelation that we wish to approximate over the timeinterval [0, 1]. It is noticeably different from the velocity autocorrelation in the\ncase of the Lennard-Jones cluster without constraints. The figure also shows a plot\nof the Richardson error as a function of time-stepsize. The rate of convergence\nappears to be approximately O(h2 ).\n\n19\n\n\f4\n\nConclusions\n\nThis paper showed how thinking probabilistically helps to design good integrators\nfor SDEs arising in molecular dynamics. The paper brought ideas from Monte\nCarlo into molecular dynamics, to obtain a Metropolized integrator that is unconditionally stable, pathwise accurate, and still explicit. While the examples and\ntheory in the paper focused on Langevin dynamics, the methodology can be extended to other thermostats. The patch we propose is simple and, as we showed,\nits computational overhead is minimum compared to an 'unpatched' integrator.\nAn open question about the Metropolized integrator is its convergence rate to\nequilibrium. In general, it is not expected that the Metropolized integrator inherits\nall of the mixing properties of the exact solution to the SDE. The main reason\nis conditional stability of the underlying Verlet integrator that generates proposal\nmoves. Indeed for any time-stepsize one can find an energy value above which the\ndrift in this integrator gives proposed moves that increase the energy, in contrast\nto the exact drift in the SDE which always centers the solution towards lower\nenergy values. Since higher energy values have a lower equilibrium probability\nweight, these proposed moves are typically rejected. While these rejections ensure\nthat the Metropolized integrator is ergodic, at high energy values they prevent the\nintegrator from inheriting all of the mixing properties of the true solution.\nThis issue has been addressed for the MALA algorithm in the overdamped\nlimit of Langevin dynamics [6]. It turns out that MALA converges to its equilibrium distribution at an exponential rate up to terms exponentially small in timestepsize. However, in the overdamped limit positions are no longer differentiable,\nmomentum is no longer present, and the MALA algorithm does not involve momentum flips. Intuitively one expects these momentum flips to reduce stagnation\nat high energy values, and hence, enhance the mixing rate. Future research will\ninvestigate the effect of these momentum flips to this mixing rate.\nAnother open question concerns the acceptance probability of the Metropolized\nintegrator as the dimension tends to \u221e. The numerical experiment in Figure 2 indicates that the acceptance probability of the Metropolized integrator based on\nglobal Verlet moves scales as O(n\u22121/6 ) where n is the number of particles. Thus,\nto obtain an O(1) acceptance probability the time stepsize should be proportional\nto n\u22121/6 , and the integrator would require O(n1/6 ) steps to traverse phase space.\nThis scaling property would imply that the Metropolized integrator is more efficient at making O(1) moves in state space as compared with the O(n1/4 ) and\nO(n1/3 ) scalings of respectively hybrid Monte-Carlo and MALA [5]. This question will also be investigated in future work.\n20\n\n\fAcknowledgements We wish to thank Gerard Ben-Arous, Weinan E, Martin\nHairer, Mikael Rechtsman, Christof Sch\u00fctte, Andrew Stuart, Maddalena Venturoli, and Jonathan Weare for stimulating discussions. The research of NBR was\nsupported in part by NSF Fellowship DMS-0803095. The research of EVE was\nsupported in part by NSF grants DMS-0718172 and DMS-0708140, and ONR\ngrant N00014-04-1-6046.\n\nAppendix\nProof of Corollary 2.5. We prove this estimate for the equilibrium correlation of\nany Lipschitz function g \u2208 C 0,1 (\u03a9, R). This assumption includes the special\ncase of a scalar velocity autocorrelation function. Ergodicity of the Metropolized\nintegrator (see Theorem 2.4) implies that\nN\n1 X\ng(X btk /hc )g(X b(tk +\u03c4 )/hc ) = g(X bt/hc )g(X b(t+\u03c4 )/hc )\nlim\nN \u2192\u221e N\nk=1\n\nfor any t \u2265 0. (Recall, that the angle brackets denote a double average with\nrespect to initial conditions distributed according to the equlibrium distribution of\n(18) and realizations of the Wiener process.) Thus, we wish to estimate:\ndef\n\n\u000fh =\n=\n\ng(X bt/hc )g(X b(t+\u03c4 )/hc ) \u2212 hg(Y (t))g(Y (t + hb\u03c4 /hc))i\n\u0001\ng(x) g(X b\u03c4 /hc ) \u2212 g(Y (hb\u03c4 /hc) ) .\n\nBy the Cauchy-Schwarz inequality,\n\u000fh \u2264 Cg\n\n\u0012Z\n\u03a9\n\nx\n\n\b\nE g(X b\u03c4 /hc ) \u2212 g(Y (hb\u03c4 /hc))\n\n2\n\n\u00131/2\nd\u03bc\n,\n\nR\nwhere Cg = ( \u03a9 |g(x)|2 d\u03bc)1/2 . By Jensen's inequality,\n\u0010 n\no\u00111/2\n2\n\u000fh \u2264 Cg E\u03bc g(X b\u03c4 /hc ) \u2212 g(Y (hb\u03c4 /hc))\n.\nThe Lipschitz assumption on g implies,\n|g(x) \u2212 g(y)| \u2264 Lg |x \u2212 y|\n21\n\n\ffor some constant Lg > 0 and for every x, y \u2208 \u03a9. Hence,\no\u00111/2\n\u0010 n\n2\n\u000fh \u2264 Lg Cg E\u03bc X b\u03c4 /hc \u2212 Y (hb\u03c4 /hc)\n.\nPathwise convergence of the Metropolized integrator (see Theorem 2.3) implies\n\u0010\n\nE\u03bc\n\nn\n\nX b\u03c4 /hc \u2212 Y (hb\u03c4 /hc)\n\n2\n\no\u00111/2\n\n\u2264 C(T )h .\n\nFrom which it follows, that the accuracy of the Metropolized integrator in computing the equilibrium correlation in g is O(h) with a prefactor that depends on\nthe function g.\n\nReferences\n[1] E. Akhmatskaya and S. Reich, GSHMC: An efficient method for molecular\nsimulation, J. Comput. Phys. 227 (2008), 4937\u20134954.\n[2] M. P. Allen and D. J. Tildesley, Computer simulation of liquids, Clarendon\nPress, 1987.\n[3] H. C. Andersen, Molecular dynamics simulations at constant pressure\nand/or temperature, J. Chem. Phys. 72 (1980), 2384.\n[4] G. Benetin and A. Giorgilli, On the Hamiltonian interpolation of near to\nthe identity symplectic mappings with applications to symplectic integration\nalgorithms, J. Statist. Phys. 74 (1994), 1117\u20131143.\n[5] A. Beskos, N. S. Pillai, G. O. Roberts, J. M. Sanz-Serna, and A. M. Stuart,\nOptimal tuning of hybrid Monte-Carlo, arXiv:1001.4460, 2010.\n[6] N. Bou-Rabee, M. Hairer, and E. Vanden-Eijnden, Non-asymptotic mixing\nof the MALA algorithm, arXiv:1008.3514v1 [math.PR], 2010.\n[7] N. Bou-Rabee and H. Owhadi, Stochastic variational integrators, IMA J. of\nNumer. Anal. 29 (2009), 421\u2013443.\n[8] N. Bou-Rabee and E. Vanden-Eijnden, Reconciling Monte Carlo and molecular dynamics, Preprint, 2009.\n\n22\n\n\f[9] N. Bou-Rabee and E. Vanden-Eijnden, Pathwise accuracy and ergodicity of\nMetropolized integrators for SDEs, CPAM 63 (2010), 655\u2013696.\n[10] A. Br\u00fcnger, C. L. Brooks, and M. Karplus, Stochastic boundary conditions\nfor molecular dynamics simulations of ST2 water, Chem. Phys. Lett. 105\n(1984), 495\u2013500.\n[11] G. Bussi, D. Donadio, and M. Parrinello, Canonical sampling through velocity rescaling, J. Chem. Phys. 126 (2007), 014101.\n[12] G. Bussi and M. Parrinello, Stochastic thermostats: Comparison of local and\nglobal schemes, Computer Physics Communications 179 (2008), 26\u201329.\n[13] E. Canc\u00e9s, F. Legoll, and G. Stoltz, Theoretical and numerical comparison\nof some sampling methods for molecular dynamics, Mathematical Modelling\nand Numerical Analysis 41 (2007), 351\u2013389.\n[14] G. Ciccotti, T. Lelievre, and E. Vanden-Eijnden, Projections of diffusions on\nsubmanifolds: Application to mean force computation, CPAM 61 (2008),\n0001\u20130039.\n[15] W. E and D. Li, The Andersen thermostat in molecular dynamics, CPAM 61\n(2008), 96\u2013136.\n[16] W. Fong, Multi-scale methods in time and space for particle simulations,\nPh.D. thesis, Stanford University, 2009.\n[17] W. Fong, E. Darve, and A. Lew, Stability of asynchronous variational integrators, J. Comput. Phys. 227 (2008), 8367\u20138394.\n[18] D. Frenkel and B. Smit, Understanding molecular simulation: From algorithms to applications, second edition, Academic Press, 2002.\n[19] J. Goodman and A. Sokal, Multigrid Monte Carlo method: Conceptual foundations, Phys. Rev. D 40 (1989), 2035\u20132071.\n[20] E. Hairer, C. Lubich, and G. Wanner, Geometric numerical integration,\nSpringer Series in Computational Mathematics, vol. 31, Springer, 2006.\n[21] C. Hartmann, An ergodic sampling scheme for constrained Hamiltonian systems with applications to molecular dynamics, J. Stat. Phys. 130 (2008),\n687\u2013712.\n23\n\n\f[22] D. J. Higham, X. Mao, and A. M. Stuart, Strong convergence of Euler-type\nmethods for nonlinear stochastic differential equations, SIAM J. Numer.\nAnal. 40 (2002), 1041\u20131063.\n[23] J. A. Izaguirre, D. P. Catarello, J. M. Wozniak, and R. D. Skeel, Langevin\nstabilization of molecular dynamics, J. Chem. Phys. 114 (2001), 2090.\n[24] B. Leimkuhler, E. Noorizadeh, and F. Theil, A gentle stochastic thermostat\nfor molecular dynamics, J. Stat. Phys. 135 (2009), 261\u2013277.\n[25] B. Leimkuhler and S. Reich, Simulating Hamiltonian dynamics, Cambridge\nMonographs on Applied and Computational Mathematics, Cambridge University Press, 2004.\n[26] B. Leimkuhler and R. Skeel, Symplectic numerical integrators in constrained Hamiltonian systems, JCP 112 (1994), 117\u2013125.\n[27] T. Leli\u00e8vre, M. Rousset, and G. Stoltz, Langevin dynamics with constraints\nand computation of free energy differencs, arXiv:1006.4914v1, 2010.\n[28] A. Lew, J. E. Marsden, M. Ortiz, and M. West, Asynchronous variational\nintegrators, Arch. Ration. Mech. An. 167 (2003), 85\u2013145.\n[29] D. Li, On the rate of convergence to equilibrium of the Andersen thermostat\nin molecular dynamics, J. Stat. Phys. 129 (2007), 265\u2013287.\n[30] J. S. Liu and Y. N. Wu, Generalised Gibbs sampler and multigrid Monte\nCarlo for Bayesian computation, Biometrika 87 (2000), 353\u2013369.\n[31] Q. Ma, J. A. Izaguirre, and R. D. Skeel, VERLET-I/R-RESPA/IMPULSE is\nlimited by nonlinear instabilities, SIAM J. Sci. Comput. 24 (2003), 1951\u2013\n1973.\n[32] J. C. Mattingly, N. S. Pillai, and A. M. Stuart, Diffusion limits of the random\nwalk Metropolis algorithm in high dimensions, arXiv:1003.4306, 2010.\n[33] K. L. Mengersen and R. L. Tweedie, Rates of convergence of the Hastings\nand Metropolis algorithms, Ann. Stat. 24 (1996), 101\u2013121.\n[34] N. Metropolis, A. W. Rosenbluth, A. H. Teller, and E. Teller, Equations of\nstate calculations by fast computing machines, J. Chem. Phys. 21 (1953),\n1087\u20131092.\n24\n\n\f[35] G. N. Milstein and M. V. Tretyakov, Numerical integration of stochastic differential equations with nonglobally Lipschitz coefficients, SIAM J. Numer.\nAnal. 43 (2005), 1139\u20131154.\n[36] J. Moser, Lectures on Hamiltonian systems, vol. 81, Mem. AMS, 1968.\n[37] S. Reich, Backward error analysis for numerical integrators, SIAM J. Num.\nAnal. 36 (1999), 1549\u20131570.\n[38] G. O. Roberts and J. S. Rosenthal, Optimal scaling of discrete approximations to Langevin diffusions, J. Roy. Statist. Soc. Ser. B 60 (1998), 255\u2013268.\n[39] G. O. Roberts and R. L. Tweedie, Geometric convergence and central\nlimit theorems for multidimensional Hastings and Metropolis algorithms,\nBiometrika 1 (1996), 95\u2013110.\n[40] J. Ryckaert, G. Ciccotti, and H. Berendsen, Numerical integration of the\nCartesian equations of motion of a system with constraints: Molecular dynamics of n-alkanes, JCP 23 (1977), 327\u2013341.\n[41] A. A. Samoletov, M. A. Chaplain, and C. P. Dettmann, Thermostats for\n\"slow\" configurational modes, J. Stat. Phys. 128 (2008), 1321\u20131336.\n[42] A. Scemama, T. Leli\u00e8vre, G. Stoltz, E. Canc\u00e9s, and M. Caffarel, An efficient\nsampling algorithm for variational Monte Carlo, J. Chem. Phys. 125 (2006),\n114105.\n[43] T. Schneider and E. Stoll, Molecular-dynamics study of a three-dimensional\none-component model for distortive phase transitions, Physical Review B 17\n(1978), 1302\u20131322.\n[44] G. Stoltz, Some mathematical methods for molecular and multiscale simulation, Ph.D. thesis, Ecole Nationale des Ponts et Chauss\u00e9es, 2007.\n[45] D. Talay, Simulation and numerical analysis of stochastic differential systems : a review, Probabilistic Methods in Applied Physics (P. Kr\u00e8e and\nW. Wedig, eds.), vol. 451, Springer-Verlag, Berlin, 1995, pp. 54\u201396.\n[46]\n\n, Stochastic Hamiltonian systems: Exponential convergence to the\ninvariant measure, and discretization by the implicit Euler scheme, Markov\nProcesses and Related Fields 8 (2002), 1\u201336.\n25\n\n\f[47] D. Talay and L. Tubaro, Expansion of the global error for numerical schemes\nsolving stochastic differential equations, Stoch. Anal. Appl. 8 (1990), 94\u2013\n120.\n[48] M. E. Tuckerman and B. J. Berne, Stochastic molecular dynamics in systems\nwith multiple time scales and memory friction, J. Chem. Phys. 95 (1991),\n4389\u20134396.\n[49] M. E. Tuckerman, B. J. Berne, and G. Martyna, Reversible multiple time\nscale molecular dynamics, J. Chem. Phys. 97 (1992), 1990\u20132001.\n[50] E. Vanden-Eijnden and G. Ciccotti, Second-order integrators for Langevin\nequations with holonomic constraints, Chem. Phys. Lett. 429 (2006), 310\u2013\n316.\n[51] E. Vanden-Eijnden and M. Venturoli, Markovian milestoning with Voronoi\ntessellations, J. Chem. Phys. 130 (2008), 194101.\n[52]\n\n, Exact rate calculations by trajectory parallelization and twisting,\nIn press, 2009.\n\n[53] L. Verlet, Computer \"experiments\" on classical fluids. I. Thermodynamical\nproperties of Lennard-Jones molecules, Phys. Rev. 159 (1967), 98\u2013103.\n\n26\n\n\fVelocity Autocorrelation\n\n40\n30\n20\n10\n0\n-10\n0\n\n0.2\n\n0.4\n\n0.6\n\n0.8\n\n1\n\nRelative Richardson Error\n\nt\n\n-2\n\n10\n\n-3\n\n10\n\nTrivial\nPer-Particle\nh2\n\n-4\n\n10\n\n-3\n\n10\n\nh\n\nFigure 1: Autocorrelation of Lennard-Jones Fluid. The panel on the top shows the\nvelocity autocorrelation function over the time interval [0, 1]. The panel on the bottom\nshows a loglog plot of the Richardson error ((29)) of the Metropolized integrator based on\ntrivial and per-particle partitions. The molecular system integrated is the Lennard-Jones\nfluid with 25 particles in a square box. The dashed line represents a reference slope of\nh2 . A total of N = 108 samples were used to obtain these empirical estimates. Notice\nthat the Metropolized integrator based on per-particle Verlet moves is about an order of\nmagnitude more accurate than the Metropolized integrator based on global Verlet moves.\n27\n\n\fMean Acceptance Probability\n\n1\n0.9\n0.8\n0.7\n\nTrivial\nPer-Particle\n1\nO(n \u2212 6 )\n\n1000\n\n2000\n3000\n4000\nNumber of Particles\n\n5000\n\nFigure 2: Mean Acceptance Probability as a Function of System Size. This figure\nshows the mean acceptance probability per particle for the integrator (13) based on a\ntrivial and per particle partition. From the plot it is clear that a) the acceptance probability\nfor the integrator based on a per particle partition is independent of system size and b) the\nacceptance probability for the trivial partition scales like n\u22121/6 where n is the number of\nparticles.\n\n28\n\n\fVelocity Autocorrelation\n\n150\n\n100\n\n50\n\n0\n\n-50\n0\n\n0.2\n\n0.4\n\n0.6\n\n0.8\n\n1\n\nt\n\nRelative Richardson Error\n\n-2\n\n10\n\n-3\n\n10\n\nPer-Dumbbell\nh2\n-2\n\n10\nh\n\nFigure 3: Autocorrelation of Lennard-Jones Dumbbells. The panel on the top shows\nthe velocity autocorrelation function. The panel on the bottom shows a loglog plot of an\nempirical estimate of the Richardson error ((29)) of the Metropolized integrator based on\nper-dumbbell RATTLE proposed moves. The molecular system integrated is the LennardJones system of 15 dumbbells in a square box. The dashed line represents a reference\nslope of h2 . A total of N = 108 samples were used to obtain this estimate.\n\n29\n\n\f"}