{"id": "http://arxiv.org/abs/astro-ph/0608156v2", "guidislink": true, "updated": "2007-08-11T17:43:20Z", "updated_parsed": [2007, 8, 11, 17, 43, 20, 5, 223, 0], "published": "2006-08-07T20:00:53Z", "published_parsed": [2006, 8, 7, 20, 0, 53, 0, 219, 0], "title": "Block Structured Adaptive Mesh and Time Refinement for Hybrid,\n  Hyperbolic + N-body Systems", "title_detail": {"type": "text/plain", "language": null, "base": "http://export.arxiv.org/api/query?search_query=&id_list=astro-ph%2F0608058%2Castro-ph%2F0608091%2Castro-ph%2F0608609%2Castro-ph%2F0608344%2Castro-ph%2F0608558%2Castro-ph%2F0608137%2Castro-ph%2F0608251%2Castro-ph%2F0608117%2Castro-ph%2F0608125%2Castro-ph%2F0608068%2Castro-ph%2F0608162%2Castro-ph%2F0608387%2Castro-ph%2F0608636%2Castro-ph%2F0608614%2Castro-ph%2F0608191%2Castro-ph%2F0608175%2Castro-ph%2F0608211%2Castro-ph%2F0608453%2Castro-ph%2F0608375%2Castro-ph%2F0608208%2Castro-ph%2F0608472%2Castro-ph%2F0608710%2Castro-ph%2F0608156%2Castro-ph%2F0608266%2Castro-ph%2F0608111%2Castro-ph%2F0608373%2Castro-ph%2F0608352%2Castro-ph%2F0608033%2Castro-ph%2F0608653%2Castro-ph%2F0608620%2Castro-ph%2F0608216%2Castro-ph%2F0608598%2Castro-ph%2F0608708%2Castro-ph%2F0608316%2Castro-ph%2F0608702%2Castro-ph%2F0608018%2Castro-ph%2F0608349%2Castro-ph%2F0608535%2Castro-ph%2F0608456%2Castro-ph%2F0608243%2Castro-ph%2F0608521%2Castro-ph%2F0608100%2Castro-ph%2F0608698%2Castro-ph%2F0608486%2Castro-ph%2F0608585%2Castro-ph%2F0608314%2Castro-ph%2F0608650%2Castro-ph%2F0608123%2Castro-ph%2F0608553%2Castro-ph%2F0608458%2Castro-ph%2F0608606%2Castro-ph%2F0608129%2Castro-ph%2F0608063%2Castro-ph%2F0608326%2Castro-ph%2F0608405%2Castro-ph%2F0608707%2Castro-ph%2F0608046%2Castro-ph%2F0608511%2Castro-ph%2F0608293%2Castro-ph%2F0608538%2Castro-ph%2F0608109%2Castro-ph%2F0608704%2Castro-ph%2F0608443%2Castro-ph%2F0608253%2Castro-ph%2F0608433%2Castro-ph%2F0608422%2Castro-ph%2F0608079%2Castro-ph%2F0608660%2Castro-ph%2F0608004%2Castro-ph%2F0608009%2Castro-ph%2F0608112%2Castro-ph%2F0608496%2Castro-ph%2F0608060%2Castro-ph%2F0608169%2Castro-ph%2F0608055%2Castro-ph%2F0608377%2Castro-ph%2F0608296%2Castro-ph%2F0608652%2Castro-ph%2F0608315%2Castro-ph%2F0608449%2Castro-ph%2F0608572%2Castro-ph%2F0608152%2Castro-ph%2F0608053%2Castro-ph%2F0608241%2Castro-ph%2F0608237%2Castro-ph%2F0608090%2Castro-ph%2F0608627%2Castro-ph%2F0608256%2Castro-ph%2F0608617%2Castro-ph%2F0608499%2Castro-ph%2F0608120%2Castro-ph%2F0608116%2Castro-ph%2F0608301%2Castro-ph%2F0608127%2Castro-ph%2F0608355%2Castro-ph%2F0608192%2Castro-ph%2F0608468%2Castro-ph%2F0608591%2Castro-ph%2F0608087%2Castro-ph%2F0608223%2Castro-ph%2F0608382&start=0&max_results=1000&sortBy=relevance&sortOrder=descending", "value": "Block Structured Adaptive Mesh and Time Refinement for Hybrid,\n  Hyperbolic + N-body Systems"}, "summary": "We present a new numerical algorithm for the solution of coupled collisional\nand collisionless systems, based on the block structured adaptive mesh and time\nrefinement strategy (AMR). We describe the issues associated with the\ndiscretization of the system equations and the synchronization of the numerical\nsolution on the hierarchy of grid levels. We implement a code based on a higher\norder, conservative and directionally unsplit Godunov's method for\nhydrodynamics; a symmetric, time centered modified symplectic scheme for\ncollisionless component; and a multilevel, multigrid relaxation algorithm for\nthe elliptic equation coupling the two components. Numerical results that\nillustrate the accuracy of the code and the relative merit of various\nimplemented schemes are also presented.", "summary_detail": {"type": "text/plain", "language": null, "base": "http://export.arxiv.org/api/query?search_query=&id_list=astro-ph%2F0608058%2Castro-ph%2F0608091%2Castro-ph%2F0608609%2Castro-ph%2F0608344%2Castro-ph%2F0608558%2Castro-ph%2F0608137%2Castro-ph%2F0608251%2Castro-ph%2F0608117%2Castro-ph%2F0608125%2Castro-ph%2F0608068%2Castro-ph%2F0608162%2Castro-ph%2F0608387%2Castro-ph%2F0608636%2Castro-ph%2F0608614%2Castro-ph%2F0608191%2Castro-ph%2F0608175%2Castro-ph%2F0608211%2Castro-ph%2F0608453%2Castro-ph%2F0608375%2Castro-ph%2F0608208%2Castro-ph%2F0608472%2Castro-ph%2F0608710%2Castro-ph%2F0608156%2Castro-ph%2F0608266%2Castro-ph%2F0608111%2Castro-ph%2F0608373%2Castro-ph%2F0608352%2Castro-ph%2F0608033%2Castro-ph%2F0608653%2Castro-ph%2F0608620%2Castro-ph%2F0608216%2Castro-ph%2F0608598%2Castro-ph%2F0608708%2Castro-ph%2F0608316%2Castro-ph%2F0608702%2Castro-ph%2F0608018%2Castro-ph%2F0608349%2Castro-ph%2F0608535%2Castro-ph%2F0608456%2Castro-ph%2F0608243%2Castro-ph%2F0608521%2Castro-ph%2F0608100%2Castro-ph%2F0608698%2Castro-ph%2F0608486%2Castro-ph%2F0608585%2Castro-ph%2F0608314%2Castro-ph%2F0608650%2Castro-ph%2F0608123%2Castro-ph%2F0608553%2Castro-ph%2F0608458%2Castro-ph%2F0608606%2Castro-ph%2F0608129%2Castro-ph%2F0608063%2Castro-ph%2F0608326%2Castro-ph%2F0608405%2Castro-ph%2F0608707%2Castro-ph%2F0608046%2Castro-ph%2F0608511%2Castro-ph%2F0608293%2Castro-ph%2F0608538%2Castro-ph%2F0608109%2Castro-ph%2F0608704%2Castro-ph%2F0608443%2Castro-ph%2F0608253%2Castro-ph%2F0608433%2Castro-ph%2F0608422%2Castro-ph%2F0608079%2Castro-ph%2F0608660%2Castro-ph%2F0608004%2Castro-ph%2F0608009%2Castro-ph%2F0608112%2Castro-ph%2F0608496%2Castro-ph%2F0608060%2Castro-ph%2F0608169%2Castro-ph%2F0608055%2Castro-ph%2F0608377%2Castro-ph%2F0608296%2Castro-ph%2F0608652%2Castro-ph%2F0608315%2Castro-ph%2F0608449%2Castro-ph%2F0608572%2Castro-ph%2F0608152%2Castro-ph%2F0608053%2Castro-ph%2F0608241%2Castro-ph%2F0608237%2Castro-ph%2F0608090%2Castro-ph%2F0608627%2Castro-ph%2F0608256%2Castro-ph%2F0608617%2Castro-ph%2F0608499%2Castro-ph%2F0608120%2Castro-ph%2F0608116%2Castro-ph%2F0608301%2Castro-ph%2F0608127%2Castro-ph%2F0608355%2Castro-ph%2F0608192%2Castro-ph%2F0608468%2Castro-ph%2F0608591%2Castro-ph%2F0608087%2Castro-ph%2F0608223%2Castro-ph%2F0608382&start=0&max_results=1000&sortBy=relevance&sortOrder=descending", "value": "We present a new numerical algorithm for the solution of coupled collisional\nand collisionless systems, based on the block structured adaptive mesh and time\nrefinement strategy (AMR). We describe the issues associated with the\ndiscretization of the system equations and the synchronization of the numerical\nsolution on the hierarchy of grid levels. We implement a code based on a higher\norder, conservative and directionally unsplit Godunov's method for\nhydrodynamics; a symmetric, time centered modified symplectic scheme for\ncollisionless component; and a multilevel, multigrid relaxation algorithm for\nthe elliptic equation coupling the two components. Numerical results that\nillustrate the accuracy of the code and the relative merit of various\nimplemented schemes are also presented."}, "authors": ["Francesco Miniati", "Phillip Colella"], "author_detail": {"name": "Phillip Colella"}, "author": "Phillip Colella", "links": [{"title": "doi", "href": "http://dx.doi.org/10.1016/j.jcp.2007.07.035", "rel": "related", "type": "text/html"}, {"href": "http://arxiv.org/abs/astro-ph/0608156v2", "rel": "alternate", "type": "text/html"}, {"title": "pdf", "href": "http://arxiv.org/pdf/astro-ph/0608156v2", "rel": "related", "type": "application/pdf"}], "arxiv_comment": "40 pages, 10 figures, JPC in press. Extended the code test section,\n  new convergence tests, several typos corrected. Full resolution version\n  available at http://www.exp-astro.phys.ethz.ch/miniati/charm.pdf", "arxiv_primary_category": {"term": "astro-ph", "scheme": "http://arxiv.org/schemas/atom"}, "tags": [{"term": "astro-ph", "scheme": "http://arxiv.org/schemas/atom", "label": null}], "pdf_url": "http://arxiv.org/pdf/astro-ph/0608156v2", "affiliation": "LBNL, Berkeley", "arxiv_url": "http://arxiv.org/abs/astro-ph/0608156v2", "journal_reference": "J.Comput.Phys.227:400-430,2007", "doi": "10.1016/j.jcp.2007.07.035", "fulltext": "May 9, 2018\n\narXiv:astro-ph/0608156v2 11 Aug 2007\n\nBlock Structured Adaptive Mesh and Time\nRefinement for Hybrid, Hyperbolic + N-body Systems\nFrancesco Miniati\u2020\u2021 and Phillip Colella\u2217\n\u2020\n\n\u2021\n\nPhysics Department, Wolfgang-Pauli-Strasse 16, ETH Z\u00fcrich, CH-8093 Z\u00fcrich\nMax-Planck-Institut f\u00fcr Astrophysik, Karl-Schwarzschild-Str. 1, 85740, Garching, Germany\n\u2217\nLawrence Berkeley National Laboratory, 1 Cyclotron Rd., Berkeley, CA 94720, USA\n\nWe present a new numerical algorithm for the solution of coupled collisional and collisionless systems, based on the block structured adaptive\nmesh and time refinement strategy (AMR). We describe the issues associated with the discretization of the system equations and the synchronization of the numerical solution on the hierarchy of grid levels. We implement\na code based on a higher order, conservative and directionally unsplit Godunov's method for hydrodynamics; a symmetric, time centered modified\nsymplectic scheme for collisionless component; and a multilevel, multigrid\nrelaxation algorithm for the elliptic equation coupling the two components.\nNumerical results that illustrate the accuracy of the code and the relative\nmerit of various implemented schemes are also presented.\n\nKey Words: higher-order Godunov methods, adaptive mesh refinement, elliptic methods,\nparticle-in-cell methods\n\nMathematical subject codes: 65M55, 76M28\n\n1.\n\nINTRODUCTION\n\nAstrophysical systems are typically complex and highly nonlinear, providing the\nground for the occurrence, either singly or concomitantly, of numerous physical processes. These include, among others, hydro- and magnetohydro-dynamics, gravity,\nradiation and many-body interactions. They operate on a wide range of spatial and\ntemporal scales and it is often desirable to fully cover these ranges for a thorough\nunderstanding of the problem. Thus the problems are demanding both in terms\nof physics algorithms and dynamic range (resolution). While the development of\nhigh order numerical schemes certainly improves the quality of numerical solutions\nand the availability of ever more powerful computers has allowed the performance\nof larger calculations, special techniques are required in order to achieve very large\ndynamic ranges.\n1\n\n\f2\n\n! Please write \\authorrunninghead{<Author Name(s)>} in file !\n\nThe Adaptive Mesh Refinement (AMR) technique offers a powerful solution for\nthis purpose [1, 2]. While there are difficulties associated with its implementation,\nthe use of AMR in astrophysics and cosmology has grown significantly to include\nstudies of nucleosynthesis in Supernovae explosions [3, 4, 5, 6], of the multiphase\ninterstellar medium and radiative shock hydrodynamics [7, 8], the problem of star\nformation out of the collapse of protostellar clouds [9, 10, 11] and the formation\nof the first stars as well as the large scale structure in the universe [12, 13]. The\nuse of AMR technique in the above examples has often been instrumental in either\nrevealing new properties of the investigated system (such as instabilities) or pointing\nout mistaken views based on limited resolution calculations.\nWe will consider two aspects of application of AMR to astrophysical problems.\nThe first is the extension to incorporate self-gravity. This capability leads to new\nalgorithmic difficulties due to the elliptic nature of the problem. In particular\nthe solution has to be computed simultaneously on all levels of refinement and\ncontinuity of both the solution and its normal derivative has to be enforced at\ncoarse-fine level interfaces [14]. However, this introduces non-trivial complications\nwhen time refinement is also employed: the coarser levels are advanced first and\nfiner levels are advanced with the assumption that boundary conditions at finecoarse interfaces are provided by the coarse level solutions interpolated in time.\nHowever, the full multilevel elliptic solution can only be computed when all levels\nare synchronized and thus is not available when the coarser levels are ahead of the\nfiner levels. Thus the first implementations of a full multilevel elliptic solver for\nself-gravity [10, 11, 15] do not use refinement in time. And when employing time\nrefinement the multilevel elliptic equation has been solved as a set of independent\nboundary value problems, one for each level, not a fully multilevel solution [16, 17,\n18, 19].\nThe second issue we will address is the application of AMR to hybrid systems,\nthat is a self-gravitating gas coupled to a particle representation of a collisionless\nmatter described by Vlasov-Poisson equations [20] . This is relevant to several\nproblems in astrophysics, particularly for modeling the formation and evolution\nof structure in the universe. In this case the AMR technique is combined with\nParticle-Mesh methods to compute the right-hand side to the Poisson's equation\ndue to the particles mass. In order to take advantage of the higher resolution of the\nfiner grids, it is desirable to advance the particles with the force compute on, and\nthe timesteps of, the finest grids that cover their spatial position. This introduces\na complication for the elliptic solver similar to the one described above for the case\nof self-gravitating gas dynamics, in the sense that the particles contribution to the\nright-hand side of Poisson's equation needs to be accounted for even when the levels\nof refinement are not synchronized.\nVarious AMR codes for hybrid systems have been developed over the past several\nyears [21, 16, 17, 18, 19, 15]. The refinement strategy in [16, 18, 15] is based on\nsplitting of individual cells and in [17] only the collisionless component is evolved.\nVirtually all schemes use Strang splitting [22] for the multidimensional version\nof the hydrodynamics and a modified leap-frog method for the integration of the\nequation of motion of the particles. This has also been done for problems in which\nthere is no coupling to a collisional fluid component, as occurs in computations of\ncollisionless plasmas [23].\n\n\f! Please write \\titlerunninghead{<(Shortened) Article Title>} in file !\n\n3\n\nIn our approach we use the block structured scheme for adaptive mesh and time\nrefinement proposed in [2] as a starting point and extend it include gravity and\ncollisionless particle dynamics. We use an unsplit Godunov's method for hydrodynamics [24]; a symmetric, time centered modified symplectic scheme based on the\nkick-drift-kick sequence for the collisionless component; and a multilevel, multigrid\nrelaxation algorithm for the elliptic equation coupling the two systems. We introduce two new procedures to solve synchronization issues described above that\narise with the elliptic solver when the coarse and finer levels are not synchronized.\nWe use a method analogous to those developed for AMR for incompressible flows\n[25, 26] to compute a lagged estimate of the correction of the elliptic matching\nconditions at boundaries between refinement levels at times when the levels are not\nsynchronized. We also present a detailed discussion of refinement in time in the\npresence of collisionless particles, including methods for associating particles with\nrefinement levels, and a particle aggregation operation to cost-effectively estimate\nthe density distribution on coarse levels due to particles evolved on finer levels\nwithout compromising the code accuracy. We provide a detailed description of the\nformal discretization of the system of equations and the issues involved with the\nsynchronization of the numerical solution in the presence of refinement in time, at\na level of detail which we feel is lacking in the current literature.\nThe paper is organized as follows. First, the evolution equations and single level\nalgorithms are outlined in Section 2. In Section 3 we provide a formal definition of\nthe employed AMR volume discretization, variables and operators and then describe\nin detail the general AMR algorithm for hybrid system. Finally, in section 4 we\ntest the accuracy of the code by comparing its results against for set of standard\nsolutions.\n2.\n\nEVOLUTION EQUATIONS AND TEMPORAL\nDISCRETIZATION\nIn this section we introduce the system equations and describe their temporal\ndiscretization on individual levels of refinement. Motivated by cosmological applications, the numerical schemes are formulated for a grid with a time dependent scale\nlength, a(t). Thus after a description of the expanding grid, we introduce the time\ndiscretization for the equations of hydrodynamics with gravity and the equations\nof motion for the collisionless component and then briefly outline the time step\nconstraints and code units.\n2.1. Comoving Frame\nCosmic expansion is described by the first Friedmann's equation which reads [27]\n\u00011/2\n\u0227\n= H0 \u03a9m a\u22123 + \u03a9k a\u22122 + \u03a9\u039b\na\n\n(1)\n\nwhere a(t) is the scale of the universe as a function of time; H0 measures the\ncurrent (a = 1) rate of cosmic expansion (the Hubble constant); \u03a9m , \u03a9k and \u03a9\u039b are\nparameters representing the current energy density associated to matter, curvature\nand 'dark' component, respectively, in units of the closure value. The solution to\n\n\f4\n\n! Please write \\authorrunninghead{<Author Name(s)>} in file !\n\nEq. (1) relating cosmic time and expansion parameter reads\nH0 t(a) =\n\nZ\n\n0\n\na\n\nd\u00e3\n\u00e3 (\u03a9m\n\n\u00e3\u22123\n\n1/2\n\n+ \u03a9k \u00e3\u22122 + \u03a9\u039b )\n\n(2)\n\nand admits simple solutions for \u03a9k = 0. Since the equations of motion in an\nexpanding Universe are most naturally solved in a comoving frame, which expands\nat the rate \u0227/a given by Eq. (1), we operate the change of coordinates\nx = a(t)\u22121 r\n\n(3)\n\nwhere r and x are the coordinates in the laboratory and comoving reference frame\nrespectively, and transform all differential operators (time derivatives, gradient,\nlaplacian) according to [27]\n1 \u2202\n\u2202\n\u2192\n\u2202r\na\n\u0012 \u0013\n\u0012 \u0013\n\u0012 \u0013\n\u0012 x\u0013\n\u0012 \u0013\n\u2202\n\u2202x\n\u2202\n\u0227x \u2202\n\u2202\n\u2202\n\u2192\n+\n=\n\u2212\n.\n\u2202t r\n\u2202t x\n\u2202t\n\u2202x t\n\u2202t x\na \u2202x t\n\n(4)\n(5)\n\nThe velocity\n\u0227\nr + a\u1e8b\n(6)\na\nis decomposed into a Hubble flow, (\u0227/a) r, and a peculiar proper component, u =\na \u1e8b. It is also convenient to introduce the density and pressure in terms of the\ncomoving volume x3 , as opposed to the proper volume r3 ,\n\u1e59 = \u0227x + a\u1e8b \u2261\n\n\u03c1(t, x = r/a) = a3 \u03c1p (t, r)\n3\n\nP (t, x = r/a) = a Pp (t, r)\n\n(7)\n(8)\n\nwhere the subscript p indicates the proper quantities.\n2.2. Hydrodynamics\nIn comoving coordinates, the hydrodynamics is described by the following set of\ninhomogeneous partial differential equations\n\u2202\u03c1 1 \u2202\n(\u03c1uk ) =\n+\n\u2202t\na \u2202xk\n\n0\n\n\u2202\u03c1ui\n\u0227\n1 \u2202\n1 \u2202\u03c6\n(\u03c1ui uk + P \u03b4ik) = \u2212 \u03c1ui \u2212 \u03c1\n+\n\u2202t\na \u2202xk\na\na \u2202xi\n\u2202\u03c1e 1 \u2202\n\u0227\n\u2202\u03c6\n1\n[(\u03c1e + P )uk ] = \u22122 \u03c1e \u2212 \u03c1uk\n+\n\u2202t\na \u2202xk\na\na\n\u2202xk\n\u0227\n\u2202\u03c1s 1 \u2202\n(\u03c1suk ) = \u22122 \u03c1s\n+\n\u2202t\na \u2202xk\na\n\n(9)\n(10)\n(11)\n(12)\n\nexpressing (from top to bottom) mass, momentum, energy and entropy conservation. Here, \u03c1 and P are the comoving density and pressure respectively, u is\nthe peculiar proper velocity, \u03c6 the proper gravitational potential, e \u2261 eth + ek =\nP/\u03c1(\u03b3 \u2212 1) + u2 /2 is the specific total energy, s = P/\u03c1\u03b3 is the specific entropy and\n\n\f! Please write \\titlerunninghead{<(Shortened) Article Title>} in file !\n\n5\n\n\u03b3 the gas adiabatic index. The first inhomogeneous terms on the right hand side\nof Eq. (10)-(12) describe the effects due to adiabatic cosmic expansion (\u221d \u0227/a). In\nparticular, the factor 2 for the last two equations arises by assuming that the internal energy of the gas is solely associated with translational degrees of freedom1 .\nFinally, gravity is described by the gravitational potential \u03c6, which is generated by\nthe matter distribution of both the collisional and the collisionless components.\nWe use a cell-centered discretization for our primary dependent variables: U (x, t) \u2261\n(\u03c1, \u03c1u, \u03c1e)T \u2192 Uin , where i \u2208 ZD indexes grid points in a space with D dimensions\nand n is a discrete time index. The starting point for our temporal discretization\nis a conservative finite-difference method for the hydrodynamic equations:\n\u0011\n\u0010\n1\n(13)\nU n+1,h = U n \u2212 \u2206t A(t) D * F~ n+ 2\nwhere D * F~ n+ 2 approximates the spatial derivative\nterms on the left-hand side\ni of\nh\nan+1/2 an+1/2\n1\n1\n, (a\n(11), A(t) is a diagonal matrix with elements an+1/2\n, an+1\nn+1 )2 , (an+1 )2 , and\n1\n\n\u2206t is the time step. We use an unsplit second-order Godunov's method [28, 29, 24]\nto compute the flux divergence. In addition to the cosmological expansion terms,\nthe gas and particle components couple through the force field which is solution to\nthe following Poisson's equation\n\u2206\u03c6 =\n\n4\u03c0G\n(\u03c1m \u2212 h\u03c1m i) .\na\n\n(14)\n\nHere \u03c1m = \u03c1gas + \u03c1part is the total comoving mass density; the particle density,\n\u03c1part , is computed through a Particle Mesh method (see details in the Appendix).\nWhen periodic boundary conditions are used, h\u03c1m i is the volume average, otherwise\nit is zero. The details of the spatial discretization for Poisson's equation are given\nin the next section. For now, we assume that we can compute the gravitational\nacceleration at cell centers, f i \u2248 \u2212\u2207\u03c6, with second order accuracy.\nTo compute the effect of the source terms, we need to compute them before and\nafter the hydrodynamic update, taking advantage of the fact that no sources appear\nin the density evolution equation:\n\uf8eb\n\uf8f6\n0\n\uf8ec n+1/2 n n+1\n\uf8f7\nf i /a\n+ \u03c1ni uni [(an /an+1 ) \u2212 1] \uf8f7\n\uf8ec\u03c1\nSin = \uf8ec i\n(15)\n\uf8f7\n\uf8ed\n\uf8f8\n\u2206(\u03c1ek ) + Pin [(an /an+1 )2 \u2212 1]\n\u03c1ni sni [(an /an+1 )2 \u2212 1]\nn+1/2\n\nwhere \u03c1i\n= (1/2) (\u03c1ni + \u03c1n+1\n), and \u2206(\u03c1ek ) = (1/2) [\u03c1n+1\n(un+1\n)2 \u2212 \u03c1ni (uni )2 ].\ni\ni\ni\nAfter the hydrodynamics update given in Eq.(13) we apply the source terms as\nfollows\nU n+1,h,s1 = U n+1,h + \u2206t S n .\n\n(16)\n\nThe above estimate of the source term, after being converted to primitive variable\nform, is also used in the hydrodynamic predictor step in order to obtain fully\n1 More generally, in D dimensions, the energy losses due to expansion are \u0117 /e\nth th = D(\u03b3 \u22121)\u0227/a\nfor the internal energy and \u0117k /ek = 2\u0227/a for the specific kinetic energy respectively.\n\n\f6\n\n! Please write \\authorrunninghead{<Author Name(s)>} in file !\n\ntime-centered fluxes. S n accounts for the expansion terms to the desired accuracy\nbut is only first order accurate as far as the gravity term is concerned (hence the\nsuperscript s1 ). After the new gravitational potential has been computed a source\ncorrection term is estimated as\n\uf8eb\n\uf8f6\n0\nn+1/2 \uf8ec\n\uf8f7\n1\n\u03b4f i\n1\nn+ 1\n\uf8ec\n\uf8f7\n\u0002\n\u0003\n\u03b4Si 2 = \u03c1n+1\n(17)\n\uf8ec\nn+1/2 \uf8f7\nn+1\n\uf8f8\n2 i\nan+1 \uf8ed un+1\n\u03b4f\n+\n\u2206t/4\na\ni\ni\n0\nn+1/1\n\nwith, \u03b4f i\n\n\u2212 f ni , and the final source update is\n= f n+1\ni\n1\n\nU n+1 = U n+1,h,s1 + \u2206t \u03b4S n+ 2 .\n\n(18)\n\n2.2.1. Hypersonic Flows\nAccretion flows induced by gravity are typically hypersonic and can be characterized by very large Mach numbers M \u2265 100. This situation is common in\ncosmological simulations [30].\nIn this case the total energy is largely dominated by the kinetic component,\nek \u223c M2 eth . Since conservative hydro-schemes track the total energy, e = eth + ek ,\nrelatively small errors in the partition of the two components can produce spurious\nvalues of eth . This is particularly worrisome when a 4-byte (single precision) digital\nrepresentation of the numerical data is employed. For this reason, we introduce\nthe additional equation (12) describing the evolution of the gas entropy. When the\nMach number of the bulk flow is very high, M \u2265 50, and away from shocks, it\nprovides a more accurate solution from the thermal energy than the total energy\nequation. Eq. (12) is naturally incorporated in the numerical scheme for hydrodynamics adopted here because of its conservative form. In addition, being a simple\nadvection equation, the conservative fluxes for its integration are a byproduct of\nthe Riemann solution and require virtually no extra effort to compute.\nThe equation for the internal energy could be alternatively integrated [31], but\nits non-conservative form makes it less attractive. Authors in Ref. [32] already\nemployed the entropy equation in order to improve the accuracy of their Total\nVariation Diminishing scheme for hypersonic flows, although their implementation\nrequired solving twice for the hydrodynamic equations with an extra cost of 30%.\nIt is worth pointing out that for high Mach number flows, errors in the velocity\nfield are propagated into the Riemann solver solution for the pressure at the cell\ninterface, P \u2217 , with a coefficient \u223c M, that is, largely amplified. More precisely we\nfind\n\u03b4\u2206u\n\u03b4P \u2217\n=\u03b3\nM\n(19)\n\u2217\nP\nu\nwhere \u2206u is the one dimensional velocity jump at the cell interface. However,\nas illustrated above, the pressure terms enter the hydrodynamic equations with a\nweight M\u22121 as compared to kinetic terms and, therefore, the numerical solution\nis not degraded in the case of high Mach number flows because of approximations\ninvolved in the Riemann solver solution.\n\n\f! Please write \\titlerunninghead{<(Shortened) Article Title>} in file !\n\n7\n\n2.3. Collisionless Component\nThe collisionless component is described by a set of particles whose evolution in\nphase space is computed according to\ndy\n1\n=\nu\ndt\na\n\u0227\n1\ndu\n= \u2212 u+ f\ndt\na\na\n\n(20)\n(21)\n\nwhere y and u are the comoving coordinate and peculiar proper velocity respectively. The acceleration acting on the particle, f , is obtained by first computing\nthe acceleration on the grid, using a cell- or face- centered scheme, and then by\ninterpolating it to the particle position through a Particle Mesh method [20].\nIn order to advance in time the particle positions and velocities we propose the\nfollowing integration scheme based on a kick-drift-kick sequence [33]: first the particles velocity and positions are updated as\nun+1/2 = un\n\nan\nan+1/2\n\ny n+1 = y n +\n\n+\n\n1\n\u2206t\nf n (y n )\n2\nan+1/2\n\n1\nun+1/2 \u2206t.\nan+1/2\n\n(22)\n(23)\n\nAfter computing the acceleration at the new timestep, the particle velocity is finally\nupdated as\nun+1 = un+1/2\n\n1\n\u2206t\nan+1/2\n+ n+1 f n+1 (y n+1 ) .\nan+1\na\n2\n\n(24)\n\nThe proposed scheme is reflexive and hence symplectic [34]. This has the nice\nproperty that the integral of motion will be conserved on average preventing secular accumulation of error and keeping the system about its true trajectory in\nphase space (see, e.g., discussion in [33]). We have also implemented an alternative method, based on the more common drift-kick-drift sequence, which does the\nfollowing: first particle positions at half the time step are predicted as\ny n+1/2 = y n +\n\n1 n \u2206t\nu\n,\nan\n2\n\n(25)\n\nthen particle positions and velocity are further temporarily updated to\nan\n1\n+ n+1 f n (y n+1/2 )\u2206t\nan+1\na\n1\n\u2206t\n= y n+1/2 + n+1 un+1,\u2217\n.\na\n2\n\nun+1,\u2217 = un\n\n(26)\n\ny n+1,\u2217\n\n(27)\n\nBased on the gravitational potential at the new time-step, a final correction term\nis applied, that allows second order accuracy\nun+1 = un+1,\u2217 +\ny n+1\n\n1\n\nan+1\n1\n= y n+1/2 + n+1\na\n\nh\ni \u2206t\nf n+1 (y n+1/2 ) \u2212 f n (y n+1/2 )\n2\nn+1 \u2206t\nu\n.\n2\n\n(28)\n(29)\n\n\f8\n\n! Please write \\authorrunninghead{<Author Name(s)>} in file !\n\nThe above scheme, however, is not fully reflexive. The need of temporary states\nthat approximate the solution at the end of the time step in order to calculate the\nfinal correction step, breaks the time symmetry of the scheme.\nNote that in both schemes, there is no need for storage of extra information about\neither the particle positions or their velocities at any old or intermediate step. In\naddition, the gravitational potential is computed only once per time step making\ntheir overall computational cost of rather inexpensive.\nIt should be noticed, however, that in the case of AMR reflexivity is lost even in\nthe former scheme without additional precautions. This occurs when a particle is\ntransferred to a different level of refinement, or even during a refinement operation.\nIn both cases, the gravitational potential changes as a result of these procedures.\nSince this change takes place after the correction steps, the backward application\nof the scheme would not reproduce the initial configuration. Although in principle\nthis could be fixed by storing information about the last timestep and acceleration\nfor each particle, we have not implemented any of this.\n2.4. Time Step\nThe time-step is subjected to the following constraints: In accord with the\nCourant-Friedrichs-Lewy (CFL) condition for stability of finite difference methods [35], we require\n\u2206t = Chydro\n\na(t) \u2206x\n,\nMax(|ui | + cs )\n\n(30)\n\nwhere Chydro < 1 is the CFL number, and ui and cs are the fluid velocity in the ith\ndirection and sound speed of the flow respectively. In presence of a source term, S,\nwe modify the estimate of the fluid velocity according to\n|ui | + cs \u2212\u2192\n\n[(|ui | + cs\n\n)2\n\n|Si | \u2206x\n+ 2 |Si | \u2206x]1/2 \u2212 (|ui | + cs )\n\n(31)\n\nwhere Si is the component of the source term affecting the velocity ui . For the\npurpose of accuracy, rather than stability, for the collisionless particles we likewise\nrequire\n\u2206t = Cpart\n\na(t) \u2206x\nMax(|ui |)\n\n(32)\n\nwith Cpart < 1 and with Ui corrected as in Eq. (31) but with cs = 0. Finally,\nwe require that the background expansion remains limited during each integration\ncycle. This allows us to time center the value of a(t) in our integration schemes\nabove and neglect its changes with time. We thus enforce\n\u2206t < Cexp\nwith Cexp \u2243 (1 \u2212 2) \u00d7 10\u22122 .\n\na\n\u0227\n\n(33)\n\n\f! Please write \\titlerunninghead{<(Shortened) Article Title>} in file !\n\n9\n\n2.5. Code Units\nThe natural choice for the dimensional units of the above physical equations is\ngiven by the following lengths, mass and time scales\nL\u2217 = Lbox\n\n(34)\n\n\u03c1 \u2217 = \u03c1 c \u03a9m\n\n(35)\n\nt\u2217 =\n\nH0\u22121\n\n(36)\n\nwhereLbox is the size of the computational box and \u03c1c \u2261 3 H02 /8\u03c0 G = 1.879 \u00d7\n10\u221229 h2 is the critical density of the universe, with h \u2261 H0 /100 km s\u22121 Mpc\u22121 .\nThe units for the other quantities are defined in terms of these as\nu\u2217 = H0\u22121 Lbox\nP\u2217 =\n\u03c6\u2217 =\n\n\u03c1\u2217 u2\u2217\nu2\u2217\n\nT\u2217 = mproton P\u2217 /kB \u03c1\u2217\n\n(37)\n(38)\n(39)\n(40)\n\nwhere mproton is the proton mass and kB Boltzmann's constant.\n3. ADAPTIVE MESH REFINEMENT APPROACH\nIn this section we outline the structure of the AMR algorithm. After introducing\nthe formal notation, we describe in some detail the scheme for hydrodynamics with\nself-gravity and its modifications when a collisionless component is also included,\nin the simple case of two levels of refinement. We then describe the extension of\nthe scheme to the general multilevel case.\n3.1. Multilevel Volume Discretization, Variables and Operators\nThe underlying discretization of the D-dimensional space is given as points\n(i0 , ..., iD\u22121 ) = i \u2208 ZD . The problem domain is discretized using a grid \u0393 \u2282 ZD\nthat is a bounded subset of the lattice. \u0393 is used to represent a finite-volume discretization of the continuous spatial domain into a collection of control volumes:\ni \u2208 \u0393 represents a region of space,\nVi = [ih, (i + u)h]\n\n(41)\n\nwhere h is the mesh spacing, and u \u2208 ZD is the vector whose components are all\nequal to one. We can also define face-centered discretizations of space based on\nd\nthose control volumes: \u0393e = {i \u00b1 12 ed : i \u2208 \u0393}, where ed is the unit vector in the\nd\nd direction. \u0393e is the discrete set that indexes the faces of the cells in \u0393 whose\nnormals are ed :\nd\n1\nAi+ 21 ed = [(i + ed )h, (i + u)h], i + ed \u2208 \u0393e .\n2\nWe define cell-centered discrete variables on \u0393:\n\n\u03c6 : \u0393 \u2192 Rm\n\n(42)\n\n\f10\n\n! Please write \\authorrunninghead{<Author Name(s)>} in file !\n\nand denote by \u03c6i \u2208 Rm the value of \u03c6 at cell i \u2208 \u0393. We can also define face-centered\nvector fields on \u0393:\nd\nF~ = (F0 , ..., FD\u22121 ) , Fd : \u0393e \u2192 Rm\n\nand define a discretized divergence operator on such a vector field:\nD\u22121\n1 X\n(D * F~ )i =\n(Fd,i+ 21 ed \u2212 Fd,i\u2212 12 ed ), i \u2208 \u0393.\nh\n\n(43)\n\nd=0\n\nWe will find it useful to define a number of operators on points and subsets of ZD .\nWe define a coarsening operator by: Cr : ZD \u2192 ZD ,\n\u0012\u0016 \u0017\n\u0016\n\u0017\u0013\ni0\nid\u22121\nCr (i) =\n, ...,\nr\nr\nwhere r is a positive integer. These operators acting on subsets of ZD can be\nd\nd\nextended in a natural way to the face-centered sets: Cr (\u0393e ) \u2261 (Cr (\u0393))e . For any\nset \u03a5 \u2286 \u0393, we define G(\u03a5, r), r > 0, to be the set of all points within a | * |-distance\nr of \u03a5 that are still contained in \u0393:\nG(\u03a5, r) = \u0393 \u2229 \u222a \u03a5 + i\n|i|\u2264r\n\nwhere |i| =\n\nmax (|id |). We can extend the definition to the case r < 0 :\n\nd=0...D\u22121\n\nG(\u03a5, r) = \u0393 \u2212 G(\u0393 \u2212 \u03a5, \u2212r).\nThus G(\u03a5, r) consists of all of the points in \u03a5 that are within a distance \u2212r from\npoints in the complement of \u03a5 in \u0393. In the case that there are periodic boundary\nconditions in one or more of the coordinate directions, we think of the various sets\nappearing here and in what follows as consisting of the set combined with all of\nits periodic images for the purpose of defining set operations and computing ghost\ncell values. For example, G(\u03a5, r) is obtained by growing the union of \u03a5 with its\nperiodic images, and performing the intersections and differences with the union of\n\u0393 with its periodic images.\nWe use a finite-volume discretization of space to represent a nested hierarchy\nof grids that discretize the same continuous spatial domain. We assume that our\nproblem domain can be discretized by a nested hierarchy of grids \u03930 ...\u0393lmax , with\nl\n\u0393l+1 = Cn\u22121\n(\u0393l ), and that the mesh spacings hl associated with \u0393l satisfy hhl+1 =\nl\nref\n\nnlref . The integer nlref is the refinement ratio between level l and l + 1. These\nconditions imply that the underlying continuous spatial domains defined by the\ncontrol volumes are all identical. In this paper we will further assume nlref is even.\nIn the case where there are only two levels, we will refer to them as coarse and fine,\nwith the notation {l = 0, l = 1} \u2192 {c, f }, and n0ref \u2192 nref .\nWe make two assumptions about the nesting of grids at successive levels. We\nrequire the control volume corresponding to a cell in \u03a9l\u22121 is either completely\ncontained in the control volumes defined by \u03a9l or its intersection has zero volume.\n\n\f11\n\n! Please write \\titlerunninghead{<(Shortened) Article Title>} in file !\n\nWe also assume that there is at least one layer of level\u2013l cells separating level\u2013(l +1)\ncells from level\u2013(l \u2212 1) cells: G(Cnlnref (\u03a9l+1 ), 1) \u2286 \u03a9l . We refer to grid hierarchies\nthat meet these two conditions as being properly nested.\nFrom a formal numerical analysis standpoint, a solution on an adaptive mesh hilmax\nerarchy {\u03a9l }l=0\napproximates the exact solution to the Partial Differential Equations only on those cells that are not covered by a grid at a finer level. We define\nthe valid region of \u03a9l as\n\u03a9lvalid = \u03a9l \u2212 Cnlref (\u03a9l+1 ).\nA composite array \u03c8 comp is a collection of discrete values defined on the valid\nregions at each of the levels of refinement:\nmax\n\u03c8 comp = {\u03c8 l,comp }ll=0\n, \u03c8 l,comp : \u03a9lvalid \u2192 Rm .\n\nWe can also define valid regions and composite arrays for face-centered variables:\nd\nd\nd\nl,ed\n\u03a9l,e\n\u2212 Cnlref (\u03a9l+1,e ). Thus, \u03a9l,e\nvalid = \u03a9\nvalid consists of d-faces that are not covered by the d-faces at the next finer level. A composite vector field F~ comp =\n{F~ l,valid }lmax is defined as follows:\nl=0\n\nd\n\nl,comp\n) , Fdl,comp : \u03a9l,e\nF~ l,comp = (F0l,comp . . . FD\u22121\nvalid \u2192 R\n\nThus a composite vector field has values at level l on all of the faces not covered\nby faces at the next finer level.\nWe want to define a composite divergence Dcomp (F~ l+1,comp , F~ l,comp )i for i \u2208\nl\n\u03a9valid . To do this, we construct an extension of F~ l,comp to the edges adjacent\nto \u03a9lvalid that are covered by fine level faces. On the valid coarse-level d-faces,\nd\n\nFdl = Fdl,comp . On the faces adjacent to cells in \u03a9lvalid , but not in \u03a9l,e\nvalid , we set\nl+1,comp\nl+1\nl\ni, the average of Fd onto the next coarser level:\nFd = hFd\nhFdl+1 iil + 12 ed =\n\n1\n(nref )D\u22121\n\nX\n\ni+ 12 ed \u2208F\n\n1 d\nl+1\nl+1\nl+1\ne \u2208 \u03b6d,+\n\u222a \u03b6d,\u2212\n.\nFd,i+\n1 d , il +\ne\n2\n2\nd\n\nl+1\nconsists\nHere F d is the set of all fine level d-faces that are covered by Ail + 21 ed . \u03b6d,\u00b1\nl\nl+1\nof all the d-faces in \u03a9 on the boundary of \u03a9 , with valid cells on the low (\u00b1 = \u2212)\nor high (\u00b1 = +) side:\n\n1\nl+1\n\u03b6d,\u00b1\n= {i \u00b1 ed : i \u00b1 ed \u2208 \u03a9lvalid , i \u2208 Cnlref (\u03a9l+1 )}.\n2\nGiven that extension, our composite divergence is defined as:\nDcomp (F~ l+1,comp , F~ l,comp )i = D * F~il , i \u2208 \u03a9lvalid .\n\n(44)\n\nIt is useful to express Dcomp as the application of the level divergence operator\nD applied to extensions of F~ l,comp to the entire level, followed by a step that\ncorrects the cells in \u03a9lvalid that are adjacent to \u03a9l+1 . We define a flux register\n\n\f12\n\n! Please write \\authorrunninghead{<Author Name(s)>} in file !\n\n\u03b4 F~ l+1 associated with the fine level\nl+1\n\u03b4 F~ l+1 = (\u03b4F0l+1 , ..., \u03b4FD\u22121\n)\nl+1\nl+1\n\u03b4Fdl+1 : \u03b6d,+\n\u222a \u03b6d,\u2212\n\u2192 Rm .\n\nLet F~ l be any coarse level vector field that extends F~ l,comp , i.e.\nd\n\nl,e\nFdl = Fdl,comp on \u03a9valid\n.\n\nThen, for i \u2208 \u03a9lvalid ,\nDcomp (F~ l+1,comp , F~ l,comp )i = (DF~ l )i + DR (\u03b4 F~ l+1 )i ,\n\n(45)\n\nwhere \u03b4 F~ l+1 is a flux register set to be\nl\nl\n\u222a \u03b6d,\u2212\n\u03b4Fdl+1 = hFdl+1 i \u2212 Fdl on \u03b6d,+\n\nand DR is the reflux divergence operator, given by the following for valid coarse\nlevel cells adjacent to \u03a9l+1 :\nDR (\u03b4 F~ l+1 )i =\n\nD\u22121\n1 X\nhl\nd=0\n\nX\n\nl+1\n\u00b1\u03b4Fd,i\u00b1\n1 d.\ne\n\n\u00b1=+,\u2212:\nl+1\ni\u00b1 12 ed \u2208\u03b6d,\u2213\n\n2\n\nFor the remaining cells in \u03a9lvalid , DR (\u03b4 F~ l+1 ) is defined to be identically zero.\nWe can use this notation to define the discretizations of Poisson's equation we will\nbe using to compute self-gravity. On a single level, \u03a9l , we define \u2206l , the discrete\nLaplacian, to be the standard 2D + 1 point operator, with the values used on ghost\ncells computed using quadratic interpolation:\n\u2206l \u03c6l = D * F~ l,\u03c6\n\u03c6 d \u2212 \u03c6i\nFdl,\u03c6 = i+e l\nh\n\u03c6li = I(\u03c6l , \u03c6l\u22121 )i for i \u2208 \u2202\u03a9l\n\n(46)\n(47)\n(48)\n\nwhere \u2202\u03a9l \u2261 G(\u03a9l , 1) \u2212 \u03a9l . Here the interpolation function I is an O(h3 ) estimate\nof the value on the ghost cell obtained from interpolating from values of \u03c6l\u22121 on\nl\u22121\n\u03a9valid\nand from the values of \u03c6l on \u03a9l ; for details, see [36]. We can then define the\ncomposite Laplacian \u2206comp applied to all of the valid data on all levels, in terms\nof that operator and refluxing operations.\n(\u2206comp,l \u03c6)i = (\u2206l \u03c6l,ext )i + DR (\u03b4 F~ l,\u03c6 ) for i \u2208 \u03a9lvalid\n\n(49)\n\n\u03b4 F~ l,\u03c6 = hF~ l+1,\u03c6 i \u2212 F~ l,\u03c6\n\n(50)\n\nwhere \u03c6l,ext is some extension of \u03c6l,comp to all of \u03a9l . The resulting operator depends\nonly on the valid values of \u03c6 in the grid hierarchy (modulo roundoff considerations;\ncf. Ref. [37] for further details).\n\n\f! Please write \\titlerunninghead{<(Shortened) Article Title>} in file !\n\n13\n\n3.2. AMR for Compressible Flows with Self-Gravity\nThe starting point for this work is the algorithm described in [2] for solving\nhyperbolic conservation laws on nested refined grids. For the case of two levels, we\nassume that the solution on both levels is known at time tc . The basic steps to\nevolve the solution on both levels to time tc + \u2206tc can be summarized as follows:\n1. Update the solution on the coarse grid:\nU c (tc + \u2206tc ) = U c (tc ) \u2212 \u2206tc (D * F~ c ) + \u2206tc S(U c ) on \u03a9c .\n\n(51)\n\nHere S(U c ) is computed as in Eq. (15) (with the body force, f , set to zero), and\nthe discrete fluxes F~ are local functions of U c . We also initialize flux registers\nassociated with \u03a9f using the same fluxes\n\u03b4 F~ f = \u2212F~ c .\n2. Advance the solution from tf to tf +\u2206tf on the fine grid nref times, nref \u2206tf =\n\u2206tc :\nU f (tf + \u2206tf ) = U f (tf ) \u2212 \u2206tf (D * F~ f ) + \u2206tS(U f ) on \u03a9f\n1 ~f\nhF i\n\u03b4 F~ f +=\nnref\n\n(52)\n\ntf += \u2206tf .\nAny values required to compute the stencil that are contained in \u0393f \u2212 \u03a9f are\ncomputed by interpolating the coarse grid values U c (tc ), U c (tc + \u2206tc ), using linear\ninterpolation in time, and piecewise linear interpolation in space.\n3. Synchronize the values at the old and new times:\nU c (t + \u2206tc ) = hU f (t + \u2206tc )i on Cnref (\u03a9f )\n\n(53)\n\nU (t + \u2206t ) += DR (\u03b4 F~ )\nc\n\nc\n\nwhere h*ii denotes the arithmetic average onto the coarse cell i of all of the values\ndefined on fine grid cells contained in i.\nTo extend this algorithm to the case of self-gravity, we must solve the Poisson's\nequation for the gravitational potential due to the mass distribution of the fluid\non the coarse and fine levels. As usual the coarse level is advanced first, and the\nsolution at tc + \u2206tc is used to provide time interpolated boundary conditions for\nthe fine level at intermediate time steps. In the case of hyperbolic equations the\nfinite characteristic speeds ensure that a fully consistent multilevel solution can\nbe recovered at synchronization time with the refluxing operation. Because of its\nelliptic nature, however, in order to preserve its multilevel character Poisson's equation should be solved simultaneously on all levels. Notice that the coupling among\nlevels is enforced by the continuity of the potential (Dirichlet) and of its normal\nderivative (Neumann) at the coarse/fine grid interface. Therefore, to maintain the\nmultilevel character of Poisson's equation when the levels are not synchronized yet,\nwe obtain a single level solution to Poisson's equation on the coarse level and apply\n\n\f14\n\n! Please write \\authorrunninghead{<Author Name(s)>} in file !\n\na lagged estimate of the effect of the coarse/fine matching conditions at refinement\nboundaries, following the ideas developed in [25, 26, 38] for incompressible fluids.\nThis leads to the following modifications to the algorithm given above.\n0. At simulation start, when all levels are synchronized, we compute a composite\ngrid solution to Poisson's equation\n(Lcomp,c \u03c6comp )(tc )i = \u03c1c (tc )i\n(L\n\ncomp,f\n\ncomp\n\n\u03c6\n\nc\n\nf\n\ni \u2208 \u03a9cvalid\n\nc\n\n)(t )i = \u03c1 (t )i\n\ni\u2208\u03a9\n\n(54)\n\nf\n\n(55)\n\nas well as the coarse grid solution\n(Lc \u03c6c )(tc ) = \u03c1c (tc ) on \u03a9c .\n\n(56)\n\na(t)\n\u2206 with superscripts l, c,\nHere, and in what follows, we will denote by L(t) \u2261 4\u03c0G\nf , comp indicating the particular discretization of the Laplacian operator.\n1. Together with U (tc ), the acceleration f c (t) derived from the composite solution of the potential on the coarse grid is used to compute the coarse grid fluxes\nand source terms. After updating the conserved quantities using (51), we compute\nthe coarse grid potential at the new time\n\n(Lc \u03c6c )(tc + \u2206tc ) = \u03c1c (tc + \u2206tc )\nc,comp\n\n\u03c6\u0303\n\nc\n\nc\n\nc\n\nc\n\nc\n\nc,comp\n\n(t + \u2206t ) = \u03c6 (t + \u2206t ) + (\u03c6\n\n(57)\nc\n\nc\n\nc\n\n(t ) \u2212 \u03c6 (t ))\n\n(58)\n\nwhere in the latter step we have approximately corrected the coarse grid single-levelsolution of the potential for the effects due to the solution on the finer grid [25, 26].\nWe use the solution in Eq. (58) with \u03c6c,comp (tc ) to obtain boundary conditions\ninterpolated in time for the potential at the fine level at intermediate timesteps.\n2. We apply the update (51) on the finer level. At tf = tc in order to compute\nthe hydrodynamic fluxes and source terms we use the force, f f , derived from the\ncomposite potential solution to Eq. (55). At intermediate steps, tc < tf < tc +\n\u2206tc , we solve the following Poisson's equation on the fine grid with interpolated\nboundary conditions\n(Lf \u03c6f )(tf ) = \u03c1f (tf ) on \u03a9f\nf\n\nf\n\nf\n\nf\n\nc\n\nf\n\n\u03c6 (t ) = I[\u03c6 (t ), \u03c6\u0303 (t )] on \u2202\u03a9\n\n(59)\nf\n\nwhere \u03c6\u0303c (tf ) is obtained by linear interpolation in time as\n\u03c6\u0303c (tf ) = (1 \u2212 \u03b1) \u03c6c,comp (tc ) + \u03b1 \u03c6\u0303c,comp (tc + \u2206tc ) , \u03b1 =\n\ntf \u2212 tc\n.\n\u2206tc\n\nWe compute the forces at the new timestep and apply the correction (17)-(18) to\nthe fluid momentum and kinetic energy.\n3. At time of synchronization, tf = tc + \u2206tc , we solve the set of equations\n(54)-(56), for the composite and single level solution of the potential. We use the\ncomposite solution to derive the new force, f n+1 , and apply momentum and kinetic\nenergy corrections (17)-(18) to obtain time centered forces on both coarse and fine\nlevels. The flow of the calculation restarts from step 1 with the gravitational force\nknown at all levels.\n\n\f! Please write \\titlerunninghead{<(Shortened) Article Title>} in file !\n\n15\n\n3.3. AMR with Particles\nDue to the time refinement character of the AMR technique the solution on\ndifferent levels is advanced with different timesteps. This implies that the density\nfield represented by the particles evolved on the finer level may not be available\non the coarser level unless they are synchronized. However, this is information is\nnecessary to solve Poisson's equation. Therefore, we find it convenient to introduce\neffective particles to recover such information in a computationally inexpensive way\nand without compromising the code accuracy.\nThus we introduce an aggregation operation P \u2192 hPil that projects a collection\nof particles covered by \u03a9l onto a set of effective particles, with no more that one\nparticle per cell. If p \u2208 hPil , then\nX\n\nmp =\n\n(60)\n\nmp\u2032\n\np\u2032 :xp\u2032 \u2208Vi\n\nxp =\nup =\n\n1\nmp\n1\nmp\n\nX\n\nmp\u2032 xp\u2032\n\n(61)\n\nX\n\nmp\u2032 up\u2032\n\n(62)\n\np\u2032 :xp\u2032 \u2208Vi\n\np\u2032 :xp\u2032 \u2208Vi\n\nThe aggregation operation conserves the monopole and dipole terms but causes\ninformation to be lost on the quadrupole moment of the aggregated particles [39],\nwhich provides corrections to the potential of order h2 . Thus the aggregation\nstep preserves second order accuracy. Note, also, that the potential and force\nfields obtained through the aggregated particles are only used to provide boundary\nconditions for the finer level.\nRestricting again the discussion to the case of two levels of refinement, the changes\nin the algorithm described above are given as follows:\n0. At simulation start, we partition the particles into ones that will be evolved\nusing the coarse and fine time steps. If P is the set of all particles,\n\b\nP f = p \u2208 P : xp \u2208 G(\u03a9f , \u2212nref nbuf )\nc\n\nf\n\nP =P \u2212P .\n\n(63)\n(64)\n\nThe parameter nbuf is chosen so that the support for the Particle-Mesh interpolation function, used to calculate the force acting on the particle and the particle\nmass distribution on the grid, is completely contained in \u03a9f for all of the fine grid\ntime steps, nref \u2206tf = \u2206tc . Using nbuf = 1 and Cpart = 0.5 is sufficient for all\nchoices of Particle-Mesh scheme used here (see Appendix 1).\nWe then define the set hP f ic of fine particles aggregated on the coarse grid using\nEq. (60)-(62).\n\n\f16\n\n! Please write \\authorrunninghead{<Author Name(s)>} in file !\n\nFinally, in computing the gravitational potential the densities in Eq. (54)-(56) are\nmodified to account for the mass distribution of the particles:\n!\nX\n(i + 21 u) hc \u2212 xp (tc )\nc,f luid c\nc c\n(65)\nmp W\n\u03c1i (t ) = \u03c1i\n(t ) +\nhc\np\u2208P c \u222ahP f ic\n!\nX\n(i + 12 u) hf \u2212 xp (tc )\nf c\nf,f luid c\nmp W\n\u03c1i (t ) = \u03c1i\n(t ) +\nhf\np\u2208P f\n(66)\n!\nX\n(i + 12 u) hf \u2212 xp (tc )\n.\n+\nmp W\nhc\nc\np\u2208P\n\nHere W is one of the Particle-Mesh assignment schemes used to spread the particle\nmass on the grid, described in Appendix 1. Note that the addition to \u03c1c of the\ndensity field due to hP f ic has no effect on the composite solution, because the\nsupport of W for each particle \u2208 hP f ic is contained entirely in Cnref (\u03a9f ).\n1. The gravitational force resulting from the composite solution of the potential\nis used to compute both the fluid fluxes and source terms, as well as to perform\nthe update (22)-(23) for the particles in P c \u222a hP f ic . For the latter, we interpolate\nthe accelerations from the grid cells to particle positions with one of the methods\ndescribed in Appendix 1.\n2. At the end of each fine time step, while tf + \u2206tf < tc + \u2206tc , we compute the\nnew fine potential, \u03c6f , modifying the mass density as\n!\nX\n(i + 12 u) hf \u2212 xp (tf )\nf f\nf,f luid f\nmp W\n\u03c1 (t )i = \u03c1\n(t )i +\nhf\np\u2208P f\n(67)\n!\nX\n(i + 21 u) hf \u2212 xp (tf )\nf\n,i\u2208\u03a9\n+\nmp W\nhc\nc\np\u2208P\n\nwhere the positions of the particles in P c at the intermediate times are given by\nlinear interpolation between xp (tc ) and xp (tc + \u2206tc ). We then use the acceleration\ndue to this field to update the fine particle velocities using (24), and the fine fluid\nstate using (17)-(18).\n3. The synchronization step is analogous to the one in Sec. 3.2: we calculate a\nsingle grid and composite grid solution of the potential using the total mass density\ndistribution of fluid and particles given by Eq. (65)-(66). The gravitational force\nderived from the composite potential is used to apply the corrections to the particle\nvelocity, given in Eq. (24), and to the fluid momentum and kinetic energy, given\nin Eq. (17)-(18), at all levels. Finally, the sets P c , P f and hP f ic are upgraded\nfollowing the definitions in (63)-(64) to account for the new particle positions. The\nflow of the calculation restarts from step 1.\n3.4. The General Multilevel Algorithm\nFor the case of a general (lmax +1)-level calculation, we assume that at simulation\nstart all the particles have been partitioned into groups corresponding to the levels\non which they shall be advanced, and that the particles being advanced by finer\n\n\f! Please write \\titlerunninghead{<(Shortened) Article Title>} in file !\n\n17\n\ngrids have been aggregated into effective particles for the next coarser levels. This\nis summarized in the procedure:\nfor l = 0, .\b. . lmax \u2212 1 do\nP l+1 = x \u2208 P l : xp (tl ) \u2208 G(\u03a9l+1 , \u2212nref nbuf )\nP l \u2190 P l \u2212 P l+1\nend for\nPclmax = \u2205\nfor l = lmax \u2212 1, . . . , 0 do\nPcl = hP l+1 \u222a Pcl+1 il\nend for\nWe can then describe the algorithm for advance(l) that advances the solution\nat level l, 0 \u2264 l \u2264 lmax by one time step. We assume that the solution is known at\ntime tl + \u2206tl in a process that includes a recursive application of advance. At the\nbeginning of advance, we assume that: we know the fluid state U l and particle\nstate P l associated with that level at time tl ; we know the fluid, particle, and\npotential at the next coarse level at times tl\u22121 , tl\u22121 + \u2206tl\u22121 ; a composite solution\nas well as single level solution of the gravitational potential at time tl has been\ncomputed on level l \u2212 1 and on all finer levels;\nl\u22121\nWe then advance the solution by a time step \u2206tl , with nref\n\u2206tl = \u2206tl\u22121 , as\nfollows:\n1. Using U (tl ) along with the accelerations, f li , i \u2208 \u03a9l , computed from \u03c6l , we\ncalculate the hyperbolic fluxes F~ l and the source terms S(tl ). We update the\nconserved quantities\nU (tl + \u2206tl ) = U (tl ) \u2212 \u2206tl D * F~ l + \u2206tl S l (tl )\n\n(68)\n\n\u03b4F l+1 = \u2212F~ l if l < lmax\n\u03b4F l += hF~ l i if l > 0\nand advance the positions and velocities of the particles in P l \u222a Pcl using (22) and\n(23).\n2. With tl \u2190 tl + \u2206tl , we solve Poisson's equation on level l\n!\n1\nl\nl\nX\nu)\nh\n\u2212\nx\n(t\n)\n(i\n+\np\n2\n(69)\n(Ll \u03c6l )(tl )i = \u03c1f luid, l (tl )i +\nmp W\nhl\nl\np\u2208p\n!\n!\nX\nX\n(i + 21 u) hl \u2212 xp (tl )\n(i + 12 u) hl \u2212 xp (tl )\n+\n, i \u2208 \u03a9l\nmp W\n+\nmp W\nhc\nhl\u22121\nl\u22121\nl\np\u2208pc\n\np\u2208p\n\n\u03c6l (tl )i = I[\u03c6l (tl ), \u03c6\u0303l\u22121 (tl )]i , i \u2208 \u2202\u03a9l\nwhere \u03c6\u0303l\u22121 (t) is obtained by linear interpolation in time between \u03c6\u0303l\u22121,comp (tl\u22121 )\nand \u03c6\u0303l\u22121,comp (tl\u22121 + \u2206tl\u22121 ) with the latter defined in Eq. (58). As in Eq. (58) we\nthen estimate\n\u03c6\u0303l,comp (tl ) = \u03c6l (tl ) + (\u03c6l,comp (tl\u22121 ) \u2212 \u03c6l (tl\u22121 ))\n\n(70)\n\n\f18\n\n! Please write \\authorrunninghead{<Author Name(s)>} in file !\n\nwhich is used to provide boundary conditions for the potential at the next finer\nlevel, \u03c6l+1 (t).\n3. We call advance recursively nlref times.\ntl+1 = tl\nwhile tl+1 < tl + \u2206tl do\nadvance(l + 1)\ntl+1 = tl+1 + \u2206tl+1\nend while\n\u2032\n\n4. If tl\u22121 < tl < tl\u22121 +\u2206tl\u22121 , we obtain {\u03c6l ,comp (tl )}l\u2032 \u2265l by solving the composite\nequations :\n!\n1\nl\u2032\nl\nX\nu)h\n\u2212\nx\n(t\n)\n(i\n+\n\u2032\n\u2032\np\n2\n(71)\nmp W\n(Lcomp,l \u03c6comp )(tl )i = \u03c1f luid,l (tl )i +\nh l\u2032\n\u2032\np\u2208P l\n!\n\u2032\nX\n(i + 12 u)hl \u2212 xp (tl )\nmp W\n+\nhl\u2032 \u22121\nl\u2032 \u22121\np\u2208P\n\n\u2032\n\ni \u2208 \u03a9lvalid\n\n,\n\nl\u2032 = l, ..., lmax\n\n\u03c6l,comp (tl )i = I[\u03c6l,comp (tl ), \u03c6\u0303l\u22121 (tl )]i , i \u2208 \u2202\u03a9l .\nThe field so obtained is used to compute accelerations at the new time, and update\nthe fluid and particle velocities using (17) - (18) and (24) respectively.\n5. The solution at level l is synchronized with the solutions at the finer levels.\nU (tl + \u2206tl ) = hU (tl+1 )i on Cnlref (\u03a9l+1 )\nU (tl + \u2206tl ) += DR (\u03b4 F~ l+1 )\n\u2032\n\n\u2032\n\n\u2032\n\nWe upgrade the sets P l for l\u2032 = l\u22121, ..., lmax and hP l +1 il for l\u2032 = l\u22121, ..., lmax \u22121,\naccording to the new particle positions. The flow of the calculation restarts from\nstep 1.\n4. CONVERGENCE TESTS\nWe have implemented the above schemes in a Cosmological Hydromagnetic AMR\nRadiation Many-body (CHARM) code. The code is based on the CHOMBO AMR\nlibrary and it is implemented in a hybrid C++/Fortran77 language. Additional\nphysics modules, such as radiation [40], cosmic-rays [41, 42] and magnetohydrodynamics will be presented elsewhere. In the following, we focus on numerical tests\nto assess the performance of the algorithms in terms of accuracy and applicability\nto problems of direct interest. Performance tests will be presented elsewhere.\nUnless explicitly stated otherwise, in the following we use these CFL coefficients\nfor the time step: Chydro = Cpart = 0.5 and Cexp = 0.01. In addition, we restrict\nthe results to the case of a TSC interpolation scheme which, in accord with previous\nauthors, we find to give the most accurate results.\n\n\f! Please write \\titlerunninghead{<(Shortened) Article Title>} in file !\n\n19\n\nTABLE 1\nConvergence tests: collisionless case\u2020\nNpart\n\nL1\n\nR1\n\n8\n16\n32\n64\n128\n\n1.3e-07\n3.5e-08\n8.9e-09\n2.2e-09\n5.6e-10\n\n1.9\n2.0\n2.0\n2.0\n\u2013\n\n8\n16\n32\n64\n128\n\n1.3e-04\n3.5e-05\n8.8e-06\n2.2e-06\n5.5e-07\n\n8\n16\n32\n64\n128\n\n6.5e-02\n1.7e-02\n4.4e-03\n1.1e-03\n2.8e-04\n\nL2\n\nR2\n\nL\u221e\n\nR\u221e\n\nposition\n1.4e-07\n3.9e-08\n9.8e-09\n2.4e-09\n6.2e-10\n\n1.9\n2.0\n2.0\n1.9\n\u2013\n\n1.9e-07\n5.4e-08\n1.3e-08\n3.0e-09\n9.8e-10\n\n1.8\n2.0\n2.1\n1.6\n\u2013\n\n1.9\n2.0\n2.0\n2.0\n\u2013\n\nvelocity\n1.4e-04\n3.8e-05\n9.7e-06\n2.4e-06\n6.2e-07\n\n1.9\n2.0\n2.0\n1.9\n\u2013\n\n1.9e-04\n5.3e-05\n1.3e-05\n3.0e-06\n9.7e-07\n\n1.8\n2.0\n2.1\n1.6\n\u2013\n\n1.9\n2.0\n2.0\n2.0\n\u2013\n\nforce\n7.1e-02\n1.9e-02\n4.8e-03\n1.2e-03\n3.1e-04\n\n1.9\n2.0\n2.0\n1.9\n\u2013\n\n9.4e-02\n2.7e-02\n6.5e-03\n1.5e-03\n4.8e-04\n\n1.8\n2.0\n2.1\n1.6\n\u2013\n\n\u2020 We use equal number of cells and particles, N\npart = Ncell , a cell-centered force scheme, and\n\u2206t\na constant \u2206x\n= 1.6 \u00d7 10\u22124 .\n\nErrors and convergence rates are calculated as follows. At a given resolution, r,\nfor any given cell or particle, i, we estimate the error on a computed quantity, qrc (i),\nwith respect to the analytic solution,q a (i), as\n\u03b4qr (i) = qrc (i) \u2212 qra (i).\n\n(72)\n\nWe then compute the n-norm of the error, i.e.\nLn (\u03b4qr ) = k\u03b4qr kn =\n\nhX\n\n|\u03b4qr (i)|n vi\n\ni1/n\n\n(73)\n\nwhere vi is either the i-th cell volume or the inverse of the number of particles;\nfinally we estimate the convergence rate as\nRn =\n\nln[Ln (\u03b4qr )/Ln (\u03b4qs )]\n.\nln(\u2206xr /\u2206xs )\n\n(74)\n\nFor the cases studied below we report the L1 , L2 and L\u221e norm of the errors.\n4.1. Zel'dovich's Pancake\nWe begin with a classical test problem for cosmological codes, the evolution\nof a one-dimensional plane-wave perturbation in an expanding background. In\n\n\f20\n\n! Please write \\authorrunninghead{<Author Name(s)>} in file !\n\nFIG. 1.\nL2 norm of the error in position (top), velocity (center) and force (bottom) as\na function of the number of grid cells. Left panels correspond to the case in which the number\nof particles and grid cells is the same, Ncell = Npart . Central and right panels correspond to\nNpart = 12 Ncell , with particles initially placed either at cell nodes (middle panels) or at cell\ncenters (right panels). In all cases a two point cell centered force stencil is used. See legend for\nthe meaning of the symbols (UG= Uniform Grid, a is the expansion parameter).\n\nZel'dovich's formulation [43], the comoving position and peculiar velocities of collisionless matter evolve as\nb(t)\np(q)\na(t)\nv(t) = a(t) \u1e8b(t)\n\nx(t) = q +\n\n(75)\n(76)\n\nwhere q, p are the Lagrangian initial position and displacements, a(t) is the expansion factor and b(t)/a(t) describes the growth factor of the perturbation. For a\nclosed universe (\u03a9m = 1), a(t) = (3H0 t/2)2/3 (Eq. [2]) and b(t) = 2a2 /5 [43].\n\n\f! Please write \\titlerunninghead{<(Shortened) Article Title>} in file !\n\n21\n\nTABLE 2\nConvergence tests: collisionless, variable timestep, linear phase\u2020\nNpart\n\nL1\n\nR1\n\n8\n16\n32\n64\n128\n\n6.4e-06\n1.7e-06\n4.3e-07\n1.1e-07\n2.5e-08\n\n1.9\n2.0\n2.0\n2.0\n\u2013\n\n8\n16\n32\n64\n128\n\n8.9e-04\n2.3e-04\n5.9e-05\n1.5e-06\n3.7e-07\n\n8\n16\n32\n64\n128\n\n6.5e-02\n1.7e-02\n4.4e-03\n1.1e-03\n2.8e-04\n\nL2\n\nR2\n\nL\u221e\n\nR\u221e\n\nposition\n6.9e-06\n1.9e-06\n4.7e-07\n1.1e-07\n2.8e-08\n\n1.9\n2.0\n2.0\n1.9\n\u2013\n\n9.2e-06\n2.6e-06\n6.4e-07\n1.4e-07\n4.5e-08\n\n1.8\n2.0\n2.1\n1.6\n\u2013\n\n1.9\n2.0\n2.0\n2.0\n\u2013\n\nvelocity\n9.6e-04\n2.6e-04\n6.5e-05\n1.6e-05\n4.2e-06\n\n1.9\n2.0\n2.0\n1.9\n\u2013\n\n1.3e-03\n3.6e-04\n8.9e-05\n2.0e-05\n6.6e-06\n\n1.8\n2.0\n2.1\n1.6\n\u2013\n\n1.9\n2.0\n2.0\n2.0\n\u2013\n\nforce\n7.1e-02\n1.9e-02\n4.8e-03\n1.2e-03\n3.1e-04\n\n1.9\n2.0\n2.0\n1.9\n\u2013\n\n9.4e-02\n2.7e-02\n6.5e-03\n1.5e-03\n5.1e-04\n\n1.8\n2.0\n2.1\n1.6\n\u2013\n\n\u2020 We use equal number of cells and particles, N\npart = Ncell , a cell-centered force scheme, a\n\u2206t\na\nvariable timestep, \u2206x\n= Cexp ( \u0227\n), Cexp = 10\u22122 , and a = 0.0221.\n\nSetting the initial displacements to a sinusoidal form, p(q) = 5A sin(kq)/2, where\nk is the perturbation wavenumber, we obtain\nx(t) = q + a A sin(kq)\n\n(77)\n\nv(t) = a \u0227 A sin(kq)\n\u03c1(t) = \u03c10 [1 + a A k cos(kq)]\n\n(78)\n\u22121\n\n.\n\n(79)\n\nThe solution described by Eq. (77) becomes singular, that is \u2202x/\u2202q = 0 when\nacollapse = (Ak)\u22121 . At this stage, particles trajectories cross at x = q = \u03c0/k\nand a caustic forms. In the following we use astart = 1/51, acollapse = 1/2 and\nk = 2\u03c0/h\u22121 Lbox .\n4.1.1. Collisionless Component\nTable 1 demonstrates the second order accuracy of the code. The different\ncolumns report, as a function of numerical resolution, the L1 , L2 and L\u221e norms\nof the error on the particles position, velocity and force, and the corresponding\nconvergence rates of the errors. The L2 norm of these errors is also reported graphically in the left hand side panels of Fig. 1. For this case we use equal number\nof cells and particles, Npart = Ncell, a cell-centered force scheme, and a constant\n\u2206t\n\u22124\n.\nIn Fig. 1 we also report the L2 norm of the errors for the case\n\u2206x = 1.6 \u00d7 10\n1\nin which Npart = 2 Ncell and the particles are initially placed either at cell nodes\n\n\f22\n\n! Please write \\authorrunninghead{<Author Name(s)>} in file !\n\nTABLE 3\nConvergence tests: collisionless, variable timestep, nonlinear phase\u2020\n\nNpart\n\nL1\n\nuniform grid\nR1\nL\u221e\n\nR\u221e\n\nL1\n\nR1\n\nAMR\nL\u221e\n\nR\u221e\n\nlmax\n\n8\n16\n32\n64\n128\n256\n\n3.0e-02\n9.5e-03\n2.7e-03\n7.2e-04\n1.8e-04\n4.6e-05\n\n1.7\n1.8\n1.9\n2.0\n2.0\n\u2013\n\n4.6e-02\n1.6e-02\n4.7e-03\n1.3e-03\n3.3e-04\n9.2e-05\n\nposition\n1.6\n2.9e-02\n1.8\n7.9e-03\n1.8\n2.0e-03\n2.0\n5.1e-04\n1.8\n1.2e-04\n\u2013\n3.0e-05\n\n1.9\n2.0\n2.0\n2.0\n2.0\n\u2013\n\n4.5e-02\n1.2e-02\n3.1e-03\n8.3e-03\n2.2e-04\n9.2e-05\n\n1.9\n2.0\n1.9\n1.9\n1.3\n\n1\n1\n2\n2\n3\n3\n\n8\n16\n32\n64\n128\n256\n\n5.9e-02\n2.2e-02\n7.4e-03\n2.4e-03\n7.4e-04\n2.1e-04\n\n1.4\n1.6\n1.6\n1.7\n1.8\n\u2013\n\n9.4e-02\n4.1e-02\n1.8e-02\n7.3e-03\n2.8e-03\n9.1e-04\n\nvelocity\n1.2\n5.1e-02\n1.2\n1.4e-02\n1.3\n4.1e-03\n1.4\n9.6e-03\n1.6\n2.2e-04\n\u2013\n5.7e-05\n\n1.8\n1.8\n2.1\n2.1\n2.0\n\u2013\n\n7.9e-02\n2.1e-02\n7.4e-03\n1.6e-03\n4.5e-04\n1.8e-04\n\n1.9\n1.5\n2.2\n1.9\n1.3\n\u2013\n\n1\n1\n2\n2\n3\n3\n\n8\n16\n32\n64\n128\n256\n\n1.5e-01\n7.4e-02\n3.7e-02\n1.8e-02\n8.1e-03\n3.1e-03\n\n1.1\n1.0\n1.0\n1.2\n1.4\n\u2013\n\n2.6e-01\n1.6e-01\n1.2e-01\n7.8e-02\n4.6e-02\n2.2e-02\n\nforce\n0.7\n1.1e-01\n0.5\n4.5e-02\n0.6\n8.2e-02\n0.7\n3.5e-03\n1.0\n2.5e-03\n\u2013\n8.2e-04\n\n1.3\n2.4\n1.2\n0.5\n1.6\n\u2013\n\n1.8e-01\n9.3e-02\n1.6e-02\n1.5e-02\n3.0e-02\n1.2e-02\n\n0.9\n2.6\n0.1\n2.3\n1.3\n\u2013\n\n1\n1\n2\n2\n3\n3\n\n\u2020 We use equal number of cells and particles, N\npart = Ncell , a cell-centered force scheme, a\na\n\u2206t\n= Cexp ( \u0227\n), Cexp = 10\u22122 , and a = 0.479.\nvariable timestep, \u2206x\n\n(central panels, NCP for node centered particle) or cell centers (right panels, CCP\nfor cell centered particle). Both these configurations lead to a slower convergence\nrate than our reference case illustrated in the left hand side panels.\nIn cosmological simulations, the timestep during the initial stages is determined\nby the expansion rate of the background. Thus in Table 2 we report the same\nquantities as in Table 1 but for the case of a (variable) timestep determined by\na\n\u2206t\n\u22122\n. The L2 norm of these errors are also reported\n\u2206x = Cexp ( \u0227 ), with Cexp = 10\nas filled symbols in the left hand side panels of Fig. 2. The errors were computed\nafter ten timesteps so that the system is still in the linear regime. And, in fact, the\nconvergence rates are the same as in Table 1. The same correspondence in terms\nof convergence rates also exists for the case in which Npart = 12 Ncell, as illustrated\nfor the NCP case by the star symbols in right hand side panels of Fig. 2.\nNext, we consider the errors during the nonlinear regime of the calculation. In\nparticular, we consider the solution just prior to the caustic formation, when the\nbackground expanded by a factor 25 since the simulation start. On the left hand\nside of Table 3 we report the L1 and L\u221e error norms and convergence rates as in\n\n\f! Please write \\titlerunninghead{<(Shortened) Article Title>} in file !\n\n23\n\nTable 2 while the L\u22122 errors are shown as open symbols in the left hand side panels\nof Fig. 2. We see that in the nonlinear regime the convergence rates of the errors in\n\nFIG. 2.\nL2 norm of the error in position (top), velocity (center) and force (bottom) as a\nfunction of the number of grid cells. Left panels correspond to the case in which the number of\nparticles and grid cells is the same, Ncell = Npart . Right panels correspond to Npart = 12 Ncell ,\nwith particles initially placed at cell nodes. See legend for the meaning of the symbols (UG=\nUniform Grid, a is the expansion parameter).\n\nthe particle positions, velocities and forces have worsened in a minor, appreciable\nand considerable way, respectively.\nFinally, we test the performance of the AMR code. We use a constant refinement\nratio, nref = 2, and refine cells enclosing a mass larger than 1.5 the average value.\nA maximum of three levels of refinement were allowed. All runs used a first level of\nrefinement for about 30% of the calculation, except for the lowest resolution case\nfor which the percentage was 12%. The second level of refinement was only used by\nthe three higher resolution runs and only for about 5% of the time. Finally, a third\nlevel of refinement was employed only by the two finest runs and only for less than\n1% of the time. Similarly, finer grids cover a progressively smaller fraction of the\n\n\f24\n\n! Please write \\authorrunninghead{<Author Name(s)>} in file !\n\ncomputational domain. The L1 and L\u221e error norms and convergence rates for the\n\nFIG. 3.\nComparison between two numerical experiments, employing a uniform grid (left)\nand two levels of refinement (right), in terms of error in the particle position (top), velocity\n(middle) and force (bottom). The initial set up includes 32 grid cells (bound by vertical lines) and\n32 particles uniformly distributed. Only one quarter of the grid is shown, focusing on the critical\nregion where the caustic forms. Vertical lines indicate cells' boundaries.\n\nAMR runs are reported on the right hand side of Table 3 while the L \u2212 2 errors are\nshown as spur symbols in the left hand side panels of Fig. 2. These results show\nthat employing AMR during the nonlinear evolution improves the convergence rate\nof the solution in such a way that they resemble the values in the linear stage. This\nis true in this example for the errors in the position and velocity and to a lesser\nextent, the force, which is more affected by coarse/fine boundary effects.\nFig. 3 compares the errors in position, velocity and force for a fixed grid (left)\nand an AMR grid (right) calculations. It focuses on the region where, and the\ntimes when, the caustic forms and AMR operates. Thus only one quarter of the\ntotal grid is shown (with the cell boundaries of the base grid indicated by vertical\nlines and marked by integer labels), and the various errors are plotted only for the\n\n\f! Please write \\titlerunninghead{<(Shortened) Article Title>} in file !\n\n25\n\nlast one third of the simulation run. At the beginning of that time span (when\na \u223c 0.2), the particles have clustered sufficiently at the grid center and a first level\nof refinement is created. Six grid meshes are refined (only three between boundaries,\n\nFIG. 4.\ncalculation.\n\nSame as Fig. 1 but for the case in which a staggered scheme is used for the force\n\n12-16, are shown in Fig. 3). The second level of refinement is created much later\nand only affects one base (or two refined) grid mesh(es) for the last ten per cent of\nthe simulation. Fig. 3 shows that the errors in position, velocity and force of the\nparticles close to the point where the caustic forms are much reduced when AMR\nis employed. The generation of a level of refinement is accompanied by a change in\nthe mass distribution and the potential field. When this happens, a particle may\nexperience a sudden change in terms of the force field acting upon it. These effects\nare responsible for the somewhat 'errant' behavior of the force error, as illustrated\nin the bottom-left panel of Fig. 3. Overall, though, for each particle the force\nfluctuations in the AMR case are significantly smaller than the force errors in the\nuniform grid case.\n\n\f26\n\n! Please write \\authorrunninghead{<Author Name(s)>} in file !\n\nAs a last result for this section, in Fig. 4 we plot L2 convergence errors analogous\nto Fig. 1 but for the case in which the force was computed with a staggered scheme.\nComparison of the two figures shows that when Npart = Ncell the solution obtained\nwith the staggered scheme also converges with second order accuracy, while being\ncharacterized by smaller errors. This is in agreement with previous findings [44].\nHowever, when the number of particles is halved (Npart = 21 Ncell ) the results obtained with a staggered force scheme worsen more dramatically than for the cell\ncentered case, showing a very poor convergence rate. Closer inspection shows that\nwhen the particles are sparse on the grid, oscillations appear in the potential due to\nthe discrete character of the matter distribution as reproduced on the grid. Since\nthis affects only the quality of the staggered scheme the problem may be related\nto the inconsistency of this scheme with the centering of the stencil used for the\ndiscretization of the Laplacian operator. We shall return to this issue in the next\ntest case where the problem reappears with more dramatic effects.\n4.1.2. Collisional Component\nWe now turn to the performance of the hydrodynamic part of the code. We use\nthe same tests employed in the previous section for the the collisionless component.\nHowever, since in this case the solution refers to an Eulerian grid, in order to have\nthe velocity and density at a given grid location x(q, t) from Eq. (78)-(79) we must\ninvert Eq. (77).\nWe first consider the errors in the linear regime, in analogy\nTABLE 4\nConvergence tests: Godunov's scheme\u2020\nNpart\n\nL1\n\nR1\n\n8\n16\n32\n64\n128\n\n2.7e-05\n5.7e-06\n1.2e-06\n3.0e-07\n7.4e-08\n\n2.2\n2.2\n2.0\n2.0\n\u2013\n\n8\n16\n32\n64\n128\n\n3.3e-05\n8.1e-06\n2.0e-06\n5.0e-07\n1.2e-07\n\n8\n16\n32\n64\n128\n\n1.6e-02\n3.9e-03\n9.7e-04\n2.4e-04\n6.0e-05\n\n\u2020\n\nL2\n\nR2\n\nL\u221e\n\nR\u221e\n\ndensity\n2.9e-05\n7.6e-06\n1.7e-06\n3.8e-07\n8.8e-08\n\n1.9\n2.2\n2.2\n2.1\n\u2013\n\n4.2e-05\n1.8e-05\n5.3e-06\n1.4e-06\n3.7e-07\n\n1.2\n1.8\n1.9\n1.9\n\u2013\n\n2.0\n2.0\n2.0\n2.0\n\u2013\n\nvelocity\n3.6e-05\n9.0e-06\n2.2e-06\n5.6e-07\n1.4e-07\n\n2.0\n2.0\n2.0\n2.0\n\u2013\n\n5.2e-05\n1.3e-05\n3.2e-06\n7.9e-07\n2.0e-07\n\n2.0\n2.0\n2.0\n2.0\n\u2013\n\n2.0\n2.0\n2.0\n2.0\n\u2013\n\nforce\n1.7e-02\n4.3e-03\n1.1e-03\n2.7e-04\n6.7e-05\n\n2.0\n2.0\n2.0\n2.0\n\u2013\n\n2.4e-02\n6.1e-03\n1.5e-03\n3.8e-04\n9.5e-05\n\n2.0\n2.0\n2.0\n2.0\n\u2013\n\n\u2206t\nWe use a cell-centered force scheme and a constant timestep, \u2206x\n= 1.6 \u00d7 10\u22124 .\n\n\f! Please write \\titlerunninghead{<(Shortened) Article Title>} in file !\n\n27\n\nTABLE 5\nConvergence tests: Godunov's scheme, linear regime\u2020\nNpart\n\nL1\n\nR1\n\n8\n16\n32\n64\n128\n\n2.0e-04\n4.2e-05\n9.5e-06\n2.4e-06\n6.5e-07\n\n2.2\n2.1\n2.0\n1.9\n\u2013\n\n8\n16\n32\n64\n128\n\n2.1e-04\n5.1e-05\n1.3e-05\n3.2e-06\n7.9e-07\n\n8\n16\n32\n64\n128\n\n1.5e-02\n3.6e-03\n9.0e-04\n2.2e-04\n5.6e-05\n\nL2\n\nR2\n\nL\u221e\n\nR\u221e\n\ndensity\n2.1e-04\n5.7e-05\n1.3e-05\n3.5e-06\n1.3e-06\n\n1.9\n2.1\n1.9\n1.5\n\u2013\n\n3.0e-04\n1.4e-04\n4.3e-05\n1.6e-05\n8.4e-06\n\n1.1\n1.7\n1.4\n0.9\n\u2013\n\n2.0\n2.0\n2.0\n2.0\n\u2013\n\nvelocity\n2.3e-04\n5.7e-05\n1.4e-05\n3.5e-06\n8.9e-07\n\n2.0\n2.0\n2.0\n2.0\n\u2013\n\n3.3e-04\n8.2e-05\n2.0e-05\n5.0e-06\n1.3e-06\n\n2.0\n2.0\n2.1\n1.9\n\u2013\n\n2.0\n2.0\n2.0\n2.0\n\u2013\n\nforce\n1.7e-02\n4.0e-03\n1.0e-04\n2.5e-04\n6.2e-05\n\n2.1\n2.0\n2.0\n2.0\n\u2013\n\n2.3e-02\n5.7e-03\n1.4e-03\n3.5e-04\n8.9e-05\n\n2.0\n2.0\n2.0\n2.0\n\u2013\n\n\u2020 We use a cell-centered force scheme, a variable timestep,\na = 0.0221.\n\n\u2206t\n\u2206x\n\na\n= Cexp ( \u0227\n), Cexp = 10\u22122 , and\n\nto Table 1 and Table 2 for the collisionless component. In Table 4 we report the\nL1 , L2 and L\u221e norms of the error for the gas density, velocity and force and the\n\u2206t\n= 1.6 \u00d7 10\u22124 .\ncorresponding convergence rates, for the case of fixed time step, \u2206x\nSimilarly, the left hand side of Table 5 reports the L1 , L2 and L\u221e errors for the\ncase in which the time step is set by the background expansion rate. The L2 errors\nfor the fixed and varying timestep cases are also shown by the filled symbols in the\nleft and right hand side panels of Fig. 5, respectively. These tests show the second\norder accuracy of the implemented scheme. We note, however, that in the case\nof variable time step the convergence rate of the L\u221e norm of the density error is\nslower.\nNext, the left hand side of Table 6 reports the errors and convergence\nrates for the case of a uniform grid calculation, well in the nonlinear regime, close\nthe formation of the caustic (a = 0.479). As before, the L2 errors are also shown as\nopen symbols in Fig. 5. Unlike the collisionless case, here is the convergence rate\nof the density that is mostly affected, particularly at low resolutions (cf. [31, 45]).\nAs illustrated by the L\u221e norm, the error is dominated by the contribution of a few\ncells, located where the caustic forms.\nFinally, we test the performance of the AMR code. As for the collisionless component, we use a constant refinement ratio, nref = 2, refine cells enclosing a mass\nlarger than 1.5 the average value and allow for a max of three levels of refinement.\nThe results at a = 0.476 are reported in the right hand side columns of Table 6 for\n\n\f28\n\n! Please write \\authorrunninghead{<Author Name(s)>} in file !\n\nTABLE 6\nConvergence tests: Godunov's scheme, nonlinear regime\u2020\n\nNpart\n\nL1\n\nuniform grid\nR1\nL\u221e\n\nR\u221e\n\nL1\n\nAMR\nL\u221e\n\nR1\n\nR\u221e\n\nlmax\n\n8\n16\n32\n64\n128\n\n2.2e-01\n1.6e-01\n9.7e-02\n5.0e-02\n1.6e-02\n\n0.5\n0.7\n0.9\n1.6\n\u2013\n\n8.2e-01\n1.2e00\n1.5e00\n1.5e00\n7.3e-01\n\ndensity\n\u2013\n1.6e-01\n\u2013\n1.0e-01\n0.0\n6.4e-02\n1.0\n1.6e-02\n\u2013\n3.9e-03\n\n0.7\n0.6\n2.0\n2.0\n\u2013\n\n8.2e-01\n1.5e00\n2.4e00\n1.0e00\n4.7e-01\n\n\u2013\n\u2013\n1.3\n1.1\n\u2013\n\n1\n1\n2\n2\n3\n\n8\n16\n32\n64\n128\n\n2.7e-02\n1.0e-02\n3.8e-03\n1.3e-03\n4.3e-04\n\n1.4\n1.4\n1.5\n1.6\n\u2013\n\n9.4e-02\n7.0e-02\n5.3e-02\n3.6e-02\n2.0e-02\n\nvelocity\n0.4\n1.6e-02\n0.4\n4.7e-03\n0.6\n1.4e-03\n0.9\n2.6e-04\n\u2013\n7.2e-05\n\n1.8\n1.7\n2.4\n1.8\n\u2013\n\n8.6e-02\n5.3e-02\n3.6e-02\n9.6e-03\n3.1e-03\n\n0.7\n0.6\n2.2\n1.9\n\u2013\n\n1\n1\n2\n2\n3\n\n8\n16\n32\n64\n128\n\n6.8e-02\n2.3e-02\n8.4e-03\n2.9e-03\n9.5e-04\n\n1.6\n1.5\n1.5\n1.6\n\u2013\n\n2.3e-01\n1.6e-01\n1.1e-01\n7.3e-02\n3.9e-02\n\nforce\n0.5\n3.7e-02\n0.5\n1.1e-02\n0.6\n2.2e-03\n0.9\n5.5e-04\n\u2013\n1.6e-04\n\n1.7\n2.3\n2.0\n1.8\n\u2013\n\n2.0e-01\n1.1e-01\n6.3e-02\n1.9e-02\n4.0e-03\n\n0.9\n0.8\n1.7\n2.2\n\u2013\n\n1\n1\n2\n2\n3\n\n\u2020 We use a cell-centered force scheme, a variable timestep,\na = 0.479.\n\n\u2206t\n\u2206x\n\na\n= Cexp ( \u0227\n), Cexp = 10\u22122 , and\n\nthe L1 , L\u221e errors and convergence rates. There we also show the maximum level\nemployed by each run. L2 errors are reported as spur symbols in the right panels\nof Fig. 5.\nThe use of refined grids in terms of fraction of grid covered and fraction of the\nsimulation time is very similar to the corresponding collisionless case. Similar is\nalso the benefit of AMR, which improves the convergence of the solution to rates\nvery similar to those characterizing the linear regime. This is indeed a powerful\nperformance of the AMR technique.\n4.2. Effect of Cexp on the Solution Quality\nWe have investigated how the error depends on the choice of the parameter Cexp\nfor the above problem. In particular we have computed the error accumulated\nduring an interval \u2206a \u226a acollapse , for values of the expansion parameter a = 0.196\nand a = 0.091, and for values of Cexp ranging from 10\u22123 to 0.5. We consider both\nthe fluid and the collisionless case. We use a uniform grid with 32 zones on a side\nand, for the collisionless case, we use one particle per cell. The results are rather\nindependent of the norm type. We find that the errors introduced in the particles\nvelocity and position is quite stable, except for the largest values of Cexp . On the\nother hand, the errors in the fluid components decrease steadily as Cexp is reduced,\nspanning a factor \u223c 5 before reaching a plateau for Cexp \u2264 (1 \u2212 2) \u00d7 10\u22122 .\n\n\f! Please write \\titlerunninghead{<(Shortened) Article Title>} in file !\n\n29\n\nFIG. 5.\nL2 norm of the error in density (top), velocity (center) and force (bottom) as a\nfunction of the number of grid cells. See legend for the meaning of the symbols (UG= Uniform\nGrid, a is the expansion parameter).\n\n4.3. Homologous Dust Cloud Spherical Collapse\nIn this section we test the ability of the code to follow the collapse of a pressureless (dust) sphere of matter [46]. The problem is described by the following equations\n\u0012 2 \u0013\nM (r)\n\u2202 r\n= \u2212G 2\n(80)\n\u2202t2 M\nr\n\u0012 \u0013\n\u2202r\nu =\n(81)\n\u2202t M\nwith initial conditions\n\u03c1(i, t = 0) =\n\n\u001a\n\nu(i, t = 0) = 0\n\nf [r(i)] if r(i) \u2264 R\n0\nif r(i) > R\n\n(82)\n(83)\n\n\f30\n\n! Please write \\authorrunninghead{<Author Name(s)>} in file !\n\nFIG. 6.\nPhase space distribution of particles for the spherical collapse of a pressureless\ncloud. Cyan open circles correspond to the analytic solution and filled triangles to the numerical\nsimulation result. The right panel is for the case of a uniform grid whereas the left panel correspond\nto an AMR calculation with two levels of refinement.\n\nwhere M (r) is the mass enclosed within a distance r from the sphere center, R is\nthe radius of the sphere and f (r) is a function (with f \u2032 (r) \u2264 0) that depends solely\non r. For the hydrodynamic case null density will be approximated with a value\n\u03c1(r > R) \u226a min[\u03c1(r)]. The problem admits a self similar solution in implicit form\nwhich reads\n\nr = \u03be r0 ,\n\nu=\n\nr0\n\u03c4c\n\n(1 \u2212 \u03be)1/2 \u03be 1/2 + sin\u22121 (1 \u2212 \u03be)1/2 = \u03c4\n\u00131/2\n\u0012\n\u00011/2\n8\u03c0Gh\u03c1ir\n\u22121\n\u03be \u22121\n, \u03c4 \u2261t\n3\n\n(84)\n(85)\n\nwhere h\u03c1ir = 3M (r)/4\u03c0r3 is the average density within a radius r.\nFrom the numerical point of view, the problem is challenging in two respects:\nduring collapse the force potential becomes progressively steeper and, therefore,\nmore demanding for the gravity solver. In addition, since the problem has inherent\nradial symmetry and we are solving it on a Cartesian grid, the ability of the code\nat preserving that symmetry will be tested.\nFor the collisionless component we initially set particles with null velocity at\nthe center of cells whose distance from the cloud center is less than R (=1). This\nproduces a homogeneous density distribution everywhere inside R, except close to\nthe cloud edge due to the discreteness of the grid. In Fig. 6 we compare the position\nof each particle in phase-space (vr , r) as given by the code (black filled triangles)\nwith the analytic solution (cyan open circle). The left panel corresponds to the\ncase in which a uniform grid is used whereas for the right panel solution AMR was\nemployed. We allow for two levels of refinement and tag cells with a total mass four\ntimes as high as the initial value. The comparison between analytic and numerical\nsolution in Fig. 6 is made for a number of evolution times, expressed in terms of the\nadimensional collapse time \u03c4coll = \u03c0/2. Noticeably, the code follows the particles\n\n\f! Please write \\titlerunninghead{<(Shortened) Article Title>} in file !\n\n31\n\nFIG. 7.\nPhase space distribution of particles for the spherical collapse of a pressureless\ncloud. The initial cell-to-particle ratio is 4. Cyan open circles correspond to the analytic solution\nand filled triangles to the numerical simulation result using a cell-centered (left) and face-centered\n(right) force scheme, respectively.\n\nmotions with high accuracy all the way down to the time of collapse. In particular,\nthere is no sign of artificial asymmetries. Additional levels of refinement were\ndynamically generated towards the final phase of the collapse. At the latest time\nshown (\u03c4 = 0.98 \u03c4coll ), we can see the improvement due to the employment of finer\ngrids in the collapsing region. Note that towards the edge of the cloud the particles\nare trailing. This is due to the inability to reproduce a perfectly homogeneous\nsphere near the cloud edge from the beginning. The region affected by this is about\none mesh size wide.\nWhen exploring the accuracy of cell-centered versus face-centered force schemes\nour tests suggest that, again, in the uniform grid case the latter perform slightly\nbetter, at the level of ca 15%. In analogy with the analysis of Sec. 4.1, we have\ntested this further, for the case in which the ratio of cells to particles is significantly\nlarger than one. This situation may easily occur depending on the adopted criterion\nfor refinement and on the efficiency for the generation of the refined grid out of the\ntagged cells. In Fig. 7 we compare the solutions obtained with a cell-centered (left)\nand a staggered (right) force scheme for an initial cell-to-particle ratio of 4. The\ninitial dust sphere is placed on a grid of 256 cells on a side, and 8 particles are\naligned along its radius out to 32 cells from its center. The code output is plotted\nat three different solution times close to the time of collapse t = \u03c4coll . This test\nshows that when the number of cell-to-particle ratio is significantly higher than\none, the staggered force scheme tends to produce spurious results. This is in line\nwith the findings in the previous test problem in section 4.1. On the other hand,\nthe cell-centered scheme seems well behaved. We find that the qualitative result\ndoes not change when we use a two or four point force stencil, when the number of\nparticles to resolve the sphere is changed or when the sphere center is shifted by a\nfraction of a mesh size in an arbitrary direction.\n\n\f32\n\n! Please write \\authorrunninghead{<Author Name(s)>} in file !\n\nThus the staggered force scheme, although apparently more accurate than its\ncell-centered counterpart when the number of cells is comparable to, or less than,\nthe number of particles [44], it gives rise to spurious results when particles are\nsparse on the grid. Therefore, caution must be exercised when employing staggered\nschemes for force evaluation.\n\nt=0.92\u03c4coll\n\nt=0.72\u03c4coll\n\nt=0.92\u03c4coll\nt=0.72\u03c4coll\n\nFIG. 8.\nDensity and velocity profile for spherical collapse of a pressureless cloud of\ngas. Cyan open circles correspond to the analytic solution and black filled dots to the numerical\nsimulation results.\n\nFinally, the results for the collisional case are illustrated in Fig. 8. The plot\ncompares the density (top) and velocity (bottom) profiles of the numerical solution\n(threaded black dots) and the analytic solution (cyan dots). The latter extend only\nout the cloud size, whereas the numerical solution includes the region covered by the\nfinest level. Two times during the collapse are shown: t = 0.72\u03c4coll and t = 0.92\u03c4coll ,\ncorresponding to the low and high curves, respectively. At these times one and two\nlevels of refinement have been generated, respectively. The chosen times are close\nto the collapse time, when the errors have accumulated and the simulation becomes\nmore challenging. Nevertheless, as for the collisionless component, the code follows\n\n\f! Please write \\titlerunninghead{<(Shortened) Article Title>} in file !\n\n33\n\naccurately the evolution of the density and velocity profiles of the collapsing cloud.\nAgain, close to the cloud edge the density profile is smoother and the velocity field\nslower than the analytic solution. The size of the region affected by this is again of\norder of the coarse mesh size and it is partially ascribed to the crude representation\nof the cloud edge on the grid.\n4.4. Energy Conservation: Layzer-Irvine Equation\nFor pure hydrodynamics conservation of the total (kinetic+thermal) energy is\nenforced by our conservative Godunov's method. When gravity is added, energy\nconservation should still hold, but is not explicitly enforced in our scheme. Finally,\nwith an expanding background energy is not conserved. For a collection of particles that interact only gravitationally, the evolution of the energy of the system is\nregulated by the Layzer-Irvine equation, which reads\nd\n[a(t)(E + W)] = \u2212\u0227 E\ndt\n\n(86)\n\nwhere E is the kinetic energy associated to the peculiar motions of the particles\nand W their gravitational potential energy due to the overdensity produced by\ntheir mass distribution. Clearly in absence of expansion (a = 1, \u0227 = 0) Eq. (86)\nreduces to the ordinary energy conservation equation. Otherwise it describes the\nchange in the total energy of the system due to the adiabatic expansion of the background. The derivation and physical meaning of Eq. (86) is reviewed in Ref. [27]. Its\napplicability to hydrodynamic simulations is discussed in, e.g., Ref. [32], in which\ncase a monoatomic gas is assumed and E includes both the kinetic and thermal\nenergy of the gas.\nEq. (86) can be integrated in time giving\na[E(a) + W(a)] \u2212 a0 [E(a0 ) + W(a0 )] = \u2212\n\nZ\n\na\n\nEda.\n\n(87)\n\na0\n\nWe can evaluate the integral on the RHS of the above equation numerically with\nthe trapezoidal rule and assess the accuracy of the code at tracking the energy of\nthe system through the quantity\n\u03b4\u03b5 =\n\na[E(a) + W(a)] \u2212 a0 [E(a0 ) + W(a0 )] +\n[a0 W(a0 ) \u2212 aW(a)]\n\nRa\n\na0\n\nEda\n\n.\n\n(88)\n\nWe first test the energy conservation accuracy of the code for the case of the\ncollapse of a pressureless cloud. This is the problem studied in the previous section.\nWe carry out three AMR calculation with different base grid sizes, namely 16, 32,\n64 corresponding to 4, 8, 16 cells per cloud radius respectively. In these runs, cells\nenclosing more then four times the initial mass content were tagged for refinement\nand a maximum of two 2 refinement levels were allowed. The results of the test\nare reported in the left hand side panel of Fig. 9 where we plot the error in the\ntotal energy, \u03b4\u03b5, as a function of resolution, for both the particle (open) and the\ngasdynamic (filled) case. The plots show that with 16 zones per cloud radius the\nerror in the energy is at the level of a per cent or so.\n\n\f34\n\n! Please write \\authorrunninghead{<Author Name(s)>} in file !\n\nFIG. 9.\nEnergy conservation error based on Eq.(88) for the collapse of a pressureless\nspherical cloud (left) and a cosmological run (right). See text for details.\n\nNext we test code accuracy at tracking the energy of the system in a cosmological\nrun. For the purpose we use a \u039b-Cold Dark Matter cosmology with parameters\n\u03a9m =0.3, \u03a9\u039b = 0.7, \u03a9b = 0.04, for the energy density in total matter, dark energy\nand baryonic matter respectively; and H0 = 70 km s\u22121 Mpc\u22121 for the Hubble\nconstant. The physical domain has a size of L=91.43 Mpc on a side. We execute\nthree runs with different numerical resolution. The first two runs employ a uniform\ngrid with 323 and 643 cells, respectively, and the same number of particles as grid\ncells. The third run uses a base grid with 323 cells and 323 particles, and two\nadditional levels of refinement created in region where the total mass enclosed in\na cell exceeds the initial value by a factor eigth. The initial conditions where\ngenerated on a 643 grid and coarse-averaged to a 323 grid for the low-resolutionuniform and AMR runs.\nThe results are presented in the right panel of Fig. 9 where we plot \u03b4\u03b5 (top), E\n(middle) and W (bottom) as a function of expansion parameter a for each resolution\ncase. The plots show that when using a uniform grid the total energy of the system\nis evolved with an accuracy at the percent level (\u223c 2% and 1% for the 323 (dot)\nand 643 (dash) cases, respectively), with most of the error generated at startup. In\nthe AMR case (solid line), however, our error parameter \u03b4\u03b5 increases visibly when\nrefinement levels are created (at a \u223c 0.15 and a \u223c 0.2 for the first and second level\nrespectively). The reason for this is simple. When a level of refinement is created\nthe potential energy of the system changes suddenly (see solid and dot lines in the\nbottom panel) throwing off the balance bewtween particle/gas velocities and their\npotential energy. As a result a large error in the sense of Eq.(88) is generated. This\nis so, even though with the additional level of refinement the potential energy of the\nsystem is more accurate as it gets closer the value from the high resolution run (see\nsolid and dash lines in the bottom panel). Over time the kinetic energy readjusts to\nthe new potential (middle panel; notice that the internal energy is negligible) and\na balance between the two forms of energy is reestablished. Because the potential\n\n\f! Please write \\titlerunninghead{<(Shortened) Article Title>} in file !\n\n35\n\nenergy associated with the newly formed structures is larger than that of the system\nat the time when the refinement levels were first generated, the new balance between\nkinetic and potential energy reduces substantially the error as time progresses. At\nsimulation end the AMR run (with a base grid of 323 cells) produces estimates of\n\u03b4\u03b5, E and W very close to the high resolution run.\n4.5. Santa Barbara Galaxy Cluster\nIn this section we carry out the calculation defined by the 'Santa Barbara Cluster\nComparison Project' [47] and compare the results of our code with those from\ndifferent codes implemented independently by other authors and based either on\nsimilar or different techniques.\nThe problem consists of simulating the formation of a galaxy cluster in a Standard\nCold Dark Matter universe. The cosmological parameters assumed were \u03a9m = 1 and\n\u03a9b = 0.1 for the total and baryonic mean mass density in units of the critical density,\nrespectively; H0 = 50 km s\u22121 Mpc\u22121 for the Hubble constant; \u03c38 = 0.9 for the\npresent-day linear rms mass fluctuation in spherical top hat spheres of radius 16\nMpc; for the baryon density. The computational domain has a size of L=64 Mpc on\na side. The initial matter fluctuation are characterized by a power spectrum with\nan asymptotic spectral index, n = 1, and are 'constrained' so that at simulation\nend a massive structure has formed at the center of the computational box.\nThe simulation was initialized at z = 40 with two grids already in place: a base\ngrid covering the entire 64 Mpc3 domain with 643 cells and 643 particles; and a\nsecond grid, also with 643 cells and 643 particles, but only 32 Mpc on a side and\nplaced in the central region of the base grid, thus yielding an initial cell size of\n0.5 Mpc. Refinement is applied only in this central, higher resolution region and\nis based on a local density criterion: cells with a total mass of 6.4 \u00d7 1010 M\u2299 or\nmore were refined. We allowed for 5 levels of refinement (for a total of a 6 levels\nhierarchy), with a constant refinement ratio nref = 2. The size of the finest mesh\nis about 15 comoving kpc. We use the following CFL coefficients for the time step:\nChydro = 0.8, Cpart = 0.5 and Cexp = 0.02.\nAt simulation end a halo finder based on the spherical overdensity method [48]\nwas run in order to define the center of the galaxy cluster. The radial profiles for six\nquantities of interest are presented in Fig. 10 together with results from two other\nsimulation codes: ENZO, which is an Eulerian AMR code similar to ours, and HYDRA\n(as run by Jenkins & Pearce), which combines smoothed particle hydrodynamics\n(SPH) and adaptive particle-particle-particle-mesh (AP3 M) method for the N-body\npart [49]. These two codes are meant to be representative of the high resolution\ngrid based and SPH approaches, respectively.\nResults are shown down to scales of about 30 kpc which is just above the nominal\nresolution at finest level of refinement. The plot shows that there is good agreement among the results of the different codes particularly with ENZO (even though\nwe used one less level of refinement and use a different refinement criterion). The\ndiscrepancies, when significant, are consistent with those already found in the extensive comparison paper in Ref. [47]. In fact, there is very good agreement in\nterms of dark matter density distribution (top left) which is well fit by the analytical form proposed in Ref. [50] with parameters specified in the caption. Similarly,\nthere is good matching of the solution in terms of gas density distribution, except\n\n\f36\n\n! Please write \\authorrunninghead{<Author Name(s)>} in file !\n\nFIG. 10.\nRadial profile of dark matter (top left), baryonic gas (top right) temperature\n(middle left), baryonic fraction (middle right), radial velocity for dark matter (bottom left) and\ngas (bottom right). In addition to the results from CHARM (open dots), for comparison we also\nshow those from the ENZO AMR code (filled triangles) [21] as well as those from the HYDRA SPH\ncode (open stars) [49].\n\nin the inner regions within 100 kpc, where the two AMR solutions flattens and the\nSPH solution keeps on increasing. More significant is the difference in temperature\ndistribution (middle left), which drops in the SPH solution for the inner regions\nand stays constant for the AMR case. These differences were already found and\ndiscussed in Ref. [47]. (See also Ref. [19] for similar findings.) Their origin is not\nfully clear, although as suggested in Ref. [47], it could be ascribed to the different\nway in which SPH and grid based methods treat shocks.\nNext panel (middle right) shows the profile for the ratio of gas to dark matter\nmass, normalized to the global value. While our solution is in good agreement with\nENZO's and deviates from HYDRA's in the inner regions and is somewhat in between\nthe two beyond 1 Mpc or so. There is significant scatter in the results from the full\nset of codes found in Ref. [47], at the level of 0.1-0.2. Nevertheless, it is pointed\n\n\f! Please write \\titlerunninghead{<(Shortened) Article Title>} in file !\n\n37\n\nout in Ref. [47] that when integrated out to the virial radius of the system (2.7\nMpc), the SPH codes seem to predict a systematically slightly smaller values for\nthis quantity than high resolution grid based codes. The reason for this is still not\nclear.\nFinally, both the gas and dark matter radial velocity profiles agree quite well\nat all radii. Some differences may arise due to slight differences in the simulation\ntiming, as pointed out in Ref. [47]. Note that at larger radii (last few points),\ntypically characterized by wider scatter, both ENZO's and HYDRA's results tend\nto be below the average value defined in Ref. [47].\n5. CONCLUSIONS\nWe have presented a new code based on AMR technique for systems comprising\ncollisional and collisionless components coupled through a long range force. We\nhave thus extended the scheme in [2] to include collisionless particle dynamics\nand gravity arising from the mass distribution of the two components. For the\nhydrodynamics we use a slightly modified directionally unsplit Godunov's method\nbased on Ref. [28]. As for the collisionless component we have implemented various\ntime centered modified symplectic schemes based on both the kick-drift-kick and\ndrift-kick-drift sequence. Our implementations of these schemes appear to perform\ncomparably. We have also used several types of stencil to calculate the force from\nthe potential. We find that while the staggered schemes appear more accurate\nwhen the number (density) of particles is at least as large as the number of grid\ncells, it produces spurious results when the particles are sparse on the grid. Cell\ncentered stencils thus seem more reliable, especially when a five point cell centered\ndiscretization of the Laplacian operator is used.\nDue to the time refinement character of the AMR technique the solution on different levels is advanced with different timesteps. Synchronization issues then arise\nas the multilevel solution to the elliptic equation needs to be solved simultaneously\non all levels. In particular, the density field represented by the particles evolved\non finer levels may not be available on coarser levels when they are not synchronized. Similarly, one cannot account for the effects of the mass distribution on\nfiner levels on the multilevel solution of the potential, unless all levels are synchronized. Among other features of the code, we have thus introduced an aggregation\nprocedure to cost-effectively represent on the coarser levels the particles on finer\nlevels without compromising the code accuracy and performance. We have also\nimplemented a procedure for estimating (when the coarse and finer levels are not\nsynchronized) the effects on the coarse potential produced by the matching conditions at refinement boundaries between coarse and fine solution, as they would\narise in a full multilevel calculation. We performed several standard tests which\nillustrate the code accuracy as well as the advantages of the AMR technique for the\nstudy of both self gravitating hyperbolic systems, collisionless system and hybrid\nsystems.\nACKNOWLEDGMENT\nFM is thankful to D. Serafini, D. Martin, B. van Straalen and D. Graves for useful discussions, to\nthe Lawrence Berkeley National Laboratory, for its hospitality, to the Institute of Informatics, ETH\nZ\u00fcrich, for technical support. FM also acknowledges partial support by the European Community\n\n\f38\n\n! Please write \\authorrunninghead{<Author Name(s)>} in file !\n\nthrough contract HPRN-CT2000-00126 RG29185 and by the Swiss Institute of Technology through\na Zwicky Prize Fellowship.\n\nAPPENDIX: CHARGE ASSIGNMENT SCHEMES\nIndicating with \u2206x the mesh size in one dimension we find the nearest grid point\nscheme (NGP) defined for order r = 1 as\nW (x\u0302 \u2212 x) =\n\n\u001a\n\nif |x\u0302 \u2212 x| \u2264 \u2206x/2\notherwise\n\n1\n0\n\n(A.1)\n\nin which the assigned charge distribution is discontinuous as the particle cross the\ncell boundary; the cloud in cell (CIC) scheme defined for r = 2 as\nW (x\u0302 \u2212 x) =\n\n(\n\n1\u2212\n0\n\n|x\u0302\u2212x|\n\u2206x\n\nif\n\n|x\u0302 \u2212 x| \u2264 \u2206x\notherwise\n\n(A.2)\n\nin which the assigned charge distribution is continuous but the first derivative is\nnot; the cell boundary; and the triangular shape cloud (TSC) scheme defined for\nr = 3 as\n\uf8f1\n\u0010\n\u00112\n\uf8f4\n|x\u0302\u2212x|\n3\n\uf8f4\n\u2212\nif |x\u0302 \u2212 x| \u2264 \u2206x/2\n\uf8f4\n4\n\u2206x\n\uf8f2\n\u00112\n\u0010\n|x\u0302\u2212x|\nW (x\u0302 \u2212 x) =\n(A.3)\n1\n3\nif \u2206x/2 \u2264 |x\u0302 \u2212 x| \u2264 3\u2206x/2\n\uf8f4\n2 \u2212 2 \u2212 \u2206x\n\uf8f4\n\uf8f4\n\uf8f30\notherwise\n\nin which both the assigned charge distribution and first derivative are continuous.\nThese schemes retain their properties when they are extended to a multidimensional\ncase in the form of a product\nW (x\u0302 \u2212 x) =\n\nD\nY\n\nWj (x\u0302j \u2212 xj ).\n\n(A.4)\n\nj=1\n\nREFERENCES\n1. M. J. Berger, Oliger, Adaptive mesh refinement for hyperbolic partial differential equations,\nJ. Comp. Phys. 53 (1984) 484\u2013512.\n2. M. J. Berger, P. Colella, Local adaptive mesh refinement for shock hydrodynamics, J. Comp.\nPhys. 82 (1989) 64\u201384.\n3. F. X. Timmes, M. Zingale, K. Olson, B. Fryxell, P. Ricker, A. C. Calder, L. J. Dursi, H. Tufo,\nP. MacNeice, J. W. Truran, R. Rosner, On the Cellular Structure of Carbon Detonations,\nAstrophys. J. 543 (2000) 938\u2013954.\n4. K. Kifonidis, T. Plewa, H.-T. Janka, E. M\u00fcller, Nucleosynthesis and Clump Formation in a\nCore-Collapse Supernova, Astrophys. J. Lett. 531 (2000) L123\u2013L126.\n5. A. S. Almgren, J. B. Bell, C. A. Rendelman, M. Zingale, Low Mach number modeling of type\nIa supernovae. I. hydrodynamics, Astrophys. J. 637 (2006) 922\u2013936.\n6. A. S. Almgren, J. B. Bell, C. A. Rendelman, M. Zingale, Low Mach number modeling of type\nIa supernovae. II. energy evolution, Astrophys. J. in press.\n7. R. I. Klein, C. F. McKee, P. Colella, On the hydrodynamic interaction of shock waves with\ninterstellar clouds. 1: Nonradiative shocks in small clouds, Astrophys. J. 420 (1994) 213\u2013236.\n\n\f! Please write \\titlerunninghead{<(Shortened) Article Title>} in file !\n\n39\n\n8. R. Walder, D. Folini, Knots, filaments, and turbulence in radiative shocks, Astr. Astrophys.\n330 (1998) L21\u2013L24.\n9. R. I. Klein, R. T. Fisher, M. R. Krumholz, C. F. McKee, Recent Advances in the Collapse\nand Fragmentation of Turbulent Molecular Cloud Cores, in: Revista Mexicana de Astronomia\ny Astrofisica Conference Series, 2003, pp. 92\u201396.\n10. J. K. Truelove, R. I. Klein, C. F. McKee, J. H. Holliman, L. H. Howell, J. A. Greenough,\nThe Jeans Condition: A New Constraint on Spatial Resolution in Simulations of Isothermal\nSelf-gravitational Hydrodynamics, Astrophys. J. Lett. 489 (1997) L179+.\n11. J. K. Truelove, R. I. Klein, C. F. McKee, J. H. Holliman, L. H. Howell, J. A. Greenough, D. T.\nWoods, Self-gravitational Hydrodynamics with Three-dimensional Adaptive Mesh Refinement:\nMethodology and Applications to Molecular Cloud Collapse and Fragmentation, Astrophys. J.\n495 (1998) 821\u2013+.\n12. T. Abel, G. L. Bryan, M. L. Norman, The Formation of the First Star in the Universe, Science\n295 (2002) 93\u201398.\n13. M. L. Norman, Cosmological Simulations of X-ray Clusters: The Quest for Higher Resolution\nand Essential Physics, ArXiv Astrophysics e-prints.\n14. D. F. Martin, K. L. Cartwright, Solving Poisson's equation using adaptive mesh refinement,\nTechnical Report UCB/ERI M96/66 UC Berkeley.\n15. P. M. Ricker, K. Olson, K. M. Riley, F. Miniati, et al., Adding self-gravitation and collisionless\nparticles to an adaptive-mesh hydrodynamics codeIn prep.\n16. A. V. Kravtsov, High-resolution simulations of structure formation in the universe, Ph.D. Thesis.\n17. A. Knebe, A. Green, J. Binney, Multi-level adaptive particle mesh (MLAPM): a c code for\ncosmological simulations, Mon. Not. R. Astron. Soc. 325 (2001) 845\u2013864.\n18. R. Teyssier, Cosmological hydrodynamics with adaptive mesh refinement. A new high resolution code called RAMSES, Astr. Astrophys. 385 (2002) 337\u2013364.\n19. V. Quilis, A new multidimensional adaptive mesh refinement hydro + gravity cosmological\ncode, Mon. Not. R. Astron. Soc. 352 (2004) 1426\u20131438.\n20. R. W. Hockney, J. W. Eastwood, Computer Simulation Using Particles, McGraw Hill, New\nYork, 1981.\n21. G. L. Bryan, M. L. Norman, A hybrid amr application for cosmology and astrophysics, in:\nD. A. Clarke, M. Fall (Eds.), Computational Astrophysics, ASP Conference, 1997.\n22. G. Strang, On the construction and comparison of difference schemes, SIAM J. Num. Anal. 5\n(1968) 506\u2013517.\n23. J. Vay, P. Colella, P. McCorquodale, B. V. Straalen, A. Friedman, D. Grote, Mesh refinement\nfor particle-in-cell plasma simulations: Applications to and benefits for heavy ion fusion, Laser\n& Particle Beams 20 (4) (2002) 596\u201375.\n24. G. H. Miller, P. Colella, A conservative three-dimensional eulerian method for coupled solidfluid shock capturing, J. Comp. Phys. 183 (1) (2002) 26\u201382.\n25. A. Almgren, J. Bell, P. Colella, L. Howell, M. Welcome, A conservative adaptive projection\nmethod for the variable density incompressible Navier-Stokes equations, J. Comput. Phys. 142\n(1998) 1\u201346.\n26. D. Martin, P. Colella, A cell-centered adaptive projection method for the incompressible Euler\nequations, J. Comput. Phys. 163 (2000) 271\u2013312.\n27. P. J. E. Peebles, Principles of Physical Cosmology, Princeton University Press, Princeton New\nJersey, 1993.\n28. P. Colella, Multidimensional upwind methods for hyperbolic conservation laws, J. Comp. Phys.\n82 (1989) 64\u201384.\n29. J. Saltzman, An Unsplit 3D Upwind Method for Hyperbolic Conservation Laws, Journal of\nComputational Physics 115 (1994) 153\u2013168.\n30. F. Miniati, D. Ryu, H. Kang, T. W. Jones, R. Cen, J. Ostriker, Properties of cosmic shock\nwaves in large-scale structure formation, Astrophys. J. 542 (2000) 608\u2013621.\n31. G. L. Bryan, M. L. Norman, J. M. Stone, R. Cen, J. P. Ostriker, A piecewise parabolic method\nfor cosmological hydrodynamics, Comp. Phys. Comm. 89 (1995) 149\u2013168.\n\n\f40\n\n! Please write \\authorrunninghead{<Author Name(s)>} in file !\n\n32. D. Ryu, J. P. Ostriker, H. Kang, R. Cen, A cosmological hydrodynamic code based on the\ntotal variation diminishing scheme, Astrophys. J. 414 (1993) 1.\n33. T. Quinn, N. Katz, J. Stadel, G. Lake, Time stepping N-body simulations; e-archive: astroph/9710043.\n34. W. Kahan, R.-C. Li, Unconventional Schemes for a Class of Ordinary Differential Equations\u2013\nwith Applications to the Korteweg-de Vries Equation, J. Comp. Phys. 134 (2) (1997) 316\u2013331.\n35. R. J. LeVeque, Numerical Methods for Conservative Laws, 2nd Edition, Springer, Verlag, 1992.\n36. M. Minion, A projection method for locally refined grids, J. Comp. Phys. 127 (1996) 158\u2013178.\n37. D. F. Martin, P. Colella, D. Graves, A cell-centered adaptive projection method for the incompressible Navier-Stokes equations in three dimensions, J. Comp. Phys. .\n38. R. T. Fisher, Single and multiple star formation in turbulent molecular cloud cores, Ph.D.\nthesis, University of California, Berkeley (2002).\n39. S. L. W. McMillan, S. J. Aarseth, An O(N log N) integration scheme for collisional stellar\nsystems, Astrophys. J. 414 (1993) 200\u2013212.\n40. F. Miniati, P. Colella, A modified Godunov's scheme for stiff source conservative hydrodynamics, J. Comp. Phys. 224 (2) (2007) 519\u2013538.\n41. F. Miniati, COSMOCR: A numerical code for cosmic ray studies in computational cosmology,\nComp. Phys. Comm. 141 (2001) 17\u201338.\n42. F. Miniati, Glimm-Godunov's method for cosmic-ray-hydrodynamics, J. Comp. Phys. submitted, eprint arXiv:astro-ph/0611499.\n43. Y. B. Zel'dovich, Gravitational iinstability: an approximate theory for large density perturbations, Astr. Astrophys. 5 (1970) 84\u201389.\n44. A. L. Mellot, Comment on \"nonlinear gravitational clustering in cosmology\", Phys. Rev. Lett.\n56 (1986) 1992.\n45. L. Feng, C. Shu, M. Zhang, A Hybrid Cosmological Hydrodynamic/N-Body Code Based on a\nWeighted Essentially Nonoscillatory Scheme, Astrophys. J. 612 (2004) 1\u201313.\n46. S. A. Colgate, R. H. White, The Hydrodynamic Behavior of Supernovae Explosions, Astrophys. J. 143 (1966) 626\u2013+.\n47. C. S. Frenk, S. D. M. White, P. Bode, J. R. Bond, G. L. Bryan, R. Cen, H. M. P. Couchman,\nA. E. Evrard, N. Gnedin, A. Jenkins, A. M. Khokhlov, A. Klypin, J. F. Navarro, M. L.\nNorman, J. P. Ostriker, J. M. Owen, F. R. Pearce, U. L. Pen, M. Steinmetz, P. A. Thomas,\nJ. V. Villumsen, J. W. Wadsley, M. S. Warren, G. Xu, G. Yepes, The santa barbara cluster\ncomparison project: A comparison of cosmological hydrodynamics solutions, Astrophys. J. 525\n(1999) 554.\n48. C. Lacey, S. Cole, Merger rates in hierarchical models of galaxy formation - part two - comparison with n-body simulations, Mon. Not. R. Astron. Soc. 271 (3) (1994) 676.\n49. H. M. P. Couchman, P. A. Thomas, F. R. Pearce, Hydra: an Adaptive-Mesh Implementation\nof P 3M-SPH, Astrophys. J. 452 (1995) 797\u2013+.\n50. J. F. Navarro, C. S. Frenk, S. D. M. White, A universal density profile from hierarchical\nclustering, Astrophys. J. 490 (1997) 493.\n\n\f"}