{"id": "http://arxiv.org/abs/astro-ph/0108475v2", "guidislink": true, "updated": "2001-08-30T18:16:11Z", "updated_parsed": [2001, 8, 30, 18, 16, 11, 3, 242, 0], "published": "2001-08-29T21:21:24Z", "published_parsed": [2001, 8, 29, 21, 21, 24, 2, 241, 0], "title": "An Efficient Monte Carlo Algorithm for a Restricted Class of Scattering\n  Problems in Radiation Transfer", "title_detail": {"type": "text/plain", "language": null, "base": "http://export.arxiv.org/api/query?search_query=&id_list=astro-ph%2F0108417%2Castro-ph%2F0108308%2Castro-ph%2F0108348%2Castro-ph%2F0108057%2Castro-ph%2F0108450%2Castro-ph%2F0108142%2Castro-ph%2F0108475%2Castro-ph%2F0108414%2Castro-ph%2F0108380%2Castro-ph%2F0108089%2Castro-ph%2F0108294%2Castro-ph%2F0108503%2Castro-ph%2F0108357%2Castro-ph%2F0108436%2Castro-ph%2F0108001%2Castro-ph%2F0108070%2Castro-ph%2F0108261%2Castro-ph%2F0108383%2Castro-ph%2F0108402%2Castro-ph%2F0108238%2Castro-ph%2F0108329%2Castro-ph%2F0108036%2Castro-ph%2F0108345%2Castro-ph%2F0108149%2Castro-ph%2F0108022%2Castro-ph%2F0108375%2Castro-ph%2F0108507%2Castro-ph%2F0108466%2Castro-ph%2F0108382%2Castro-ph%2F0108333%2Castro-ph%2F0108246%2Castro-ph%2F0108486%2Castro-ph%2F0108081%2Castro-ph%2F0108469%2Castro-ph%2F0108340%2Castro-ph%2F0108411%2Castro-ph%2F0108245%2Castro-ph%2F0108443%2Castro-ph%2F0108309%2Castro-ph%2F0108495%2Castro-ph%2F0108412%2Castro-ph%2F0108045%2Castro-ph%2F0108505%2Castro-ph%2F0108150%2Castro-ph%2F0211546%2Castro-ph%2F0211633%2Castro-ph%2F0211366%2Castro-ph%2F0211101%2Castro-ph%2F0211464%2Castro-ph%2F0211573%2Castro-ph%2F0211436%2Castro-ph%2F0211091%2Castro-ph%2F0211195%2Castro-ph%2F0211469%2Castro-ph%2F0211479%2Castro-ph%2F0211298%2Castro-ph%2F0211367%2Castro-ph%2F0211035%2Castro-ph%2F0211451%2Castro-ph%2F0211572%2Castro-ph%2F0211526%2Castro-ph%2F0211297%2Castro-ph%2F0211250%2Castro-ph%2F0211030%2Castro-ph%2F0211376%2Castro-ph%2F0211245%2Castro-ph%2F0211478%2Castro-ph%2F0211304%2Castro-ph%2F0211120%2Castro-ph%2F0211296%2Castro-ph%2F0211351%2Castro-ph%2F0211279%2Castro-ph%2F0211115%2Castro-ph%2F0211602%2Castro-ph%2F0211073%2Castro-ph%2F0211052%2Castro-ph%2F0211585%2Castro-ph%2F0211467%2Castro-ph%2F0211019%2Castro-ph%2F0211308%2Castro-ph%2F0211341%2Castro-ph%2F0211528%2Castro-ph%2F0211508%2Castro-ph%2F0211606%2Castro-ph%2F0211445%2Castro-ph%2F0211283%2Castro-ph%2F0211231%2Castro-ph%2F0211223%2Castro-ph%2F0211046%2Castro-ph%2F0211157%2Castro-ph%2F0211105%2Castro-ph%2F0211529%2Castro-ph%2F0211047%2Castro-ph%2F0211289%2Castro-ph%2F0211002%2Castro-ph%2F0211640%2Castro-ph%2F0211044%2Castro-ph%2F0211622%2Castro-ph%2F0211095%2Castro-ph%2F0211153%2Castro-ph%2F0211020&start=0&max_results=1000&sortBy=relevance&sortOrder=descending", "value": "An Efficient Monte Carlo Algorithm for a Restricted Class of Scattering\n  Problems in Radiation Transfer"}, "summary": "We describe an efficient Monte Carlo algorithm for a restricted class of\nscattering problems in radiation transfer. This class includes many\nastrophysically interesting problems, including the scattering of ultraviolet\nand visible light by grains. The algorithm correctly accounts for\nmultiply-scattered light. We describe the algorithm, present a number of\nimportant optimizations, and explicity show how the algorithm can be used to\nestimate quantities such as the emergent and mean intensity. We present two\ntest cases, examine the importance of the optimizations, and show that this\nalgorithm can be usefully applied to optically-thin problems, a regime\nsometimes considered limited to explicit single-scattering plus attenuation\napproximations.", "summary_detail": {"type": "text/plain", "language": null, "base": "http://export.arxiv.org/api/query?search_query=&id_list=astro-ph%2F0108417%2Castro-ph%2F0108308%2Castro-ph%2F0108348%2Castro-ph%2F0108057%2Castro-ph%2F0108450%2Castro-ph%2F0108142%2Castro-ph%2F0108475%2Castro-ph%2F0108414%2Castro-ph%2F0108380%2Castro-ph%2F0108089%2Castro-ph%2F0108294%2Castro-ph%2F0108503%2Castro-ph%2F0108357%2Castro-ph%2F0108436%2Castro-ph%2F0108001%2Castro-ph%2F0108070%2Castro-ph%2F0108261%2Castro-ph%2F0108383%2Castro-ph%2F0108402%2Castro-ph%2F0108238%2Castro-ph%2F0108329%2Castro-ph%2F0108036%2Castro-ph%2F0108345%2Castro-ph%2F0108149%2Castro-ph%2F0108022%2Castro-ph%2F0108375%2Castro-ph%2F0108507%2Castro-ph%2F0108466%2Castro-ph%2F0108382%2Castro-ph%2F0108333%2Castro-ph%2F0108246%2Castro-ph%2F0108486%2Castro-ph%2F0108081%2Castro-ph%2F0108469%2Castro-ph%2F0108340%2Castro-ph%2F0108411%2Castro-ph%2F0108245%2Castro-ph%2F0108443%2Castro-ph%2F0108309%2Castro-ph%2F0108495%2Castro-ph%2F0108412%2Castro-ph%2F0108045%2Castro-ph%2F0108505%2Castro-ph%2F0108150%2Castro-ph%2F0211546%2Castro-ph%2F0211633%2Castro-ph%2F0211366%2Castro-ph%2F0211101%2Castro-ph%2F0211464%2Castro-ph%2F0211573%2Castro-ph%2F0211436%2Castro-ph%2F0211091%2Castro-ph%2F0211195%2Castro-ph%2F0211469%2Castro-ph%2F0211479%2Castro-ph%2F0211298%2Castro-ph%2F0211367%2Castro-ph%2F0211035%2Castro-ph%2F0211451%2Castro-ph%2F0211572%2Castro-ph%2F0211526%2Castro-ph%2F0211297%2Castro-ph%2F0211250%2Castro-ph%2F0211030%2Castro-ph%2F0211376%2Castro-ph%2F0211245%2Castro-ph%2F0211478%2Castro-ph%2F0211304%2Castro-ph%2F0211120%2Castro-ph%2F0211296%2Castro-ph%2F0211351%2Castro-ph%2F0211279%2Castro-ph%2F0211115%2Castro-ph%2F0211602%2Castro-ph%2F0211073%2Castro-ph%2F0211052%2Castro-ph%2F0211585%2Castro-ph%2F0211467%2Castro-ph%2F0211019%2Castro-ph%2F0211308%2Castro-ph%2F0211341%2Castro-ph%2F0211528%2Castro-ph%2F0211508%2Castro-ph%2F0211606%2Castro-ph%2F0211445%2Castro-ph%2F0211283%2Castro-ph%2F0211231%2Castro-ph%2F0211223%2Castro-ph%2F0211046%2Castro-ph%2F0211157%2Castro-ph%2F0211105%2Castro-ph%2F0211529%2Castro-ph%2F0211047%2Castro-ph%2F0211289%2Castro-ph%2F0211002%2Castro-ph%2F0211640%2Castro-ph%2F0211044%2Castro-ph%2F0211622%2Castro-ph%2F0211095%2Castro-ph%2F0211153%2Castro-ph%2F0211020&start=0&max_results=1000&sortBy=relevance&sortOrder=descending", "value": "We describe an efficient Monte Carlo algorithm for a restricted class of\nscattering problems in radiation transfer. This class includes many\nastrophysically interesting problems, including the scattering of ultraviolet\nand visible light by grains. The algorithm correctly accounts for\nmultiply-scattered light. We describe the algorithm, present a number of\nimportant optimizations, and explicity show how the algorithm can be used to\nestimate quantities such as the emergent and mean intensity. We present two\ntest cases, examine the importance of the optimizations, and show that this\nalgorithm can be usefully applied to optically-thin problems, a regime\nsometimes considered limited to explicit single-scattering plus attenuation\napproximations."}, "authors": ["Alan M. Watson", "William J. Henney"], "author_detail": {"name": "William J. Henney"}, "author": "William J. Henney", "arxiv_comment": "Accepted for publication in RMAA; 16 pages; 3 figures", "links": [{"href": "http://arxiv.org/abs/astro-ph/0108475v2", "rel": "alternate", "type": "text/html"}, {"title": "pdf", "href": "http://arxiv.org/pdf/astro-ph/0108475v2", "rel": "related", "type": "application/pdf"}], "arxiv_primary_category": {"term": "astro-ph", "scheme": "http://arxiv.org/schemas/atom"}, "tags": [{"term": "astro-ph", "scheme": "http://arxiv.org/schemas/atom", "label": null}], "pdf_url": "http://arxiv.org/pdf/astro-ph/0108475v2", "affiliation": "None", "arxiv_url": "http://arxiv.org/abs/astro-ph/0108475v2", "journal_reference": null, "doi": null, "fulltext": "Revista Mexicana de Astronom\u0131\u0301a y Astrof\u0131\u0301sica, 00, 1\u201316 (2000)\n\nAN EFFICIENT MONTE CARLO ALGORITHM FOR A\nRESTRICTED CLASS OF SCATTERING PROBLEMS\nIN RADIATION TRANSFER\nAlan M. Watson and William J. Henney\n\narXiv:astro-ph/0108475v2 30 Aug 2001\n\nInstituto de Astronom\u0131\u0301a, Unidad Morelia, Universidad Nacional Aut\u00f3noma de M\u00e9xico\nReceived ; accepted\nRESUMEN\nSe describe un algoritmo eficiente tipo Monte Carlo para solucionar una clase restringida de problemas en\nla transferencia de radiaci\u00f3n. Esta clase incluye varios problemas de inter\u00e9s en la astrof\u0131\u0301sica, incluyendo la\ndispersi\u00f3n de la luz ultravioleta y visible por granos. El algoritmo toma en cuenta la dispersi\u00f3n m\u00faltiple. Se\ndescribe el algoritmo, se presentan algunas optimizaciones importantes, y se muestra expl\u0131\u0301citamente c\u00f3mo se\npuede usar el algoritmo para estimar cantidades como la intensidad emergente y promedio. Se presenta dos\npruebas del algoritmo, se examina la importancia de las optimizaciones, y se muestra que el algoritmo se puede\naplicar de manera \u00fatil a los problemas \u00f3pticamente delgados, los cuales son a veces considerados limitados a\naproximaciones expl\u0131\u0301citas de dispersi\u00f3n sencilla m\u00e1s atenuaci\u00f3n.\nABSTRACT\nWe describe an efficient Monte Carlo algorithm for a restricted class of scattering problems in radiation transfer.\nThis class includes many astrophysically interesting problems, including the scattering of ultraviolet and visible\nlight by grains. The algorithm correctly accounts for multiply-scattered light. We describe the algorithm,\npresent a number of important optimizations, and explicity show how the algorithm can be used to estimate\nquantities such as the emergent and mean intensity. We present two test cases, examine the importance of\nthe optimizations, and show that this algorithm can be usefully applied to optically-thin problems, a regime\nsometimes considered limited to explicit single-scattering plus attenuation approximations.\nKey Words: RADIATIVE TRANSFER - SCATTERING - METHODS: NUMERICAL\n\n1. INTRODUCTION\nWe present a Monte Carlo algorithm for the numerical solution of a restricted class of scattering problems\nin radiation transfer. This class consists of problems in which the true emissivity (the emissivity of unscattered\nlight) and the opacity, albedo, and scattering properties are specified a priori and are zero outside a finite\ndomain, but have arbitrary distributions within that finite domain. In particular, no restrictions are placed\non the scattering phase function or on the symmetry of the problem. Examples of problems that satisfy these\nrequirements include those in which the opacity is dominated some combination of grain opacity, electron\nscattering, resonance-line scattering, Rayleigh scattering, or Raman scattering. For example, the transfer of\nultraviolet and visible light in the presence of grains and of Ly\u03b1 photons in the presence of neutral hydrogen\nand grains. For simplicity, in this paper we do not consider time-dependent problems or polarization, however,\nas we discuss in \u00a78, the algorithm can be easily extended to cover these cases.\nWe have developed this algorithm over the last several years, initially independently (Watson 1994; Henney\n1994ab; Henney 1995; Henney & Axon 1995; Burrows et al. 1996; Sahai et al. 1998; and Henney 1998)\nand then collaboratively (Stapelfeldt et al. 1999; Watson et al. 2001). The algorithm currently incorporates\nseveral important features and optimizations, including the use of forced scatterings and forced interactions,\nthe construction of estimators from unbiased samples of scattering events, and a very efficient integrator for\noptical depth.\nMonte Carlo algorithms have been widely used in radiation transfer (see \u00a73). It seems clear to us that\naspects of this algorithm have been independently discovered and appear to be common knowledge among\n1\n\n\f2\n\nWATSON & HENNEY\nTABLE 1\nNOTATION\nSymbol\nr\nri\nn\nni\n\u03bd\n\u03bdi\nw\nwi\n\u03b7(r, \u03bd, n)\n\u03b7i (r, \u03bd, n)\nI(r, \u03bd, n)\nIi (r, \u03bd, n)\nL(r, \u03bd, n)\nLi (r, \u03bd, n)\nl\n\u03c4 (r, \u03bd, n; l)\n\u03c4\u221e (r, \u03bd, n)\n\u03c7(r, \u03bd, n)\n\u03c3(r, \u03bd, n)\n\u03ba(r, \u03bd, n)\na(r, \u03bd, n)\n\u03a3(r; \u03bd \u2032 , n\u2032 ; \u03bd, n)\n\u03a6(r; \u03bd; n\u2032 , n)\n\nDefinition\nPosition.\nPosition of the i-th interaction with matter.\nDirection; |n| \u2261 1.\nDirection after the i-th interaction with matter.\nFrequency.\nFrequency after the i-th interaction with matter.\nStatistical weight.\nStatistical weight after the i-th interaction with matter.\nP\nTotal emissivity; \u221e\ni=0 \u03b7i (r, \u03bd, n).\nPartial emissivity of light scattered i times.\nP\nTotal specific intensity; \u221e\ni=0 Ii (r, \u03bd, n).\nPartial specific intensity of light scattered i times.\nP\u221e\nTotal radiative intensity, defined in \u00a74.4.2; i=0 Li (r, \u03bd, n).\nPartial radiative intensity of light scattered i times.\nLength.\nRl\nOptical depth from r to r + ln; 0 dl\u2032 \u03c7(r + l\u2032 n, \u03bd, n).\nOptical depth from r to infinity; liml\u2192\u221e \u03c4 (r, \u03bd, n; l).\nLinear extinction coefficient; \u03ba + \u03c3\nLinear scattering coefficient.\nLinear absorption coefficient.\nSingle-scattering albedo; \u03c3/\u03c7.\nScattering outcome function, defined by equation 1.\nScattering phase function, normalized according to equation 3.\n\nUnits\ncm\ncm\n\nHz\nHz\n\nerg s\u22121 cm\u22123 sr\u22121 Hz\u22121\nerg s\u22121 cm\u22123 sr\u22121 Hz\u22121\nerg s\u22121 cm\u22122 sr\u22121 Hz\u22121\nerg s\u22121 cm\u22122 sr\u22121 Hz\u22121\nerg s\u22121 sr\u22121 Hz\u22121\nerg s\u22121 sr\u22121 Hz\u22121\ncm\n\ncm\u22121\ncm\u22121\ncm\u22121\nsr\u22121 Hz\u22121\nsr\u22121\n\nthose working in this field. The principal contribution of this paper is to formalize and publish the algorithm,\nso that it can be better understood and so that future researchers can avoid the wasted effort of independent\nrediscovery.\nIn \u00a72 we present the restricted problem along with a formal (but computationally intractable) solution. In\n\u00a73 we briefly discuss previous approaches to this problem. In \u00a74 we present the algorithm and a number of\noptimizations and variations. In \u00a75 we discuss important details of our implementations. In \u00a76 we present two\ntest cases. In \u00a77 we quantify the efficiency gains due to two important optimizations. In \u00a78 we briefly outline\nhow the algorithm might be extended to include time dependence and polarization. In \u00a79 we summarize our\nmain results.\n2. THE RESTRICTED PROBLEM\nThe restricted problem requires that \u03b70 (r, \u03bd, n), \u03c7(r, \u03bd, n), a(r, \u03bd, n), and \u03a3(r; \u03bd \u2032 , n\u2032 ; \u03bd, n) be specified a\npriori. Table 1 defines our notation, which closely follows that of Mihalas (1978), except for the scattering\nphase function: we use \u03a6 instead of g for the phase function, to avoid confusion with the asymmetry parameter\nof the Henyey-Greenstein phase function, and we normalize the phase function according to equation 3, so the\nphase function has units of sr\u22121 and an isotropic phase function has a value of 1/4\u03c0 sr\u22121 everywhere. Note that\nthe emissivities and specific intensities are per unit solid angle and the extinction, scattering, and absorption\ncoefficients are per unit length. We denote by xi the quantity x when only light scattered i times is considered.\nFor example, \u03b70 is the emissivity of unscattered light, that is, the true emissivity, and \u03b71 is the emissivity\n\n\fMONTE CARLO RADIATION TRANSFER\n\n3\n\nof singly-scattered light. For convenience, we also introduce the single-scattering albedo a and the scattering\noutcome function \u03a3. The albedo a has its conventional definition as the probability that an interaction with\nmatter results in a scattering rather than an absorption. The scattering outcome function \u03a3 is defined by\n\u03b7(r, \u03bd, n) = \u03b70 (r, \u03bd, n) +\n\nZ\n\n0\n\n\u221e\n\nZ\nd\u03bd \u2032 d\u03a9\u2032 \u03c3(r, \u03bd \u2032 , n\u2032 )\u03a3(r; \u03bd \u2032 , n\u2032 ; \u03bd, n)I(r, \u03bd \u2032 , n\u2032 )\n\n(1)\n\n4\u03c0\n\nThat is, \u03a3(r; \u03bd \u2032 , n\u2032 ; \u03bd, n) is the contribution to the emissivity \u03b7(r, \u03bd, n) when intensity I(r, \u03bd \u2032 , n\u2032 ) is scattered. We\nexplicitly separate \u03c3 and \u03a3 to distinguish the probability distribution of scattering events from the probability\ndistribution of the outcomes of those events given that they have occurred.\nScattering does not necessarily conserve energy, but it conserves photons. Considering the specific intensity\nas being carried by photons of energy h\u03bd, we can identify \u03a3(r; \u03bd \u2032 , n\u2032 ; \u03bd, n)(\u03bd \u2032 /\u03bd) as the joint probability distribution that upon scattering a photon with frequency \u03bd \u2032 and direction n\u2032 becomes a photon with frequency \u03bd\nand direction n. Thus, integrating over all initial or final states, we have\nZ\n\n0\n\n\u221e\n\nd\u03bd\n\nZ\n\n\u2032\n\n\u2032\n\n\u2032\n\n\u2032\n\n\u2032\n\nd\u03a9 \u03a3(r; \u03bd , n ; \u03bd, n)(\u03bd /\u03bd) =\n4\u03c0\n\nZ\n\n\u221e\n\n0\n\nZ\nd\u03bd d\u03a9 \u03a3(r; \u03bd \u2032 , n\u2032 ; \u03bd, n)(\u03bd \u2032 /\u03bd) \u2261 1,\n\n(2)\n\n4\u03c0\n\nfor any \u03bd and n or n\u2032 and n\u2032 . As an example of \u03a3, consider coherent scattering (\u03bd \u2032 = \u03bd) with a phase function\n\u03a6(r; \u03bd; n\u2032 , n) normalized as\nZ\n\nZ\n\nd\u03a9 \u03a6(r; \u03bd; n\u2032 , n) \u2261 1;\n\n(3)\n\n\u03a3(r; \u03bd \u2032 , n\u2032 ; \u03bd, n)(\u03bd \u2032 /\u03bd) = \u03b4(\u03bd \u2032 \u2212 \u03bd)\u03a6(r; \u03bd; n\u2032 , n).\n\n(4)\n\n\u2032\n\n\u2032\n\nd\u03a9 \u03a6(r; \u03bd; n , n) =\n\n4\u03c0\n\n4\u03c0\n\nwe then have\n\nThe standard formal solution of the equation of radiation transfer gives the intensity Ii (r, \u03bd, n) of photons\nthat have undergone i scatterings as\nIi (r, \u03bd, n) =\n\nZ\n\n0\n\ndl \u03b7i (r + ln, \u03bd, n)e\u2212\u03c4 (r,\u03bd,n;l),\n\n(5)\n\nl=\u2212\u221e\n\nwhere\n\u03c4 (r, \u03bd, n; l) =\n\nZ\n\nl\n\ndl\u2032 \u03c7(r + l\u2032 n, \u03bd, n).\n\n(6)\n\n0\n\nTo evaluate the first integral, we need the emissivities \u03b7i (r, \u03bd, n). The true emissivity \u03b70 (r, \u03bd, n) of unscattered\nlight is specified a priori. The emissivity \u03b7i (r, \u03bd, n) of light that has undergone i scatterings (where i > 0) is\ngiven by\n\u03b7i (r, \u03bd, n) =\n\nZ\n\n0\n\n\u221e\n\nZ\nd\u03bd \u2032 d\u03a9\u2032 \u03c3(r, \u03bd \u2032 , n\u2032 )\u03a3(r; \u03bd \u2032 , n\u2032 ; \u03bd, n)Ii\u22121 (r, \u03bd \u2032 , n\u2032 ).\n\n(7)\n\n4\u03c0\n\nIn general, equations 5 and 7 form an infinite sequence of coupled integral equations. Approximate solutions\ncan be obtained by directly evaluating a few terms and ignoring the rest. The single-scattering-plus-attenuation\napproximation consists of directly evaluating I1 , the intensity of single-scattered light, and ignoring multiplyscattered light (I2 , I3 , etc.); this is often adequate for optically-thin problems. However, in optically-thick\nproblems, multiply-scattered light can be important, yet direct calculation of the intensity Ii for a single set of\nvalues of r, \u03bd, and n requires the evaluation of a 3i + 1 dimensional integral, and rapidly becomes intractable;\nthe Monte Carlo algorithm addresses this intractability.\n\n\f4\n\nWATSON & HENNEY\n3. PREVIOUS WORK\n\nThe restricted scattering problem described in the preceding section has been tackled many times using\nsemi-analytic and Monte Carlo methods.\nSemi-analytic methods include the discrete-ordinate method (Chandrasekhar 1960; Flannery, Roberge, &\nRybicki 1980; Stamnes et al. 1988) and \"doubling\" and \"adding\" methods (van de Hulst 1963; Hansen & Travis\n1974; de Haan, Bosma, & Hovenier 1987). They are well-suited to problems with plane-parallel or spherical\ngeometries, but are very difficult to extend to arbitrary geometries. Additionally, these methods become less\nefficient when the scattering phase function is sharply peaked (Escalante 1994), as appears to be the case for\ninterstellar grains in the visible and ultraviolet.\nMonte Carlo methods, in which photon trajectories are simulated probabilistically, offer more flexibility.\nWitt (1977), Hillier (1991), Whitney (1991), Fischer, Henning, & Yorke (1994), Watson (1994), Code & Whitney\n(1995), Henney & Axon (1995), and Bjorkman (1997) have presented descriptions of various Monte Carlo\nmethods, and Cashwell & Everett (1959) have described general techniques that can greatly increase the\nefficiency of Monte Carlo methods. Monte Carlo methods have been applied to astrophysical problems many\ntimes over the last several decades; the earliest application we can find is an investigation of the transfer\nof resonance-line radiation in plane-parallel slabs by Avery & House (1968). Faster computers have allowed\nincreasingly complicated geometries to be explored in recent years.\n4. THE ALGORITHM\nThe algorithm consists of two logically separate parts. Part I follows the course of many pseudo-photons\nas they scatter through the system, producing a sample of \"interaction events\". These interactions events\nare characterized by the quantities ri , \u03bdi , and ni (the location of the i-th interaction with matter and the\nfrequency and direction after the i-th interaction with matter) and by a statistical weight w. We first present a\nnaive algorithm for Part I that straightforwardly simulates the underlying physical processes, and then present\nseveral variations and optimizations, which trade computational efficiency for conceptual complexity. Part II\nmakes Monte Carlo estimates of derived quantities, such as the emergent and mean intensities. It is based on\nthe observation that the weighted values of the interaction events generated in Part I form unbiased samples\nof the photon emissivities \u03b7i /h\u03bd and the combinations Ii \u03c7/h\u03bd. This algorithm extends those we have seen\npublished in its use of forced scatterings, forced interactions, and, in particular, its approach to estimating the\nemergent intensity (\"forced escapes\").\n4.1. Normalization\nWe begin by considering the normalization of the problem. The general radiation transfer problem is nonlinear, as it includes coupling of radiation and matter. However, the restricted problem is linear, and we can\nimpose a convenient normalization on \u03b70 and all derived quantities. Again, considering emissivity in terms of\nphotons of energy h\u03bd, we can identify \u03b70 (r, \u03bd, n)/h\u03bd as being proportional to the joint probability distribution\nthat a photon is emitted from position r with frequency \u03bd and direction n. We can thus impose a normalization\nsuch that\nZ \u221e Z\nZ\ndV d\u03bd d\u03a9 \u03b70 (r, \u03bd, n)/h\u03bd \u2261 1,\n(8)\n\u221e\n\n0\n\n4\u03c0\n\nso that \u03b70 (r, \u03bd, n)/h\u03bd is identically the joint probability distribution of photon emission. All derived quantities\nare thus implicitly normalized by the number of emitted photons.\n4.2. Part I: Generating The Sample of Interaction Events (Naive Algorithm)\nThe sample of interaction events is constructed by simulating the emission and transfer of an adequately\nlarge number of pseudo-photons; the values of w, ri , \u03bdi , and ni for each pseudo-photon form the sample. The\nalgorithm is followed for each pseudo-photon until the pseudo-photon escapes or is absorbed. We first describe\n\n\fMONTE CARLO RADIATION TRANSFER\n\n5\n\na naive version which is a direct analog of the transfer of a real photon (considered as a particle) through the\nreal system.\n1: Choose the initial position r0 , frequency \u03bd0 , and direction n0 from the joint probability distribution\n\u03b70 (r0 , \u03bd0 , n0 )/h\u03bd0 .\n2: Initialize the weight: w \u2190 1.\n3: Initialize the scattering index: i \u2190 0.\n4: Choose an optical depth \u03c4i from an exponential distribution with a mean of 1.\nIf \u03c4i is greater than the optical depth to infinity \u03c4\u221e (ri , \u03bdi , ni ), then the pseudo-photon escapes: stop.\n5: Otherwise, the pseudo-photon interacts with matter. The interaction occurs after a distance li which is\ngiven by the implicit equation\nZ li\ndl\u2032 \u03c7(ri + l\u2032 ni , \u03bd, ni ) \u2261 \u03c4 (ri , \u03bdi , ni ; li ) = \u03c4i .\n(9)\n0\n\n6: ri+1 \u2190 ri + lni .\n7: Choose a probability ui from a uniform distribution between 0 and 1.\nIf ui > a(ri+1 , \u03bdi , ni ) then the pseudo-photon is absorbed: stop.\n8: Otherwise, the pseudo-photon is scattered. Choose a frequency \u03bdi+1 and direction ni+1 from the joint\nprobability distribution \u03a3(ri+1 ; \u03bdi , ni ; \u03bdi+1 , ni+1 )(\u03bdi /\u03bdi+1 ).\n9: Increment the scattering index: i \u2190 i + 1.\n10: Continue from step 4.\n4.3. Part I: Generating The Sample of Interaction Events (Variations and Optimizations)\nWe now present two variations and two optimizations. The two variations can simplify the algorithm, easing\nits implementation, at a cost of increasing the variance of the results. The two optimizations can drastically\nreduce the variance in the results at the cost of a small increase in complexity. (This is demonstrated and\ndiscussed in \u00a77). The principal conceptual change in these variations and optimizations is that the statistical\nweight w of the pseudo-photon ceases to be constant. The basis of the variations is weight balancing. An event\nE which should be selected from a probability distribution p(E) can be selected from a different probability\ndistribution p\u2032 (E) provided p\u2032 (E) is non-zero whenever p(E) is non-zero and the statistical weight of the event\nis multiplied by a factor p(E)/p\u2032 (E). This technique is useful as it allows an unwieldy probability distribution\nto be replaced by a more straightforward one. The basis of the optimizations is weight splitting. An event E\nwith statistical weight w can be replaced by two or more events\nP Ej with statistical weights wj = wp(Ej |E)\nprovided that the Ej fully cover the possible outcomes, that is\np(Ej |E) = 1. This technique can be used to\nreduce the variance in the sample of events.\n4.3.1. Variation: Choosing r0 , \u03bd0 , and n0\nIn step 1 the initial values of r0 , \u03bd0 , and n0 are selected from a probability distribution that can be quite\nunwieldy. As an alternative, the values can be selected from different (more easily manageable) distributions\nand then the pseudo-photon can be weighted appropriately. For example, step 1 can be replaced by:\n1\u2032 : Choose an initial position r0 from a uniform distribution whose domain includes all positions r for which\n\u03b70 (r, \u03bd, n) is non-zero for some frequency \u03bd and direction n.\nChoose an initial frequency \u03bd0 from a uniform distribution whose domain includes all frequencies \u03bd for\nwhich \u03b70 (r, \u03bd, n) is non-zero for some position r and direction n.\n\n\f6\n\nWATSON & HENNEY\nChoose an initial direction n0 from a uniform distribution whose domain includes all directions n for\nwhich \u03b70 (r, \u03bd, n) is non-zero for some position r and frequency \u03bd.\nInitialize the statistical weight: w \u2190 \u03b70 (r0 , \u03bd0 , n0 )/h\u03bd0 .\n\nObviously, variations on this are possible if, for example, some variables can be selected easily from a distribution but others cannot. All that is required is that the product of the joint probability density for selection\nand the initial statistical weight w be equal to the true joint probability density for emission \u03b70 (r0 , \u03bd0 , n0 )/h\u03bd0 .\n4.3.2. Variation: Choosing \u03bdi+1 and ni+1\nAgain, in step 8 the values of \u03bdi+1 and ni+1 are selected from a probability distribution that can be quite\nunwieldy. As an alternative, the values can be selected from different (more easily manageable) distributionsq\nand then the pseudo-photon can be weighted appropriately. For example, step 8 can be replaced by:\n8\u2032 : Choose a frequency \u03bdi+1 from a uniform distribution whose domain includes all frequencies \u03bd for which\n\u03a3(ri+1 ; \u03bdi , ni ; \u03bd, n) is non-zero for some direction n.\nChoose a direction ni+1 from a uniform distribution whose domain includes all directions n for which\n\u03a3(ri+1 ; \u03bdi , ni ; \u03bd, n) is non-zero for some frequency \u03bd.\nAdjust the statistical weight: w \u2190 w\u03a3(ri+1 ; \u03bdi , ni ; \u03bdi+1 , ni+1 )(\u03bdi /\u03bdi+1 ).\nAgain, other variations are possible, provided once more that the product of the joint probability density\nfor selection and the factor modifying the statistical weight w is equal to the true joint probability distribution\nfor scattering \u03a3(ri+1 ; \u03bdi , ni ; \u03bdi+1 , ni+1 )(\u03bdi /\u03bdi+1 ).\n4.3.3. Optimization: Forced Scatterings\nIf forced scatterings are required, step 7 is replaced by the following if i is less than some tuneable parameter:\n7\u2032 : Split the pseudo-photon into one pseudo-photon that scatters and another that is absorbed. Each pseudophoton has the same set of values of rj , \u03bdj , and nj for j \u2264 i and the same ri+1 .\nFor the pseudo-photon that is absorbed: set the statistical weight to w \u2190 (1 \u2212 a(ri+1 , \u03bdi , ni ))w and stop.\nFor the pseudo-photon that is scattered: set the statistical weight to w \u2190 a(ri+1 , \u03bdi , ni )w and continue.\n\nThe effect of this optimization is that the ramifications of both scattering and absorption are fully explored;\nthe pseudo-photon makes appropriately weighted contributions to both the absorbed and scattered events.\nThis is particularly important when the albedo is low (see \u00a77).\n4.3.4. Optimization: Forced Interactions\nIf forced interactions are desired, step 4 of the algorithm is replaced by the following if i is less than a\ntuneable parameter:\n4\u2032 : Define the escape probability of the photon along its current trajectory as \u03b2i \u2261 e\u2212\u03c4\u221e (ri ,\u03bdi ,ni ) .\n\nChoose a deviate \u03c4i from an exponential distribution truncated at \u03c4\u221e (ri , \u03bdi , ni ) (that is, p(\u03c4i ) = e\u2212\u03c4i /(1\u2212\n\u03b2i ) for 0 < \u03c4i \u2264 \u03c4\u221e (ri , \u03bdi , ni ) and p(\u03c4i ) = 0 otherwise).\nSplit the pseudo-photon into one pseudo-photon that escapes and another that interacts with matter.\nEach pseudo-photon has the same set of values of rj , \u03bdj , and nj for j \u2264 i.\nFor the pseudo-photon that escapes: set the statistical weight to w \u2190 \u03b2i w and stop.\n\nFor the pseudo-photon that interacts: set the statistical weight to w \u2190 (1 \u2212 \u03b2i )w and continue.\nThe effect of this optimization is that the ramifications of both escapes and further interactions are fully\nexplored; the pseudo-photon makes appropriately weighted contributions to both the escaping and interacting\nevents. This is particularly important when the system is optically thin (see \u00a77).\n\n\fMONTE CARLO RADIATION TRANSFER\n\n7\n\n4.4. Part II: Estimates of Derived Quantities\nThe sample of interaction events can be used to estimate physically interesting quantities, such as the\nemergent and mean intensity. It is clear from the similarity between the algorithm for Part I and the underlying\nphysical process that (a) the weighted values of ri , \u03bdi , and ni are drawn from the joint probability distributions\nof a photon being emitted or scattered at position ri with frequency \u03bdi into direction ni after i scatters and\n(b) the weighted values of ri+1 , \u03bdi , and ni are drawn from the joint probability distributions of a photon\nbeing absorbed or scattered at position ri+1 after i previous scatters whilst having frequency \u03bdi and traveling\nin direction ni . These probability distributions are just \u03b7i (r, \u03bd, n)/h\u03bd and Ii (r, \u03bd, n)\u03c7(r, \u03bd, n)/h\u03bd; thus the\nweighted values of ri , \u03bdi , and ni form unbiased samples of \u03b7i (r, \u03bd, n)/h\u03bd and the weighted values of ri+1 , \u03bdi ,\nand ni form unbiased samples of Ii (r, \u03bd, n)\u03c7(r, \u03bd, n)/h\u03bd.\nWe can use standard Monte Carlo techniques on these unbiased samples. If we have a function f (r, \u03bd, n)\ndefined over a volume V , a frequency interval N , and a solid angle \u03a9, then we have\nZ Z Z\nX\n\u22121\n(10)\nwf (\u03bdi , ri , ni ) \u2248 dV d\u03bd d\u03a9 [\u03b7i (r, \u03bd, n)/h\u03bd]f (r, \u03bd, n)\nW\nV\n\n\u2200(ri ,\u03bdi ,ni )\u2208(V,N,\u03a9)\n\nN\n\n\u03a9\n\nand\nW \u22121\n\nZ Z\ndV d\u03bd d\u03a9 [Ii (r, \u03bd, n)\u03c7(r, \u03bd, n)/h\u03bd]f (r, \u03bd, n),\n\nwf (ri+1 , \u03bdi , ni ) \u2248\n\nZ\n\nwf (ri , \u03bdi\u22121 , ni\u22121 ) \u2248\n\nZ\n\nX\n\n\u2200(ri+1 ,\u03bdi ,ni )\u2208(V,N,\u03a9)\n\nV\n\n(11)\n\n\u03a9\n\nN\n\nor equivalently\nW\n\n\u22121\n\nX\n\n\u2200(ri ,\u03bdi\u22121 ,ni\u22121 )\u2208(V,N,\u03a9)\n\nZ\ndV d\u03bd d\u03a9 [Ii\u22121 (r, \u03bd, n)\u03c7(r, \u03bd, n)/h\u03bd]f (r, \u03bd, n).\n\nV\n\nZ\n\nN\n\n(12)\n\n\u03a9\n\nP\nHere, W \u2261\nw is the total statistical weight of all pseudo-photons. The approximations are in the sense\nthat the integrals are the means of the sums and, by the central limit theorem, are their limiting values as\nthe number of pseudo-photons tends to infinity. Thus, the sums can be used to estimate the integrals. As\nexamples, we derive below expressions for the emergent intensity and the mean intensity; other quantities such\nas the heating rate and radiation pressure can be derived similarly.\n4.4.1. Emergent Specific Intensity\nWe define a volume V by the translation of a surface S in a direction n from +\u221e to \u2212\u221e. We define\nI \u0304i (S, \u03bd, n) as the average emergent specific intensity of light scattered i times in direction n from volume V . It\nis given by\nZ\nI \u0304i (S, \u03bd, n) = (S * n)\u22121 dV \u03b7i (r, \u03bd, n)e\u2212\u03c4\u221e (r,\u03bd,n) .\n(13)\nV\n\nFor the scattered emergent intensity, I \u0304i (S, \u03bd, n) with i > 0, we can substitute equation 7 for \u03b7i to give\nZ Z \u221e Z\n\u22121\n \u0304\nIi (S, \u03bd, n) = (S * n)\ndV d\u03bd \u2032 d\u03a9\u2032 Ii\u22121 (r, \u03bd \u2032 , n\u2032 )\u03c3(r, \u03bd \u2032 , n\u2032 )\u03a3(r; \u03bd \u2032 , n\u2032 ; \u03bd, n)e\u2212\u03c4\u221e (r,\u03bd,n)\nV\n\n0\n\n(14)\n\n4\u03c0\n\nWe can now use equation 12 (with N covering all frequencies and \u03a9 covering 4\u03c0 steradians) to estimate\nI \u0304i (S, \u03bd, n) by\nX\nw h\u03bdi\u22121 a(ri , \u03bdi\u22121 , ni\u22121 )\u03a3(ri ; \u03bdi\u22121 , ni\u22121 ; \u03bd, n)e\u2212\u03c4\u221e (ri ,\u03bd,n) ,\n(15)\nI \u0304i (S, \u03bd, n) \u2248 (S * n)\u22121 W \u22121\n\u2200(ri ,\u03bdi ,ni )\u2208(V,N,\u03a9)\n\nwhere, because N and \u03a9 are all-inclusive, the condition on the sum simplifies to \u2200ri \u2208 V .\nIn some Monte Carlo algorithms, the emergent intensity is estimated by binning the photons that escape\nin step 4 of the algorithm in Part I. Our method of estimating the emergent intensity is very different, in that\n\n\f8\n\nWATSON & HENNEY\n\nit is based on the set of interaction events generated in steps 5 to 8. For spherically symmetric problems, the\ntwo approaches are similar in efficiency. However, for other problems our approach is more efficient by a factor\nof roughly 4\u03c0 divided by the size of the bin in solid angle used in the other method; thus, our approach can\neasily be an order of magnitude more efficient for axisymmetric problems and two orders of magnitude more\nefficient for asymmetric problems, provided the viewing direction is fixed. By analogy with forced scatterings\nand forced interactions, we refer to this approach as \"forced escapes\".\nWe must use a different approach for the unscattered emergent intensity I \u03040 , as equation 7 is valid only\nfor i > 0 and neither equation 10 nor equation 11 will give I \u03040 in general. One simple approach is performing\na logically separate Monte Carlo estimation. That is, selecting values of r\u20320 from a uniform distribution that\nincludes all positions for which \u03b70 (r, \u03bd, n) is non-zero for some \u03bd and n and estimating I \u03040 by\n!\nP\n\u2032\n\u2212\u03c4\u221e (r\u20320 ,\u03bd,n)\nr\u20320 \u2208V \u03b70 (r0 , \u03bd, n)e\n\u22121\nP\nI \u03040 (S, \u03bd, n) \u2248 (S * n)\n.\n(16)\n\u03b70 (r\u20320 , \u03bd, n)/h\u03bd\n\nOther Monte Carlo schemes are possible and can take advantage of knowledge of the properties of \u03b70 . The two\nlogically separate Monte Carlo estimations can be combined under certain circumstances.\n4.4.2. Emergent Radiative Intensity\n\nWhen the system is unresolved, for whatever reason, the specific intensity can no longer be measured. In\nthis case, a more useful quantity is the radiative intensity L, which in more familiar terms is the luminosity per\nunit solid angle L \u2261 dL/d\u03a9, where L is the total luminosity of the system. This quantity is defined and used\nmore often in physics than astronomy, although even in physics is it not common. The radiative intensity is\nrelated to the observed\nphysical flux F by L = F d2 , where d is the distance to the source, and to the specific\nR\n \u0304\nwhere the surface S includes the whole system. Like the specific intensity,\nintensity I by L = S IdS = S I(S),\nthe radiative intensity has the convenient property of being independent of distance. We can estimate L using\nthe same equations as for the specific intensity, but letting the volume of integration extend over the whole\nsystem and omitting the division by the area S * n.\n4.4.3. Mean Intensity\nThe mean value J \u0304i (V, N ) of the mean intensity in a volume V and frequency range N of light scattered i\ntimes is\nZ\nZ\n1\n\u2032\n \u0304\nJi (V, N ) =\ndV d\u03bd \u2032 Ji (r\u2032 , \u03bd \u2032 )\n(17)\nVN V\nZ NZ Z\n1\n=\ndV \u2032 d\u03bd \u2032 d\u03a9\u2032 Ii (r\u2032 , \u03bd \u2032 , n\u2032 ).\n(18)\n4\u03c0V N V\nN\n4\u03c0\nWe can use equation 11 to estimate J \u0304i by\nJ \u0304i (V, N ) \u2248\n\n1\n4\u03c0V N\n\nX\n\n\u2200(\u03bdi ,ri+1 )\u2208(N,V )\n\nwh\u03bdi\n.\n\u03c7(ri+1 , \u03bdi , ni )\n\n(19)\n\nNote that while I \u0304i is obtained at a single frequency \u03bd, J \u0304i is obtained in a frequency range N . This method\nof calculating the mean intensity seems to be widely used by other Monte Carlo methods, and this particular\nformulation does not enjoy any advantage of efficiency.\n4.5. Estimation of Uncertainty\nIn addition to calculating the value of a derived quantity from the whole set of pseudo-photons, we can\npartition the set into M equal sub-sets and obtain M independent values. The uncertainty in the value\ncalculated from\n\u221a the whole set can be estimated as the standard deviation of the M values from the M sub-sets\ndivided by M .\n\n\fMONTE CARLO RADIATION TRANSFER\n\n9\n\n5. IMPLEMENTATION\n5.1. Specifying a Problem\nOne of the advantages of Monte Carlo methods is their generality and flexibility. For example, to specify\na problem, our implementations require only five subroutines: to emit a pseudo-photon, to determine the\nextinction coefficient, to determine the albedo, to determine the location of the sentinel surfaces (see below),\nand to scatter a pseudo-photon.\n5.2. Unifying Part I and Part II of the Algorithm\nThe algorithm as described above generates a sample of interaction events in Part I and then derives\nquantities from weighted sums of functions of these interaction events in Part II. Since a simulation can\nrequire many millions of pseudo-photons, a naive implementation would require the storage of many millions\nof interaction events. Our implementations unify Parts I and II, forming the sums as the interaction events are\ngenerated. This complicates the implementations, but relieves them of the need to store the entire sample of\ninteraction events.\n5.3. The Integrator for Optical Depth\nThere are many ways to solve equation 9 for the distance li to the optical depth \u03c4i , but we have found it\nconvenient and efficient to treat it as a differential equation and integrate. That is, we calculate increments\n\u2206l and \u2206\u03c4 to l and \u03c4 and iterate until we satisfy the boundary condition \u03c4 = \u03c4i , in which case we have\nsolved for l = li . We use a fourth-order Runga-Kutta integrator, which in this case reduces to Simpson's\nrule. Our integrator uses step doubling to estimate the fractional and absolute errors and adapts the step\nsize appropriately. If a step fails, it is tried again using a mid-point integrator; this requires no further\nintegrand evaluations and so is cheap; furthermore, it allows the integrator to integrate up to and away from\ndiscontinuities. We have found that this integrator is faster than higher-order Runga-Kutta or Gaussian\nintegrators for the extinction distributions we have encountered. We believe that this is because we typically\nrequire fractional precisions of only 10\u22125 or less. The situation is reversed if much higher precisions are imposed.\nWe integrate in a piece-wise manner, breaking the integration at \"sentinel surfaces\" which correspond to\ndiscontinuities and sharp features such as the equatorial plane of a thin disk. Thus, we are typically integrating\nuntil we satisfy one of two boundary conditions: until either \u03c4 = \u03c4i or l = L, where L is the distance to the\nnext sentinel surface. If the first condition is satisfied, we stop the integration; if the second is satisfied, we\ncalculate the distance to the next sentinel surface and continue. This approach allows the integrator to handle\ndiscontinuities gracefully and ensures that the step size does not become so large that the integrator steps over\nsharp features without noticing them.\nWhen the integrator is close to one of the boundary conditions, it will often over-shoot. If l over-shoots, we\nadjust the step size so that \u2206l = L \u2212 l. If \u03c4 over-shoots, we adjust the step size so that \u2206l = (\u03c4 \u2212 \u03c4i )/\u03c7 where\n\u03c7 is the extinction at the mid-point of the interval. For the initial step we set \u2206l = min(\u03c4, \u03c4ch )/\u03c7 where \u03c7 is\nextinction at the initial point and \u03c4ch is a characteristic optical depth in the problem (often 1); if \u03c7 is zero, we\nchose \u2206l = L \u2212 l.\nWe also use this integrator to determine \u03c4\u221e . We do this simply by replacing the boundary condition on\n\u03c4 with one that l must reach a bounding sphere enclosing the volume in which \u03c7 6= 0. If we are not forcing\ninteractions, we combine steps 4 and 5 of the algorithm into one integration by integrating until either \u03c4 = \u03c4i\nor l reaches the bounding sphere.\n5.4. Parallelism and Estimation of Uncertainty\nMonte Carlo algorithms are embarrassingly parallel and require very little inter-process communication.\nOnce they have started, individual processes only need to communicate at the end of the run to average their\nestimations. This property makes Monte Carlo codes ideal for loosely-coupled clusters of general-purpose com-\n\n\f10\n\nWATSON & HENNEY\n\nputers connected by ordinary networks. We have implemented parallelism using the MPICH implementation\n(Gropp et al. 1996) of the Message Passing Interface (MPI).\nThe only significant problem is generating different sequences of pseudo-random numbers in each process.\nWe use distinct instances of the parallel linear-congruential generators described by L'Ecuyer & Andres (1996).\nEach instance generates distinct sequences with periods of 271 .\nAs described above, partitioning of the set of interaction events provides a simple means to empirically\ngauge the errors in the combined estimations; we have used the natural partition that occurs when running\nin parallel to implement this. Even when using only a single-processor or dual-processor computer we often\nemploy of order 10 parallel processes and thereby obtain an estimate of the error in the final results; the\noverhead is minimal.\n5.5. The Henyey-Greenstein Phase Function\nThe phase function most commonly used for dust scattering problems (when polarization is ignored) is the\nHenyey-Greenstein phase function (Henyey & Greenstein 1941), which is given by\n\u03a6HG (\u03bd; n, n\u2032 ) = (4\u03c0)\u22121 (1 \u2212 g\u03bd2 )(1 + g\u03bd2 \u2212 2g\u03bd \u03bcs )\u22123/2 ,\n\n(20)\n\nwhere \u03bcs = n * n\u2032 is the cosine of the scattering angle \u03b8s and the asymmetry parameter g\u03bd is the mean value of\n\u03bcs . With this choice of scattering function, step 8 of the algorithm is considerably simplified, as \u03bcs and hence\nthe scattering angle \u03b8s can be obtained from\n(\n1 \u2212 2a\nfor g\u03bd = 0\n\u03bcs =\n,\n(21)\n(2g\u03bd )\u22121 (1 + g\u03bd2 \u2212 (1 \u2212 g\u03bd2 )2 (1 + g\u03bd (1 \u2212 2a))\u22122 )\nfor g\u03bd 6= 0\nwhere a is a deviate drawn from a uniform distribution between 0 and 1. The azimuthal scattering angle \u03c6s is\nuniformly distributed between 0 and 2\u03c0.\n6. TEST CASES\nScattering algorithms seem to be tricky to implement correctly, and simple but non-trivial test cases are\ndifficult to find in the literature. For this reason, we present two simple test cases. These test cases are\ninteresting in that they are non-trivial, yet the first few intensities can be obtained by direct numerical integration. The first test case tests the normalization of a point source and the ratio of the unscattered and\nsingly-scattered intensities. The second test case tests the normalization of a pencil beam of light and the\nratios of the unscattered, singly-scattered, and doubly-scattered intensities.\n6.1. Point Source and Slab\nConsider a mono-chromatic, isotropic point source illuminating a plane-parallel slab that is infinite in the\nx and y directions but has a finite optical depth T in the z direction. Scattering is coherent. What is L\u221e ,\nthe radiative intensity seen by an observer at infinity, as a function of \u03b8 = arccos \u03bc, the angle from the +z\ndirection? (We discuss the radiative intensity in \u00a74.4.2.)\nTo fix the geometry, we can take the true emissivity and extinction distribution to be\n\u03b70 (r)\n\n= \u03b4(r)/4\u03c0,\n(\nT\n\u03c7(z) =\n0\n\n(22)\nif 0 < z < 1\n.\notherwise\n\n(23)\n\nThis problem is similar to that considered by Henney (1998) in his \u00a72.1.2, except that here we consider a point\nsource rather than an infinite sheet source (and we also normalize \u03a6 differently). Therefore, the radiative\nintensities for this test case will simply be his specific intensities multiplied by a factor of |\u03bc| and normalized;\nthis is a general technique for transforming between finite unresolved and infinite resolved sources. Thus,\n\n\fMONTE CARLO RADIATION TRANSFER\n\n11\n\nL\u221e,0 and L\u221e,1 , the unscattered and singly-scattered emergent radiative intensities seen from infinity, are given\nanalytically by\nL\u221e,0 (\u03bc)\n\n=\n\nL\u221e,1 (\u03bc)\n\n=\n\nA(\u03bc)\n,\n4\u03c0\nZ\nZ\n\u2032\n\u2032\na\u03bcA(\u03bc) 1 \u2032 2\u03c0\n1 \u2212 e\u2212T (\u03bc\u2212\u03bc )/\u03bc\u03bc\nd\u03bc\nd\u03c6 \u03a6(\u03bcs (\u03bc, \u03bc\u2032 , \u03c6))\n4\u03c0\n\u03bc \u2212 \u03bc\u2032\n0\n0\n\n(24)\n(25)\n\nwhere\nA(\u03bc)\n\u03bcs (\u03bc, \u03bc\u2032, \u03c6)\n\n=\n\n(\n\ne\u2212T /\u03bc\n1\n\nif \u03bc \u2265 0\n,\nif \u03bc < 0\n\n= \u03bc\u03bc\u2032 + (1 \u2212 \u03bc2 )1/2 (1 \u2212 \u03bc\u20322 )1/2 cos \u03c6.\n\n(26)\n(27)\n\nSpatially unresolved quantities seen from infinity are independent of the precise form of the extinction\ncoefficient distribution within the slab, provided we conserve the plane-parallel symmetry and the optical\ndepth through the slab. Therefore, when solving this problem analytically, we can treat the slab as uniform.\nWhen solving it with the Monte Carlo algorithm, we can choose an extinction distribution that provides a more\nsevere test of the integrator, such as\n( \u0002\n\u0003\nT 1/2 + sin2 (2\u03c0z) if 0 < z < 1\n\u03c7(z) =\n.\n(28)\n0\notherwise\nFigure 1 compares the direct and Monte Carlo estimates of the emergent radiative intensities for a slab with\nT = 2, a = 0.5, and a Henyey-Greenstein phase function with g = 0.5. The values of L\u221e,0 and L\u221e,1 calculated\nby the two methods agree to 10\u22124 or better, which is commensurate with our estimates of the precisions of the\ntwo calculations. Selected values of L\u221e,0 , L\u221e,1 , L\u221e,2 , and L\u221e,>2 are given in Table 2.\n6.2. Pencil Beam and Slab\nFor our second test case, we use the same slab but replace the point source with a pencil beam along the\n+z axis. We can take the true emissivity to be\n\u03b70 (r, \u03bc) = \u03b4(r)\u03b4(\u03bc).\n\n(29)\n\nEquations 5 and 7 can be used to show that L\u221e,0 , L\u221e,1 , and L\u221e,2 , the unscattered, singly-scattered, and\ndoubly-scattered emergent radiative intensities seen from infinity, are given analytically by\nL\u221e,0 (\u03bc) =\nL\u221e,1 (\u03bc) =\nL\u221e,2 (\u03bc) =\n\ne\u2212T B(\u03bc)\n\n(30)\n\n\u0011\n|\u03bc| \u0010\n1 \u2212 e\u2212T (1\u2212\u03bc)/|\u03bc| ,\naC(\u03bc)\u03a6(\u03bc)\n1\u2212\u03bc\nZ T Z +1 Z 2\u03c0\n\u2032\n\u2032\n\u2032\n\u2032\n\u2032\n1 \u2212 e\u2212\u03c4 (\u03c4,\u03bc )(1\u2212\u03bc )/|\u03bc |\na2 d\u03c4\nd\u03bc\u2032\nd\u03c6 \u03a6(\u03bcs (\u03bc, \u03bc\u2032, \u03c6)) \u03a6(\u03bc\u2032 ) e\u2212\u03c4 e\u2212\u03c4 (\u03c4,\u2212\u03bc)/|\u03bc|\n,\n1 \u2212 \u03bc\u2032\n0\n\u22121\n0\n\n(31)\n(32)\n\nwhere\nB(\u03bc)\nC(\u03bc)\n\u2032\n\n\u03c4 (\u03c4, \u03bc)\n\n=\n\n(\n\n1\n0\n\n(33)\n\n=\n\n(\n\nif \u03bc = 1\n,\nif \u03bc =\n6 1\n\ne\u2212T\n1\n\nif \u03bc \u2265 0\n,\nif \u03bc < 0\n\n(34)\n\n=\n\n(\n\n\u03c4\nT \u2212\u03c4\n\nif \u03bc \u2265 0\n.\nif \u03bc < 0\n\n(35)\n\n\f12\n\nWATSON & HENNEY\n\nFig. 1. Results for the point source and slab test case described in \u00a76.1. The figure shows the emergent radiative\nintensity L\u221e (\u03b8). The lines are calculated directly, with the solid line showing unscattered light L\u221e,0 and the dashed\nline showing singly-scattered light L\u221e,2 . The symbols are calculated using the Monte Carlo algorithm, with circles \u25e6\nshowing the radiative intensity of unscattered light L\u221e,0 , squares \u2737 showing the radiative intensity of singly-scattered\nlight L\u221e,1 , triangles \u25b3 showing the radiative intensity of double-scattered\nlight L\u221e,2 , and diamonds \u22c4 showing the\nP\u221e\nradiative intensity of more-than-doubly-scattered light L\u221e,>2 \u2261 i=3 L\u221e,i .\n\nTABLE 2\nRESULTS FOR THE POINT SOURCE AND SLAB TEST CASE\n\u03b8\n0\n10\n20\n30\n40\n50\n60\n70\n80\n90\n100\n110\n120\n130\n140\n150\n160\n170\n180\n\nL0 (\u03b8)\n1.08 \u00d7 10\u22122\n1.04 \u00d7 10\u22122\n9.47 \u00d7 10\u22123\n7.90 \u00d7 10\u22123\n5.85 \u00d7 10\u22123\n3.54 \u00d7 10\u22123\n1.46 \u00d7 10\u22123\n2.30 \u00d7 10\u22124\n7.92 \u00d7 10\u22127\n7.96 \u00d7 10\u22122\n7.96 \u00d7 10\u22122\n7.96 \u00d7 10\u22122\n7.96 \u00d7 10\u22122\n7.96 \u00d7 10\u22122\n7.96 \u00d7 10\u22122\n7.96 \u00d7 10\u22122\n7.96 \u00d7 10\u22122\n7.96 \u00d7 10\u22122\n7.96 \u00d7 10\u22122\n\nL1 (\u03b8)\n8.12 \u00d7 10\u22123\n7.93 \u00d7 10\u22123\n7.37 \u00d7 10\u22123\n6.43 \u00d7 10\u22123\n5.14 \u00d7 10\u22123\n3.60 \u00d7 10\u22123\n2.04 \u00d7 10\u22123\n8.17 \u00d7 10\u22124\n2.12 \u00d7 10\u22124\n0\n6.49 \u00d7 10\u22123\n7.30 \u00d7 10\u22123\n6.97 \u00d7 10\u22123\n6.40 \u00d7 10\u22123\n5.87 \u00d7 10\u22123\n5.46 \u00d7 10\u22123\n5.17 \u00d7 10\u22123\n5.00 \u00d7 10\u22123\n4.94 \u00d7 10\u22123\n\nL2 (\u03b8)\n3.80 \u00d7 10\u22123\n3.73 \u00d7 10\u22123\n3.53 \u00d7 10\u22123\n3.19 \u00d7 10\u22123\n2.70 \u00d7 10\u22123\n2.07 \u00d7 10\u22123\n1.37 \u00d7 10\u22123\n7.07 \u00d7 10\u22124\n2.38 \u00d7 10\u22124\n0\n1.30 \u00d7 10\u22123\n2.00 \u00d7 10\u22123\n2.29 \u00d7 10\u22123\n2.36 \u00d7 10\u22123\n2.34 \u00d7 10\u22123\n2.29 \u00d7 10\u22123\n2.23 \u00d7 10\u22123\n2.20 \u00d7 10\u22123\n2.18 \u00d7 10\u22123\n\nL>2 (\u03b8)\n2.31 \u00d7 10\u22123\n2.29 \u00d7 10\u22123\n2.20 \u00d7 10\u22123\n2.06 \u00d7 10\u22123\n1.84 \u00d7 10\u22123\n1.53 \u00d7 10\u22123\n1.14 \u00d7 10\u22123\n6.88 \u00d7 10\u22124\n2.77 \u00d7 10\u22124\n0\n4.89 \u00d7 10\u22124\n9.47 \u00d7 10\u22124\n1.26 \u00d7 10\u22123\n1.44 \u00d7 10\u22123\n1.53 \u00d7 10\u22123\n1.57 \u00d7 10\u22123\n1.59 \u00d7 10\u22123\n1.59 \u00d7 10\u22123\n1.59 \u00d7 10\u22123\n\n\fMONTE CARLO RADIATION TRANSFER\n\n13\n\nFig. 2. Results for the pencil beam and slab case described in \u00a76.2. The figure shows the emergent radiative intensity\nL\u221e (\u03b8). The lines are calculated directly, with the dashed line showing singly-scattered light L\u221e,1 and the dotted\nline showing doubly-scattered light L\u221e,2 . The symbols are calculated using the Monte Carlo algorithm, with circles \u25e6\nshowing the radiative intensity of unscattered light L\u221e,1 , squares \u2737 showing the radiative intensity of singly-scattered\nlight L\u221e,2 , triangles \u25b3 showing the radiative intensity of doubly-scattered\nlight L\u221e,2 , and diamonds \u22c4 showing the\nP\u221e\nradiative intensity of more-than-doubly-scattered light L\u221e,>2 \u2261 i=3 L\u221e,i .\n\nTABLE 3\nRESULTS FOR THE PENCIL BEAM AND SLAB TEST CASE\n\u03b8\n0\n10\n20\n30\n40\n50\n60\n70\n80\n90\n100\n110\n120\n130\n140\n150\n160\n170\n180\n\nL0 (\u03b8)\n1.35 \u00d7 10\u22121\n0\n0\n0\n0\n0\n0\n0\n0\n0\n0\n0\n0\n0\n0\n0\n0\n0\n0\n\nL1 (\u03b8)\n6.46 \u00d7 10\u22122\n5.82 \u00d7 10\u22122\n4.39 \u00d7 10\u22122\n2.92 \u00d7 10\u22122\n1.80 \u00d7 10\u22122\n1.03 \u00d7 10\u22122\n5.38 \u00d7 10\u22123\n2.37 \u00d7 10\u22123\n7.60 \u00d7 10\u22124\n0\n2.60 \u00d7 10\u22123\n3.78 \u00d7 10\u22123\n4.29 \u00d7 10\u22123\n4.46 \u00d7 10\u22123\n4.48 \u00d7 10\u22123\n4.44 \u00d7 10\u22123\n4.39 \u00d7 10\u22123\n4.35 \u00d7 10\u22123\n4.34 \u00d7 10\u22123\n\nL2 (\u03b8)\n1.24 \u00d7 10\u22122\n1.20 \u00d7 10\u22122\n1.10 \u00d7 10\u22122\n9.45 \u00d7 10\u22123\n7.63 \u00d7 10\u22123\n5.69 \u00d7 10\u22123\n3.80 \u00d7 10\u22123\n2.11 \u00d7 10\u22123\n7.98 \u00d7 10\u22124\n0\n9.25 \u00d7 10\u22124\n1.81 \u00d7 10\u22123\n2.37 \u00d7 10\u22123\n2.67 \u00d7 10\u22123\n2.82 \u00d7 10\u22123\n2.87 \u00d7 10\u22123\n2.88 \u00d7 10\u22123\n2.88 \u00d7 10\u22123\n2.88 \u00d7 10\u22123\n\nL>2 (\u03b8)\n4.79 \u00d7 10\u22123\n4.74 \u00d7 10\u22123\n4.57 \u00d7 10\u22123\n4.27 \u00d7 10\u22123\n3.84 \u00d7 10\u22123\n3.26 \u00d7 10\u22123\n2.51 \u00d7 10\u22123\n1.61 \u00d7 10\u22123\n7.02 \u00d7 10\u22124\n0\n5.44 \u00d7 10\u22124\n1.22 \u00d7 10\u22123\n1.79 \u00d7 10\u22123\n2.18 \u00d7 10\u22123\n2.41 \u00d7 10\u22123\n2.55 \u00d7 10\u22123\n2.61 \u00d7 10\u22123\n2.64 \u00d7 10\u22123\n2.65 \u00d7 10\u22123\n\n\f14\n\nWATSON & HENNEY\n\nFig. 3. Contour plots of the relative errors in three trials of the slab geometry as functions of the number of forced\nscatterings and forced interactions. Trial (a) has T = 2 and a = 0.5, trial (b) has T = 0.1 and a = 0.5, and trial (c) has\nT = 2.0 and a = 0.1; in all cases g = 0.5 and \u03b8 = 45\u25e6 . Contours are spaced by factors of 2. The hatched regions have\nthe lowest errors.\n\nThese results are again most easily derived using the transformation mentioned in the previous section. Note\nthat as the singly-scattered light can be written in a closed form, the doubly-scattered light is given by a single\n3-dimensional integral.\nFigure 2 compares the direct and Monte Carlo estimates of the emergent radiative intensities for a slab with\nT = 2, a = 0.5, and a Henyey-Greenstein phase function with g = 0.5. The values of L\u221e,1 and L\u221e,2 calculated\nby the two methods agree to 5 \u00d7 10\u22124 or better, which is commensurate with our estimates of the precisions of\nthe two calculations. Selected values of L\u221e,0 , L\u221e,1 , L\u221e,2 , and L\u221e,>2 are given in Table 3.\n7. THE IMPORTANCE OF FORCED SCATTERINGS AND INTERACTIONS\nTo illustrate the importance of forced scatterings (\u00a74.3.3) and forced interactions (\u00a74.3.4), we have examined\nthe relative errors in the emergent intensity in simulations of the slab geometry (\u00a76) as functions of the number\nof forced scatterings and the number of forced interactions. In order to make the comparison fair, we ran\neach calculation for the same amount of processor time. The relative errors were estimated by partitioning the\nsample of pseudo-photons into 48 sub-samples.\nWe ran three trials with different values of T and a. Trial (a) has T = 2.0 and a = 0.5, the same as the\ntest case considered in \u00a76, and is moderately optically-thick, with singly-scattered and doubly-scattered light\ndominating more-than-doubly-scattered light. Trial (b) has T = 0.1 and a = 0.5, and is optically-thin, with\nsingly-scattered light dominating multiply-scattered light. Trial (c) has T = 2.0 and a = 0.1, and is moderately\noptically-thick, but has a low albedo, so singly-scattered light also dominates multiply-scattered light. In all\ncases we kept \u03b8 = 45\u25e6 and g = 0.5.\nFigure 3 shows contour plots of the relative errors for these trials. The best results for trial (a), with T = 2\nand a = 0.5, are obtained in a broad region with at least 4 forced scatters and 3 forced interactions. The best\nresults for trial (b), with T = 0.1 and a = 0.5, were obtained for at least 2 forced interactions and at least 2\nforced scatters. The best results for trial (c), with T = 2.0 and a = 0.1, were obtained for at least 2 forced\ninteractions and at least 3 forced scatters. In all cases, however, the optimal region is roughly L-shaped. That\nis, excessive numbers of either forced scatters or forced interactions have little effect, but excessive numbers of\nboth start to increase the error again.\nThe best errors for trials (a), (b), and (c) are roughly 7, 90, and 30 times smaller than for a naive implementation with no forced scatters or forced interactions Since the relative error in Monte Carlo calculations\ndecreases as the square root of the computational effort, these optimizations represent savings in time of factors\n\n\fMONTE CARLO RADIATION TRANSFER\n\n15\n\nof roughly 50, 8000, and 1000.\nThese results can be understood qualitatively as follows. On average, the effect of forcing scatterings and\ninteractions is to keep the pseudo-photon in the system for longer, which has two effects: (i) the pseudo-photon\nis more likely to contribute to derived quantities that depend on scattered light, which reduces the variance in\nthese quantities, and (ii) the computational cost per pseudo-photons increases, so fewer can be followed, which\nincreases the variance in derived quantities. In the cases examined here, the former is more important to begin\nwith; for moderate numbers of forced scatterings and interactions, making each pseudo-photon more useful\ncompensates for the smaller total number of pseudo-photons, and the variance is reduced. This is especially\nimportant if the system is optically thin (trial b) or if the albedo is low (trial c), as pseudo-photons can easily\nleave the system or be absorbed, and thereby make relatively little contribution to derived quantities.\nHowever, if the number of both forced scatterings and interactions is excessive, each pseudo-photon is forced\nto remain in the system for many scatterings. This may reduced the variance of quantities derived from very\nhighly scattered light, but it reduces the total number of pseudo-photons that can be considered, and thereby\nincreases the variance of derived quantities that are dominated by moderately scattered light. Furthermore, the\noptimal region is L-shaped because, for the optical depths and albedos considered here, both excessive numbers\nof forced scatterings and excessive numbers of forced interactions are required to keep each pseudo-photons in\nthe system for many scatterings; if one or the other is not excessive, the pseudo-photon is absorbed or escapes.\nIt is impossible to give a universally applicable rule to select a priori the optimal number of forced scatterings and interactions, as these quantities depend on the geometry and also on the particular quantity being\ncalculated. However, the discussion in the previous paragraph implies that the optimal values for both will\nprobably be roughly equal. Our experience suggests that two to four forced scatterings and interactions might\nbe a useful rule of thumb; this number is not too far from optimal for any of the cases we have investigated.\nNaive Monte Carlo algorithms are often considered ill-suited to optically-thin problems, as the overwhelming\nmajority of photons escape without interacting. However, is not the case for more sophisticated algorithms\nthat force the first few interactions, as our optically-thin trial demonstrates. A specialized single-scattering\nplus attenuation calculation would probably calculate the emergent singly-scattered intensity more efficiently,\nbut a Monte Carlo calculation may well be more flexible and can directly account for multiply-scattered light.\n8. TIME-DEPENDENCE AND POLARIZATION\nThe algorithm as presented covers the time-independent transfer of unpolarized light. Both of these restrictions can be lifted quite easily.\nThe simplest way of including general time-dependence is to sample the range of times of emission, keep\ntrack of the travel time of the pseudo-photon within the system, and account for the travel time when computing\nquantities of interest. If only the source varies, it is probably more efficient to construct a \"response function\"\nfor each quantity of interest which can be convolved with changes in the brightness of the source to predict the\ntime-variation of that quantity.\nPerhaps the simplest way to include polarization is to generalize the scalar statistical weight w to a vector\nstatistical weight w \u2261 (wI , wQ , wU , wV ), whose components correspond to the four components of the Stokes\nvector. The components will in general not be conserved upon scattering, but will transform according to the\nadopted scattering matrix. See, for example, Hillier (1991) and Whitney (1991).\n9. SUMMARY\nWe have presented and discussed a Monte Carlo algorithm for a restricted class of scattering problems.\nOur main contributions have been to formalize this algorithm, to present two test cases, and to investigate its\nefficiency. Important features of the algorithm are forced escapes, forced scatterings, and forced interactions.\nUsing forced escapes to estimate the emergent intensity can be orders of magnitude more efficient than naively\nbinning escaping pseudo-photons. Also, using a small number (two to four) of forced scatterings and forced\ninteractions can significantly improve the efficiency of the algorithm for many problems, overwhelmingly so for\noptically-thin problems or those where the albedo is small.\nWe are grateful to Karl Stapelfeldt and John Krist for serving as crash-test dummies for several years, to\n\n\f16\n\nWATSON & HENNEY\n\nJon Bjorkman, Kenny Wood, and Barbara Whitney for many useful discussions on Monte Carlo techniques\nand applications, and to an anonymous referee. This work was supported by CONACyT project 27570E.\nREFERENCES\nAvery, L. W. & House, L. L. 1968, ApJ, 152, 493\nBjorkman, J. E. 1997, in Stellar Atmospheres: Theory and Observations (Berlin: Springer), edited by J. P. De Greve,\nR. Blomme, & H. Hensberge\nBurrows, C. J., Stapelfeldt, K. R., Watson, A .M., Krist, J. E., et al. 1996, ApJ, 473, 437\nCashwell, E. D. & Everett, C. J. 1959, Monte Carlo Methods for Random Walk Problems (New York: Pergamon Press)\nChandrasekhar, S. 1960, Radiative Transfer (New York: Dover)\nCode, A. D. & Whitney, B. A. 1995, ApJ, 441, 400\nde Haan, J. F., Bosma, P. B., & Hovenier, J. W. 1987, A&A, 183, 371\nEscalante, V. 1994, RevMexAA, 29, 202\nFischer, O., Henning, Th., & Yorke, H. W. 1994, A&A, 284, 187\nFlannery, B. P., Roberge, W., & Rybicki, G. B. 1980, ApJ, 236, 598\nGropp, W., Lusk, E., Doss, N., & Skjellum, A. 1996, Parallel Computing, 22, 789\nHansen, J. E. & Travis, L. D. 1974, Space Sci. Rev., 16, 527\nHenney, W. J. 1994a, ApJ, 427, 288\nHenney, W. J. 1994b, RevMexAA, 29, 192\nHenney, W. J. 1995, Ap&SS, 224, 481\nHenney, W. J. 1998, ApJ, 503, 760\nHenney, W. J., & Axon, D. J. 1995, ApJ, 454, 233\nHenyey, L. C., & Greenstein, J. L. 1941, ApJ, 93, 70\nHillier, D. J. 1991, A&A, 247, 455\nL'Ecuyer, P., & Andres, T. A. 1997, Mathematics and Computers in Simulation, 44, 99\n(available from http://www.iro.umontreal.ca/~lecuyer/papers.html)\nMihalas, D. 1978, Stellar Atmospheres (2nd ed.; New York, NY: Freeman)\nSahai, R., Trauger, J. T., Watson, A. M., Stapelfeldt, K. R., Hester, J. J., et al. 1998, ApJ, 493, 301\nStamnes, K., Tsay, S.-C., Wiscombe, W., & Jayaweera, K. 1988 App. Optics, 27, 2502\nStapelfeldt, K. R., Watson, A. M., Krist, J. E., Burrows, C. J., et al. 1999, ApJ, 516, L95\nvan de Hulst, H. C. 1963, A New Look at Multiple Scattering, Techn. Rept., Inst. Space Studies (New York: NASA)\nWatson, A. M. 1994, Ph. D. thesis, University of Wisconsin\nWatson, A. M., Stapelfeldt, K. R., Krist, J. E., & Burrows, C. J. 2001, ApJ, submitted\nWhitney, B. A. 1991, ApJS, 75, 1293\nWitt, A. N. 1977, ApJS, 35, 1\n\nAlan M. Watson and William J. Henney: Instituto de Astronom\u0131\u0301a, Unidad Morelia, Universidad Nacional\nAut\u00f3noma de M\u00e9xico, Apartado Postal 72-3 (Xangari), 58089 Morelia, Michoac\u00e1n, M\u00e9xico (a.watson,\nw.henney@astrosmo.unam.mx).\n\n\f"}